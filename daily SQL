/*
无敌家  2106184075   望京小腰（总部）1735889933      
10.1-10.22  各门店每日订单，流水，百度补贴，商户补贴，曝光，转化，复购率数据
*/

SELECT *, X1.每日订单/X2.sum_click_uv AS '转化' FROM 
(SELECT a.order_day_key AS '日期', c.busi_name AS '门店',a.wid
COUNT(if(a.order_status = 9,a.order_id,null)) AS '每日订单', 
SUM(a.real_total_price)/1000 AS '流水', 
SUM(case when a.shop_butie>0 then a.shop_butie/1000 else 0 end)
	+ SUM(case when shop_quan_price>0 then a.shop_quan_price/1000 else 0 end) AS '商户补贴',
SUM(case when a.discount_baidufee_price>0 then a.discount_baidufee_price/1000  else 0 end) 
	+ SUM(case when a.quan_price>0 then a.quan_price/1000 else 0 end) AS '百度补贴', 
FROM fact_order a 
LEFT JOIN dim_business c ON a.shop_id=c.shop_id
WHERE a.break_type=0
AND a.order_day_key BETWEEN 20171001 AND 20171022
AND a.supplier_id IN ('2106184075', '1735889933')
GROUP BY a.order_day_key, c.busi_name, a.wid) X1
LEFT JOIN 
(SELECT b.idx_day,b.wid,SUM(b.click_uv) AS sum_click_uv,SUM(b.view_uv) AS '曝光' 
FROM da_zz_data_shop_rank b)X2 ON X1.日期=X2.idx_day AND X1.wid=X2.wid 
LEFT JOIN
(SELECT  T.wid, 
		 SUM(if(t1>=2 ,
         1,
         0))/COUNT (pass_uid) AS '复购率'
    FROM 
        (SELECT a1.pass_uid, a1.wid, 
         COUNT (a1.order_id) t1
         FROM fact_order a1
		 WHERE	a1.order_day_key
            BETWEEN 20171001 AND 20171022
                AND a1.break_type=0
                AND a1.supplier_id IN ('2106184075', '1735889933')
                AND a1.is_test=0
        GROUP BY  1,2) T GROUP BY 1) X3
ON  X1.wid=X3.wid 

/*
1、以门店维度每个门店销售流水数据。
2.以门店维度每个门店下单数量包括完成订单以及未完成订单
*/


SELECT b.busi_name AS '门店',
	SUM(IF(a.order_status = 9, real_total_price, 0))/1000 AS '流水',
	COUNT(IF(a.order_status = 9, a.order_id, NULL) AS '完成订单'，
	COUNT(a.order_id) - COUNT(IF(a.order_status = 9, a.order_id, NULL) AS '未完成订单'
FROM fact_order a
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.supplier_id = '1921784649'
	AND a.order_day_key BETWEEN 20170801 AND 20170831
	AND a.break_type = 0
	AND b.is_test = 0
	AND b.is_delete = 0
GROUP BY 1

/*
台资味、金百万、焦耳这几个品牌的下单转化率和复购率								
*/

SELECT  A.品牌, 
		A.月份, 
		A.order_amount/B.sum_click_uv AS '下单转化率', 
		C.复购率
FROM
(SELECT  b.ka_brand AS '品牌', 
		FLOOR(a.order_day_key/100) AS '月份', 
		a.wid, 
		COUNT(if(a.order_status = 9,a.order_id,null)) AS order_amount
FROM fact_order a 
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.break_type = 0
	AND a.order_day_key BETWEEN 20170801 AND 20171024
	AND b.is_test = 0
	AND b.is_delete = 0
	AND b.ka_brand IN ('台资味', '金百万', '焦耳')
GROUP BY 1,2)A
LEFT JOIN

(SELECT c.wid,
		SUM(c.click_uv) AS sum_click_uv
FROM da_zz_data_shop_rank c)B ON A.wid = B.wid
LEFT JOIN

(SELECT  T.ka_brand, T.months, 
		 SUM(if(t1>=2 , 1, 0))/COUNT (T.pass_uid) AS '复购率'
    FROM 
        (SELECT a1.pass_uid, b1.ka_brand, FLOOR(a1.order_day_key/100) AS months, 
         COUNT (a1.order_id) t1
         FROM fact_order a1
		 LEFT JOIN dim_business b1 ON a1.shop_id = b1.shop_id
		 WHERE	a1.order_day_key
            BETWEEN 20170801 AND 20171024
                AND a1.break_type = 0
                AND b1.ka_brand IN ('台资味', '金百万', '焦耳')
                AND a1.is_test = 0
				AND a1.is_delete = 0
        GROUP BY  1,2,3) T 
	GROUP BY 1,2)C
ON  A.ka_brand = C.ka_brand AND A.月份 = C.months


/*
2017年8月、9月同湘会、72街、大卡司 TOP10 菜品及每个店铺客单价及惠前与惠后流水及单量等
*/

SELECT  A.品牌名, 
		A.商户ID, 
		A.门店, 
		A.惠前流水,
		A.惠后流水,
		A.门店单量,
		B1.caipin_name AS '畅销菜品',
		C.美团流水,
		C.美团单量
FROM
(SELECT b.ka_brand AS '品牌名', 
		concat('#', a.wid) AS '商户ID',
		b.busi_name AS '门店',
		SUM(IF(a.order_status = 9, a.real_total_price, 0))/1000 AS '惠前流水', 
		SUM(IF(a.order_status = 9, a.price, 0))/1000 AS '惠后流水', 
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '门店单量'
FROM fact_order a 
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.break_type = 0
	AND a.order_day_key BETWEEN 20170801 AND 20170930
	AND b.is_test = 0
	AND b.is_delete = 0
	AND b.ka_brand IN ('同湘会', '72街', '大卡司')
GROUP BY 1,2,3)A
LEFT JOIN 

(select *
from 
(select *,ROW_NUMBER() OVER(PARTITION BY T1.商户ID ORDER BY T1.销量 desc) paixu
from 
(
select
	b2.busi_name as '商户名称',
	concat('#',b2.wid) as '商户ID',
	d.caipin_name ,
	sum(d.number) as '销量'
from 
	dim_business b2 
	left join fact_caipin_details d on b2.shop_id=d.shop_id
where 
	b2.is_test=0 and b2.is_delete=0 
	and d.order_status=9
	and b2.ka_brand IN ('同湘会', '72街', '大卡司')
	and d.order_day_key between 20170801 and 20170930
group by 1,2,3
)T1
)T
where
	T.paixu<=10)B1
ON A.门店 = B1.商户名称


LEFT JOIN 

(SELECT b1.ka_brand,
		b1.busi_name,
		SUM(IF(c.source = 'meituan', 1, 0)*c.liushui_fee)/1000 AS '美团流水',
		SUM(IF(c.source = 'meituan', 1, 0)) AS '美团单量'
FROM dim_business b1 
LEFT JOIN fact_shop_all c ON b1.wid = c.merge_shop_id
WHERE b1.is_delete = 0
	AND b1.is_test = 0
	AND b1.ka_brand IN ('同湘会', '72街', '大卡司')
	AND c.make_date_key IN (20170831, 20170930)
GROUP BY 1,2)C
ON A.门店 = C.busi_name
ORDER BY 1



/*
需求1：8月26日至10月25日单数、优惠前流水、营业额（优惠前流水+折扣佣金）、客单价
需求2：9月26日至10月25日营业时长
需求3：4月26日至10月25日菜品销量数据
*/


SELECT  a.order_day_key AS '日期',
		CONCAT('#', b.wid) AS '商户ID',
		b.busi_name AS '门店',		 
		COUNT(a.order_id) AS '单量',
		SUM(a.real_total_price)/1000 AS '惠前流水',
		SUM(a.real_total_price)/1000 + SUM(a.product_price)/1000-SUM(a.after_discount_price)/1000 AS '营业额', 
		SUM(a.real_total_price/1000)/COUNT(a.order_id) AS '客单价'
FROM fact_order a
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.break_type = 0
	AND a.supplier_id = '14351252732255173199'
	AND a.order_day_key BETWEEN 20170826 AND 20171025
	AND a.order_status = 9
	AND b.is_test = 0
	AND b.is_delete = 0
GROUP BY 1,2,3				--需求1


SELECT 	b.busi_name,
		AVG(CAST(c.bd_actual_business_time AS DOUBLE)/60) AS '营业时长'
		FROM fact_business c 
		LEFT JOIN dim_business b ON c.shop_id = b.shop_id
		WHERE b.is_delete = 0
		AND b.is_test = 0 
		AND c.status=1
		AND c.shop_day_key BETWEEN 20170926 AND 20171025
		AND b.supplier_id = '14351252732255173199'
GROUP BY 1					--需求2


				
SELECT 	b.busi_name AS '门店',
		c.caipin_name AS '菜品名称',
		SUM(c.number) AS '总销量'
	FROM dim_business b 
	LEFT JOIN fact_caipin_details c ON b.shop_id = c.shop_id
	WHERE b.is_delete = 0
		AND b.is_test = 0
		AND c.order_day_key BETWEEN 20170426 AND 20171025
		AND b.supplier_id = '14351252732255173199'
		AND c.order_status = 9
GROUP BY 1,2
ORDER BY 总销量 DESC				--需求3
		

/*
供应商ID：7459241998001922427，烦请协助导出10月1号-10月22号的数据
*/

-- 商户流量+星级评级分析 
SELECT t1..order_day_key AS '日期'
    , CONCAT('#',t1.waimai_release_id) AS '商户ID'
    , t1.busi_name AS '商户名称'
    , t1.sale_name AS '销售姓名'
    , t1.xiadan AS '下单量'
    , t1.wandan AS '完成单'
    , t1.qianliushui AS '优惠前流水'
    , t1.houliushui AS '优惠后流水'
    , t1.kedanjia AS '客单价'
    , t1.new_user AS '新用户数'
    , t1.user_count AS '交易用户数'
    , t1.one_star_count AS '评价1星'
    , t1.two_star_count AS '评价2星'
    , t1.three_star_count AS '评价3星'
    , t1.four_star_count AS '评价4星'
    , t1.fivr_star_count AS '评价5星'
    , t1.content_order_num AS '评论订单数'
    , t1.non_abnormal_rate AS '非异率'
    , t1.接单率

    , t3.访问pv 
    , t3.访问uv
    , t3.曝光pv
    , t3.曝光uv
    , t3.平均rank

FROM 

(SELECT b.waimai_release_id 
    , b.busi_name 
    , c.sale_name 
    , a.order_day_key
    , COUNT(a.order_id) AS xiadan
    , COUNT( CASE WHEN a.order_status = 9 THEN a.order_id END) AS wandan 
    , SUM( CASE WHEN a.order_status = 9 THEN a.real_total_price END)/1000 AS qianliushui 
    , SUM( CASE WHEN a.order_status = 9 THEN a.price ELSE 0 END)/1000 AS houliushui
    , SUM( CASE WHEN a.order_status = 9 THEN a.real_total_price END)/COUNT( CASE WHEN a.order_status = 9 THEN a.order_id END)/1000 AS kedanjia
    , COUNT(CASE WHEN a.order_status = 9 AND a.anticheat_new_user_flag = 1 THEN a.pass_uid ELSE null END) AS new_user 
    , COUNT( DISTINCT CASE WHEN a.order_status = 9 THEN a.pass_uid END) AS user_count 
    , SUM( IF(d.score = 1,1,0)) AS one_star_count
    , SUM( IF(d.score = 2,1,0)) AS two_star_count
    , SUM( IF(d.score = 3,1,0)) AS three_star_count
    , SUM( IF(d.score = 4,1,0)) AS four_star_count
    , SUM( IF(d.score = 5,1,0)) AS fivr_star_count
    , COUNT( CASE WHEN d.content is not null AND a.order_status = 9 THEN a.order_id ELSE null END) AS content_order_num
    , COUNT( CASE WHEN a.cancel_reason_status IN (1,2,3,4,6,7,9,10,11,12,13,14,15,16,18,19,20,21,21,23,102,103,104,110) AND a.order_status = 10 THEN a.order_id ELSE null END)
     /COUNT(a.order_id) AS non_abnormal_rate -- '非异率'
    , COUNT(if(a.jiedan_type<>3,a.order_id,null))/COUNT(a.order_id) AS '接单率'

FROM dim_business AS b 
LEFT JOIN fact_order AS a ON a.shop_id = b.shop_id 
LEFT JOIN dim_order_sale_id AS c ON b.sales_id = c.sale_id 
LEFT JOIN comment_content_new AS d ON a.order_id = d.order_id 
WHERE a.order_day_key BETWEEN 20171001 AND 20171022         -- 修改时间 
    AND from_unixtime(d.create_time+8*3600,'yyyyMMdd') >= '20171001'        -- 时间大于你要查询的最小时间
    AND a.is_test = 0 
    AND a.break_type = 0 
    AND b.is_delete = 0 
    AND b.sys_status IN (0,6,13,14,15) 
    AND b.waimai_release_id IN          -- 修改商户id 
    (
        
)
GROUP BY 1,2,3,4 ) AS t1 


LEFT JOIN 

(SELECT b.waimai_release_id 
    , a.shop_day_key
    , SUM(f.shop_pv) AS '访问pv'
    , SUM(f.shop_uv) AS '访问uv'
    , SUM(f.shop_baoguang_pv) AS '曝光pv'
    , SUM(f.shop_baoguang_uv) AS '曝光uv'
    , AVG(d.shop_avgrank) AS '平均rank'

FROM dim_business AS b
LEFT JOIN fact_business AS f ON b.shop_id = f.shop_id
WHERE f.shop_day_key BETWEEN 20171001 AND 20171022        -- 修改时间
    AND f.waimai_release_id IN              -- 修改商户id 
    (
) 
GROUP BY 1,2) AS t3
ON t1.waimai_release_id = t3.waimai_release_id AND t1.order_day_key = t3.shop_day_key 



-- 档位 
select 
b.supplier_id,
(case when a.real_total_price<20000 then '客单价[0,20)'
    when a.real_total_price<30000 and a.real_total_price>=20000 then '客单价[20,30)'
    when a.real_total_price<40000 and a.real_total_price>=30000 then '客单价[30,40)'
    when a.real_total_price<50000 and a.real_total_price>=40000 then '客单价[40,50)'
    when a.real_total_price<60000 and a.real_total_price>=50000 then '客单价[50,60)'
    when a.real_total_price<70000 and a.real_total_price>=60000 then '客单价[60,70)'
    when a.real_total_price<80000 and a.real_total_price>=70000 then '客单价[70,80)'
    when a.real_total_price<90000 and a.real_total_price>=80000 then '客单价[80,90)'
    when a.real_total_price<100000 and a.real_total_price>=90000 then '客单价[90,100)'
    when a.real_total_price<120000 and a.real_total_price>=100000 then '客单价[100,120)'
    when a.real_total_price<140000 and a.real_total_price>=120000 then '客单价[120,140)'
    when a.real_total_price<160000 and a.real_total_price>=140000 then '客单价[140,160)'
    when a.real_total_price>=1600000 then '客单价[160,∞)' 
      else '0' end) as '客单价区间',				--客单价分布
count(a.order_id) as '优惠前订单数'

from fact_order a
left join dim_business b on a.shop_id = b.shop_id

where 
a.break_type=0
and a.order_status=9
and a.order_day_key between 20171001 AND 20171022        -- 修改时间
and b.supplier_id in()        -- 修改供应商id
group by 1,2



--  热销菜品  月	 品牌名称	菜品名称	菜品销量	菜品销售额	

select concat('#',b.supplier_id) as '供应商ID'
    , b.ka_brand as '品牌'
    , a.caipin_id as '菜品id'
    , a.caipin_name as '菜品名称'
    , a.current_price as '菜品原价'
    , sum(a.number) as '销售数量'
from fact_caipin_details as a
join dim_business as b on a.shop_id=b.shop_id
where a.order_day_key between 20171001 AND 20171022   -- 修改时间
and b.is_test=0
and b.supplier_id IN ('7459241998001922427')  -- 修改供应商id
group by 1,2,3,4,5
order by 销售数量 desc 


/*
活动销量
*/
SELECT t1.日期,
		t1.商户ID,
		t1.商户,
		t2.活动销量,
		t1.总共完成订单量
FROM 
(SELECT a.shop_id,
		a.order_day_key AS '日期',
		CONCAT('#', b.wid) AS '商户ID', 
		b.busi_name AS '商户'
		COUNT(a.order_id) AS '总共完成订单量'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.order_day_key BETWEEN 20171022 AND 20171026			--修改日期	
		AND a.order_status = 9
		AND b.is_delete = 0
		AND b.is_test = 0
GROUP BY 1,2,3,4) t1
JOIN 
(SELECT c.shop_id,
		c.index_day,
		COUNT(DISTINCT c.order_id) AS '活动销量'
FROM fact_yingxiao_info c
LEFT JOIN dim_business b1 ON c.shop_id = b1.shop_id
WHERE c.order_status = 9
	AND c.index_day BETWEEN 20171022 AND 20171026					--修改日期			
	AND c.activity_id = 'cp341054'									--修改活动ID，cp为小写
	AND b1.city_real = '上海'										--修改城市
	AND b1.is_delete = 0
	AND b1.is_test = 0
GROUP BY 1,2) t2 ON t1.shop_id = t2.shop_id AND t1.日期 = t2.index_day
		



/*
10.30宋帅帅
*/

--需求1：9月、10月总数据

SELECT A.*, 
		B.复购率, 
		C.访问uv,
		C.访问pv,
		C.曝光uv,
		C.曝光pv,
		A.完成单量/C.访问uv AS '完成单转化率'
FROM
(SELECT CONCAT('#',a.supplier_id) AS '供应商ID',
		FLOOR(a.order_day_key/100) AS '月份', 
		COUNT(a.order_id) AS '下单量',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '完成单量',
		SUM(IF(a.order_status = 9, a.real_total_price, 0))/1000 AS '流水优惠前',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价',
		SUM(case when a.shop_butie>0 AND a.order_status = 9 then a.shop_butie/1000 else 0 end)
			+ SUM(case when shop_quan_price>0 AND a.order_status = 9 then a.shop_quan_price/1000 else 0 end) AS '商户补贴',
		SUM(case when a.discount_baidufee_price>0  AND a.order_status = 9 then a.discount_baidufee_price/1000  else 0 end) 
			+ SUM(case when a.quan_price>0  AND a.order_status = 9 then a.quan_price/1000 else 0 end) AS '百度补贴', 
		COUNT(DISTINCT a.pass_uid) AS '交易用户数',
		COUNT(IF(a.complaint_status!=0,1,NULL)) AS '投诉单',
		COUNT(CASE WHEN a.cancel_reason_status IN(7,3,1,2,4,9,10,11,12,19,13,14,15,16,18,20,21,22,23,102,103,110,6) AND a.order_status=10 THEN a.order_id ELSE NULL END)/COUNT(a.order_id) AS '非异率'
FROM fact_order a
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.break_type = 0
	AND a.supplier_id = '1428693873'
	AND a.order_day_key BETWEEN 20170901 AND 20171026
	AND b.is_test = 0
	AND b.is_delete = 0
GROUP BY 1,2)A
JOIN
(SELECT  CONCAT('#',T.supplier_id) AS id,
		 FLOOR(T.order_day_key/100) AS months,
		 SUM(if(t1>=2, 1, 0))/COUNT (T.pass_uid) AS '复购率'
    FROM 
        (SELECT a1.pass_uid, a1.supplier_id, a1.order_day_key,  
         COUNT (a1.order_id) t1
         FROM fact_order a1
		 WHERE	a1.order_day_key
            BETWEEN 20170901 AND 20171026
                AND a1.break_type=0
                AND a1.supplier_id = '1428693873'
                AND a1.is_test=0
        GROUP BY  1,2,3) T GROUP BY 1,2) B
ON  A.供应商ID = B.id AND A.月份 = B.months
JOIN
(SELECT CONCAT('#',c.supplier_id ) AS gongyingshangid,
		FLOOR(c.shop_day_key/100) AS yuefen,
		SUM(c.shop_uv) AS '访问uv',
		SUM(c.shop_pv) AS '访问pv',
		SUM(c.shop_baoguang_uv) AS '曝光uv',
		SUM(c.shop_baoguang_pv) AS '曝光pv'
FROM fact_business c
WHERE c.supplier_id = '1428693873'
	AND c.shop_day_key BETWEEN 20170901 AND 20171026
	AND c.status = 1
GROUP BY 1,2)C
ON A.供应商ID = C.gongyingshangid AND A.月份 = C.yuefen


--需求2：9月、10月每日数据

SELECT A.*,
		C.访问uv,
		C.访问pv,
		C.曝光uv,
		C.曝光pv,
		A.完成单量/C.访问uv AS '完成单转化率'
FROM
(SELECT CONCAT('#',a.supplier_id) AS '供应商ID',
		a.order_day_key '日期', 
		COUNT(a.order_id) AS '下单量',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '完成单量',
		SUM(IF(a.order_status = 9, a.real_total_price, 0))/1000 AS '流水优惠前',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价',
		SUM(case when a.shop_butie>0 AND a.order_status = 9 then a.shop_butie/1000 else 0 end)
			+ SUM(case when shop_quan_price>0 AND a.order_status = 9 then a.shop_quan_price/1000 else 0 end) AS '商户补贴',
		SUM(case when a.discount_baidufee_price>0  AND a.order_status = 9 then a.discount_baidufee_price/1000  else 0 end) 
			+ SUM(case when a.quan_price>0  AND a.order_status = 9 then a.quan_price/1000 else 0 end) AS '百度补贴', 
		COUNT(DISTINCT a.pass_uid) AS '交易用户数',
		COUNT(IF(a.complaint_status!=0,1,NULL)) AS '投诉单',
		COUNT(CASE WHEN a.cancel_reason_status IN(7,3,1,2,4,9,10,11,12,19,13,14,15,16,18,20,21,22,23,102,103,110,6) AND a.order_status=10 THEN a.order_id ELSE NULL END)/COUNT(a.order_id) AS '非异率'
FROM fact_order a
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.break_type = 0
	AND a.supplier_id = '1428693873'
	AND a.order_day_key BETWEEN 20170901 AND 20171026
	AND b.is_test = 0
	AND b.is_delete = 0
GROUP BY 1,2)A
JOIN
(SELECT CONCAT('#',b1.supplier_id ) AS gongyingshangid,
		c.shop_day_key AS riqi,
		SUM(c.shop_uv) AS '访问uv',
		SUM(c.shop_pv) AS '访问pv',
		SUM(c.shop_baoguang_uv) AS '曝光uv',
		SUM(c.shop_baoguang_pv) AS '曝光pv'
FROM fact_business c
LEFT JOIN dim_business b1 ON b1.shop_id = c.shop_id
WHERE b1.supplier_id = '1428693873'
	AND c.shop_day_key BETWEEN 20170901 AND 20171026
	AND c.status = 1
GROUP BY 1,2)C
ON A.供应商ID = C.gongyingshangid AND A.日期 = C.riqi


--需求3：9月、10月分门店数据

SELECT A.*,
		B.复购率,
		A.完成单量/C.访问uv AS '完成单转化率'
FROM
(SELECT CONCAT('#',a.wid) AS '商户ID',
		FLOOR(a.order_day_key/100) AS '月份',
		b.busi_name AS '商户名称',
		COUNT(a.order_id) AS '下单量',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '完成单量',
		SUM(IF(a.order_status = 9, a.real_total_price, 0))/1000 AS '流水优惠前',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价',
		SUM(case when a.shop_butie>0 AND a.order_status = 9 then a.shop_butie/1000 else 0 end)
			+ SUM(case when shop_quan_price>0 AND a.order_status = 9 then a.shop_quan_price/1000 else 0 end) AS '商户补贴',
		SUM(case when a.discount_baidufee_price>0  AND a.order_status = 9 then a.discount_baidufee_price/1000  else 0 end) 
			+ SUM(case when a.quan_price>0  AND a.order_status = 9 then a.quan_price/1000 else 0 end) AS '百度补贴', 
		COUNT(DISTINCT a.pass_uid) AS '交易用户数',
		COUNT(IF(a.complaint_status!=0,1,NULL)) AS '投诉单',
		COUNT(CASE WHEN a.cancel_reason_status IN(7,3,1,2,4,9,10,11,12,19,13,14,15,16,18,20,21,22,23,102,103,110,6) AND a.order_status=10 THEN a.order_id ELSE NULL END)/COUNT(a.order_id) AS '非异率'
FROM fact_order a
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.break_type = 0
	AND a.supplier_id = '1428693873'
	AND a.order_day_key BETWEEN 20170901 AND 20171026
	AND b.is_test = 0
	AND b.is_delete = 0
GROUP BY 1,2,3)A
JOIN
(SELECT  CONCAT('#',T.wid) AS id,
		 FLOOR(T.order_day_key/100) AS months,
		 SUM(if(t1>=2, 1, 0))/COUNT (T.pass_uid) AS '复购率'
    FROM 
        (SELECT a1.pass_uid, a1.wid, a1.order_day_key,  
         COUNT (a1.order_id) t1
         FROM fact_order a1
		 WHERE	a1.order_day_key
            BETWEEN 20170901 AND 20171026
                AND a1.break_type=0
                AND a1.supplier_id = '1428693873'
                AND a1.is_test=0
        GROUP BY  1,2,3) T GROUP BY 1,2) B
ON  A.商户ID = B.id AND A.月份 = B.months
JOIN
(SELECT CONCAT('#',c.waimai_release_id ) AS shanghuid,
		FLOOR(c.shop_day_key/100) AS yuefen,
		SUM(c.shop_uv) AS '访问uv'
FROM fact_business c
WHERE c.supplier_id = '1428693873'
	AND c.shop_day_key BETWEEN 20170901 AND 20171026
	AND c.status = 1
GROUP BY 1,2)C
ON A.商户ID = C.shanghuid AND A.月份 = C.yuefen

/*
NKA品牌差评数据-张亚娟1030
*/
select
d.sale_name 销售人员,
b.ka_brand 品牌,
a.order_day_key 日期,
b.city_real 城市,
concat('#',b.supplier_id) 供应商id,
c.name 供应商,
concat('#',b.wid) 商户id,
b.busi_name 商户名称,
b.aoi 商圈,
a.order_id 订单id,
a.pass_uid 用户id,
a.delivery_party 配送方,
a.order_time 下单时间,
a.score 评分,
e.content 评论,
sum(a.real_total_price/1000) 该单价格优惠前
from 
fact_order a
left join dim_business b on a.shop_id=b.shop_id
left join dim_supplier c on b.supplier_id=c.supplier_id
left join dim_order_sale_id d on b.sales_id=d.sale_id
left join comment_content_new e on e.order_id=a.order_id 
where 
b.ka_extend_lable_id in (1,2,8)
and a.order_day_key between 20171016 and 20171029 --修改日期
and a.score<=3
and a.break_type=0  
and a.order_status=9
and b.is_delete=0
and b.is_test=0
and e.is_empty=0
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15


/*
张亚辉，北京各商圈10月份LKA、NKA、非KA商户数及对应流水
/*


SELECT A.*,B.惠前流水 FROM
(SELECT b.aoi AS '商圈',
		(CASE WHEN b.ka_extend_lable_id IN (1,2,8) THEN 'NKA'
			  WHEN b.ka_extend_lable_id IN (9,11) THEN 'LKA'
			  WHEN b.ka_extend_lable_id IN (-1, 0, 6) THEN '非KA'
			  END) AS '标签',
		COUNT(DISTINCT IF(a.sys_status IN (0,6,13,14,15), a.waimai_release_id, NULL)) AS '10.29在线合作商户数'
	FROM fact_business a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.shop_day_key = 20171029
		AND b.is_test = 0
		AND b.is_delete = 0
		AND a.status = 1
		AND b.city_real = '北京'
GROUP BY 1,2)A
JOIN 
(SELECT b1.aoi AS shangquan,
		(CASE WHEN b1.ka_extend_lable_id = 1 THEN 'NKA'
			  WHEN b1.ka_extend_lable_id IN (9,11) THEN 'LKA'
			  WHEN b1.ka_extend_lable_id IN (-1, 0, 6) THEN '非KA'
			  END) AS biaoqian,
		SUM(a1.real_total_price/1000) AS '10月惠前流水'
	FROM fact_order a1
	LEFT JOIN dim_business b1 ON a1.shop_id = b1.shop_id
	WHERE a1.break_type = 0
		AND a1.order_status = 9
		AND b1.is_delete = 0
		AND b1.is_test = 0
		AND b1.city_real = '北京'
		AND a1.order_day_key BETWEEN 20171001 AND 20171029	
GROUP BY 1,2)B ON A.商圈 = B.shangquan AND A.标签 = B.biaoqian






select * from
(select 
concat('#',b.wid) AS '商户id',
  b.busi_name AS '商户名称',
  b.aoi AS '商圈',
  split_part(b.area,'（',1) AS '星系',
  c.city_region as '大区',
(case when b.ka_extend_lable_id  in(1,2,8) then 'NKA'
  when b.ka_extend_lable_id in (9,11)   then 'LKA'
  when b.ka_extend_lable_id in (-1,0,6) then  '非KA'
  else 'others' end) as 'KA标签',
count(if(a.order_status=9,a.order_id,null))as '完成订单数',
sum(if(a.order_status=9,a.real_total_price,0))/1000 as'优惠前流水',
 (sum(case when a.discount_baidufee_price>0 and a.order_status = 9 then a.discount_baidufee_price/1000 else 0 end)
  + sum(case when a.quan_price>0  and a.order_status = 9 then a.quan_price/1000 else 0 end)) as '百度补贴',
  (sum(case when a.shop_butie>0 and a.order_status=9 then a.shop_butie/1000 else 0 end)+
 sum(case when a.shop_quan_price>0 and a.order_status=9 then a.shop_quan_price/1000 else 0 end)) as '商户补贴',
 sum(if(a.order_status=9,a.te_butie_baidu,0))/1000 as '特价菜百度补贴',
 sum(if(a.order_status=9,a.jian_baidu_fee,0))/1000 as '满减百度补贴',
  sum(if(a.order_status=9,a.quan_price,0))/1000 as '代金券百度补贴',
sum(if(a.order_status=9,a.distribution_card_subsidy,0))/1000 as '五折卡百度补贴',
sum(if(a.order_status=9,a.zhe_butie_baidu,0))/1000 as '折扣百度补贴'
from dim_business b
left join fact_order a  on b.shop_id=a.shop_id
left join dim_aoi c on c.aoi_id=b.aoi_id
where b.is_test=0 
	and a.break_type = 0
	and b.is_delete = 0
	and b.status=1   
 and b.city_real='北京'
  and a.order_day_key between 20171001 and 20171029
group by 1,2,3,4,5,6)A

left join
(select concat('#',b1.shop_id) AS shanghuid,
		sum(if(b1.order_status = 9 and b1.type = 'logistics' and b1.baidu_rate = 1, b1.baidu_rate,0)) as '百度专送1元百度补贴',
		sum(if(b1.order_status = 9 and b1.type = 'logistics' and b1.baidu_rate = 2, b1.baidu_rate,0)) as '百度专送2元百度补贴',
		sum(if(b1.order_status = 9 and b1.type = 'logistics' and b1.baidu_rate = 3, b1.baidu_rate,0)) as '百度专送3元百度补贴',
		sum(if(b1.order_status = 9 and b1.type = 'logistics' and b1.baidu_rate not in (1,2,3), b1.baidu_rate,0)) as '百度专送其他金额百度补贴'
fact_yingxiao_info b1
left join dim_business b2
		where b1.index_day between 20171001 and 20171029
			and b2.city_real = '北京'
			and b2.is_delete = 0
			and b2.is_test = 0
			and b2.status = 1
group by 1)B on A.商户id = B.shanghuid





/*
王德剑,好利来无效订单流水和占比
*/

--需求1

SELECT CONCAT('#',b.wid) AS '商户ID',
		b.busi_name AS '商户名称',
		b.aoi AS '商圈',
		COUNT(a.order_id) AS '10月份门店销量',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '10月份完成单',
		COUNT(IF(a.order_status = 10, a.order_id, NULL)) AS '10月份无效订单',
		COUNT(IF(a.order_status = 10, a.order_id, NULL))/COUNT(a.order_id) AS '无效订单占比',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0)) AS '完成单流水',
		SUM(IF(a.order_status = 10, a.real_total_price/1000, 0)) AS '无效订单流水',
		SUM(IF(a.order_status = 10, a.real_total_price, 0))/(SUM(IF(a.order_status = 9, a.real_total_price, 0))+SUM(IF(a.order_status = 10, a.real_total_price, 0))) AS '无效订单流水占比'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.supplier_id = '1558206891'
		AND a.order_day_key BETWEEN 20171001 AND 20171031
		AND b.is_test = 0
		AND b.is_delete = 0
GROUP BY 1,2,3


--需求2
SELECT CONCAT('#',a.supplier_id) AS '供应商ID',
		b.ka_brand AS '品牌',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '10月份完成单',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0)) AS '10月份完成单流水',
		COUNT(IF(a.order_status = 10, a.order_id, NULL)) AS '10月份无效订单',
		SUM(IF(a.order_status = 10, a.real_total_price/1000, 0)) AS '无效订单流水'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.supplier_id = '1558206891'
		AND a.order_day_key BETWEEN 20171001 AND 20171031
		AND b.is_delete = 0
		AND b.is_test = 0
GROUP BY 1,2

--需求3
SELECT CONCAT('#',CAST(a.order_id AS STRING)) AS '无效订单编号',
		CONCAT('#',b.wid) AS '商户ID',
		b.busi_name AS '商户名称',
		b.aoi AS '所属商圈',
		a.cancel_reason AS '无效订单原因'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.supplier_id = '1558206891'
		AND a.order_day_key BETWEEN 20171001 AND 20171031
		AND a.order_status = 10
		AND b.is_delete = 0
		AND b.is_test = 0
		
		
/*
肖智明,大娘水饺
*/

SELECT a.order_day_key AS '日期',
		b.ka_brand AS '品牌',
		COUNT(DISTINCT a.waimai_release_id) AS '出单商户数',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '完成单',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0)) AS '优惠前总流水',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价',
		(SUM(a.product_price/1000) - SUM(a.after_discount_price/1000)) AS '折扣收入',
		SUM(case when a.shop_butie>0 AND a.order_status = 9 then a.shop_butie/1000 else 0 end)
			+ SUM(case when shop_quan_price>0 AND a.order_status = 9 then a.shop_quan_price/1000 else 0 end) AS '商户补贴',
		SUM(case when a.discount_baidufee_price>0  AND a.order_status = 9 then a.discount_baidufee_price/1000  else 0 end) 
			+ SUM(case when a.quan_price>0  AND a.order_status = 9 then a.quan_price/1000 else 0 end) AS '百度补贴' 
		
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.order_day_key BETWEEN 20171001 AND 20171031
		AND a.supplier_id IN ('1775266804')
		AND b.is_delete = 0
		AND b.is_test = 0
GROUP BY 1,2
				

/*
王利群，蓉李记成都名小吃
*/



--供应商维度

SELECT A.*,
		A.出单商户数/B.在线合作商户数 AS '动销率',
		C.百度市占,
		C.美团市占,
		C.饿了么市占
FROM
(SELECT CONCAT('#',a.supplier_id) AS '供应商ID',
		b.ka_brand AS '品牌',
		b.city_real AS '城市',
		FLOOR(a.order_day_key/100) AS '月份',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0)) AS '流水',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '订单',
		SUM(case when a.shop_butie>0 AND a.order_status = 9 then a.shop_butie/1000 else 0 end)
			+ SUM(case when shop_quan_price>0 AND a.order_status = 9 then a.shop_quan_price/1000 else 0 end) AS '商户补贴',
		SUM(case when a.discount_baidufee_price>0  AND a.order_status = 9 then a.discount_baidufee_price/1000  else 0 end) 
			+ SUM(case when a.quan_price>0  AND a.order_status = 9 then a.quan_price/1000 else 0 end) AS '百度补贴',
		COUNT(DISTINCT a.waimai_release_id) AS '出单商户数',
		COUNT(IF(a.real_total_price<20000 AND a.order_status = 9, a.order_id,NULL)) AS '客单价[0,20)订单数',
		COUNT(IF(a.real_total_price<30000 and a.real_total_price>=20000 AND a.order_status = 9, a.order_id,NULL)) AS '客单价[20,30)订单数',
		COUNT(IF(a.real_total_price<40000 and a.real_total_price>=30000 AND a.order_status = 9, a.order_id,NULL)) AS '客单价[30,40)订单数',
		COUNT(IF(a.real_total_price<50000 and a.real_total_price>=40000 AND a.order_status = 9, a.order_id,NULL)) AS '客单价[40,50)订单数',
		COUNT(IF(a.real_total_price<60000 and a.real_total_price>=50000 AND a.order_status = 9, a.order_id,NULL)) AS '客单价[50,60)订单数',
		COUNT(IF(a.real_total_price<70000 and a.real_total_price>=60000 AND a.order_status = 9, a.order_id,NULL)) AS '客单价[60,70)订单数',
		COUNT(IF(a.real_total_price<80000 and a.real_total_price>=70000 AND a.order_status = 9, a.order_id,NULL)) AS '客单价[70,80)订单数',
		COUNT(IF(a.real_total_price<90000 and a.real_total_price>=80000 AND a.order_status = 9, a.order_id,NULL)) AS '客单价[80,90)订单数',
		COUNT(IF(a.real_total_price<100000 and a.real_total_price>=90000 AND a.order_status = 9,a.order_id,NULL)) AS '客单价[90,100)订单数',
		COUNT(IF(a.real_total_price<120000 and a.real_total_price>=100000 AND a.order_status = 9,a.order_id,NULL)) AS '客单价[100,120)订单数',
		COUNT(IF(a.real_total_price<140000 and a.real_total_price>=120000 AND a.order_status = 9,a.order_id,NULL)) AS '客单价[120,140)订单数',
		COUNT(IF(a.real_total_price<160000 and a.real_total_price>=140000 AND a.order_status = 9,a.order_id,NULL)) AS'客单价[140,160)订单数',
		COUNT(IF(a.real_total_price>=1600000 AND a.order_status = 9,a.order_id,NULL)) AS '客单价[160,∞)订单数' 
		
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.supplier_id = '1538337277'
		AND a.order_day_key BETWEEN 20170801 AND 20171031
		AND b.is_test = 0
		AND b.is_delete = 0
GROUP BY 1,2,3,4)A
		
JOIN 
	
(SELECT CONCAT('#',b.supplier_id) AS gongyingshangid,
		FLOOR(c.shop_day_key/100) AS yuefen,
		b.city_real,
		COUNT(DISTINCT IF(c.sys_status IN (0,6,13,14,15), c.waimai_release_id, NULL)) AS '在线合作商户数'
	FROM fact_business c
	LEFT JOIN dim_business b ON c.shop_id = b.shop_id
	WHERE c.status = 1
		AND b.is_delete = 0
		AND b.is_test = 0
		AND c.shop_day_key BETWEEN 20170801 AND 20171031
		AND b.supplier_id = '1538337277'
GROUP BY 1,2,3)B ON A.供应商ID = B.gongyingshangid AND A.月份 = B.yuefen AND A.城市 = B.city_real
		
JOIN		
		
(SELECT FLOOR(d.make_date_key/100) AS yuefen,
		CONCAT('#',b.supplier_id) AS gongyingshangid,
		b.city_real,
		SUM(IF(d.source = 'baidu', d.liushui_fee, 0))/sum(d.liushui_fee) AS '百度市占',
		SUM(IF(d.source = 'meituan', d.liushui_fee, 0))/SUM(d.liushui_fee) AS '美团市占',
		SUM(IF(d.source = 'ele', d.liushui_fee, 0))/SUM(d.liushui_fee) AS '饿了么市占',
		SUM(d.liushui_fee) AS sum_liushui_fee
	FROM fact_shop_all d
	LEFT JOIN dim_business b ON d.merge_shop_id = b.wid
	WHERE d.make_date_key BETWEEN 20170801 AND 20171031
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id = '1538337277'
GROUP BY 1,2,3)C ON A.供应商ID = C.gongyingshangid AND A.月份 = C.yuefen AND A.城市 = C.city_real


--商户维度

SELECT 
		CONCAT('#',b.wid) AS '商户ID',
		b.busi_name AS '商户名称',
		FLOOR(c.shop_day_key/100) AS yuefen,
		SUM(c.url_caipin_num)/SUM(c.caipin_num) AS '图片覆盖率',
		AVG(CAST(c.bd_actual_business_time AS DOUBLE)/60) AS '营业时长'
	FROM fact_business c
	LEFT JOIN dim_business b ON c.shop_id = b.shop_id
	WHERE c.status = 1
		AND b.is_delete = 0
		AND b.is_test = 0
		AND c.shop_day_key BETWEEN 20170801 AND 20171031
		AND b.supplier_id = '1538337277'
GROUP BY 1,2,3

		


/*
谢立志
*/



--【北京全量】 日期	ka标签 订单数	完成订单数	优惠前流水	优惠后流水	老用户	新用户
-- 	百度补贴 满减百度补贴	商户补贴    前台补贴
--	曝光uv	曝光pv	访问uv	访问pv
SELECT t1.order_day_key AS '日期'
    , t1.ka_label AS 'ka标签'
    , SUM(t1.xiadan) AS '订单数'
    , SUM(t1.wandan) AS '完成订单'
    , SUM(t1.qianliushui) AS '优惠前流水'
    , SUM(t1.houliushui) AS '优惠后流水'
    , SUM(t1.new_user) AS '老用户'
    , SUM(t1.old_user) AS '新用户'
    , SUM(t1.百度补贴) AS '百度补贴'
    , SUM(t1.商户补贴) AS '商户补贴'
    , SUM(t1.前台补贴) AS '前台补贴'
    , SUM(t1.立减百度补贴) AS '立减百度补贴'
    , SUM(t2.曝光PV) AS '曝光uv'
    , SUM(t2.访问pv) AS '访问uv'
    , SUM(t2.曝光uv) AS '曝光pv'
    , SUM(t2.访问uv) AS '访问pv'
FROM 

    (SELECT a.order_day_key 
        , (CASE WHEN b.ka_extend_lable_id = 1 THEN 'NKA'
            WHEN b.ka_extend_lable_id IN (9,11) THEN 'LKA'
            WHEN b.ka_extend_lable_id IN (-1,0,6) THEN '非KA'
            WHEN b.ka_extend_lable_id = 2 THEN '下午茶'
            WHEN b.ka_extend_lable_id = 3 THEN '质享生活'
            WHEN b.ka_extend_lable_id = 4 THEN '生鲜'
            WHEN b.ka_extend_lable_id = 5 THEN '商超'
            WHEN b.ka_extend_lable_id = 7 THEN '药品'
            WHEN b.ka_extend_lable_id = 8 THEN '鲜花'
            WHEN b.ka_extend_lable_id = 10 THEN '生态链'
            ELSE 'others' END) AS ka_label
        , b.waimai_release_id 
        , COUNT(a.order_id) AS xiadan
        , COUNT(CASE WHEN order_status = 9 THEN a.order_id ELSE null END) AS wandan 
        , SUM(CASE WHEN order_status = 9 THEN a.real_total_price ELSE 0 END)/1000 AS qianliushui 
        , SUM(CASE WHEN order_status = 9 THEN a.price ELSE 0 END)/1000 AS houliushui
        , COUNT(CASE WHEN anticheat_new_user_flag = 1 THEN pass_uid ELSE null END) AS new_user 
        , COUNT(DISTINCT CASE WHEN anticheat_new_user_flag != 1 THEN pass_uid ELSE null END) AS old_user 
        , (SUM(CASE WHEN a.discount_baidufee_price>0 AND a.order_status=9 then a.discount_baidufee_price/1000 else 0 end)
        + SUM(CASE WHEN a.quan_price>0 AND a.order_status=9 then a.quan_price/1000 ELSE 0 end)) AS '百度补贴'
        , (SUM(CASE WHEN a.shop_butie>0 AND a.order_status=9 THEN a.shop_butie/1000 ELSE 0 END)
        + SUM(CASE WHEN a.shop_quan_price>0 AND a.order_status=9 THEN a.shop_quan_price/1000 ELSE 0 END)) AS '商户补贴' 
        , SUM(if(a.order_status=9,a.pay,0))/1000 AS '前台补贴'
        , SUM(CASE WHEN a.order_status = 9 AND a.jian_baidu_fee > 0 THEN a.jian_baidu_fee ELSE 0 END)/1000 AS '立减百度补贴'

    FROM dim_business AS b
    LEFT JOIN fact_order AS a ON b.shop_id = a.shop_id 
    JOIN dim_aoi AS c ON b.aoi_id = c.aoi_id
    WHERE b.city_real = '北京' 
        AND a.order_day_key BETWEEN 20171001 AND 20171031 
        AND b.is_test = 0 
        AND b.is_delete = 0 
        AND b.status = 1 
        AND a.break_type = 0 
        AND a.is_test = 0 
    GROUP BY 1,2,3) AS t1  

LEFT JOIN 

    (SELECT a.shop_day_key
        , a.waimai_release_id
        , SUM(shop_baoguang_pv) AS '曝光PV'
        , SUM(shop_pv) AS '访问pv'
        , SUM(shop_baoguang_uv) AS '曝光uv'
        , SUM(shop_uv) AS '访问uv'
    
    FROM fact_business AS a 
    JOIN dim_business AS b ON a.shop_id = b.shop_id 
    JOIN dim_aoi AS c ON b.aoi_id = c.aoi_id
    WHERE shop_day_key BETWEEN 20171001 AND 20171031
        AND a.is_test = 0 
        AND b.status = 1 
        AND b.city_real = '北京' 
    GROUP BY 1,2
    ) AS t2
ON t1.order_day_key = t2.shop_day_key AND t1.waimai_release_id = t2.waimai_release_id 
GROUP BY t1.order_day_key,t1.ka_label



-- 【活动数据-商户维度】
--  日期  ka标签 星系	大区	出单商户数	订单数	完成订单数	优惠前流水	优惠后流水	老用户	新用户
--  百度补贴    商户补贴	前台补贴     满减百度补贴     百度专送立减  
-- 	曝光uv	曝光pv	访问uv	访问pv	

use waimai;SELECT t1.order_day_key AS '日期'
    , t1.ka标签 AS KA
    , t1.销售大区 AS '销售大区'
    , t1.星系 AS '星系'
    , COUNT(DISTINCT CASE WHEN wandan >= 0 THEN t1.waimai_release_id ELSE null END) AS '出单商户数'
    , SUM(t1.xiadan) AS '下单量'
    , SUM(t1.wandan) AS '完成单'
    , SUM(t1.qianliushui) AS '前流水'
    , SUM(t1.houliushui) AS '后流水'
    , SUM(t1.new_user) AS '新用户数'
    , SUM(t1.old_user) AS '老用户数'
    , SUM(t1.baidu_butie) AS '百度补贴'
    , SUM(t1.shanghu_butie) AS '商户补贴'
    , SUM(t1.qiantai_butie) AS '前台补贴'
    , SUM(t1.lijian_baidu_butie) AS '立减百度补贴'

    , SUM(t1.logistics_jian_p) AS '百度专送立减金额'
    , SUM(t3.bd_rate) AS '百度专送-百度补贴'
    , SUM(t3.sp_rate) AS '百度专送-商户补贴'

    , SUM(t2.曝光PV)  AS '曝光PV'
    , SUM(t2.访问pv) AS '访问pv'
    , SUM(t2.曝光uv) AS '曝光uv'
    , SUM(t2.访问uv) AS '访问uv'
FROM 

    (SELECT a.order_day_key 
        , (CASE WHEN b.ka_extend_lable_id = 1 THEN 'NKA'
            WHEN b.ka_extend_lable_id IN (9,11) THEN 'LKA'
            WHEN b.ka_extend_lable_id IN (-1,0,6) THEN '非KA'
            WHEN b.ka_extend_lable_id = 2 THEN '下午茶'
            WHEN b.ka_extend_lable_id = 3 THEN '质享生活'
            WHEN b.ka_extend_lable_id = 4 THEN '生鲜'
            WHEN b.ka_extend_lable_id = 5 THEN '商超'
            WHEN b.ka_extend_lable_id = 7 THEN '药品'
            WHEN b.ka_extend_lable_id = 8 THEN '鲜花'
            WHEN b.ka_extend_lable_id = 10 THEN '生态链'
            ELSE 'others' END) AS 'ka标签'
        , c.city_region AS '销售大区'
        , split_part(b.area,'（',1) AS '星系'
        , b.waimai_release_id 
        , b.shop_id 
        , COUNT(a.order_id) AS xiadan
        , COUNT(CASE WHEN order_status = 9 THEN a.order_id ELSE null END) AS wandan 
        , SUM(CASE WHEN order_status = 9 THEN a.real_total_price ELSE 0 END)/1000 AS qianliushui 
        , SUM(CASE WHEN order_status = 9 THEN a.price ELSE 0 END)/1000 AS houliushui
        , COUNT(CASE WHEN anticheat_new_user_flag = 1 THEN pass_uid ELSE null END) AS new_user 
        , COUNT(DISTINCT CASE WHEN anticheat_new_user_flag != 1 THEN pass_uid ELSE null END) AS old_user 
        , (SUM(CASE WHEN a.discount_baidufee_price>0 AND a.order_status=9 then a.discount_baidufee_price/1000 else 0 end)
        + SUM(CASE WHEN a.quan_price>0 AND a.order_status=9 then a.quan_price/1000 ELSE 0 end)) AS baidu_butie 
        , (SUM(CASE WHEN a.shop_butie>0 AND a.order_status=9 THEN a.shop_butie/1000 ELSE 0 END)
        + SUM(CASE WHEN a.shop_quan_price>0 AND a.order_status=9 THEN a.shop_quan_price/1000 ELSE 0 END)) AS shanghu_butie
        , SUM(if(a.order_status=9,a.pay,0))/1000 AS qiantai_butie
        , SUM(CASE WHEN a.order_status = 9 AND a.jian_baidu_fee > 0 THEN a.jian_baidu_fee ELSE 0 END)/1000 AS lijian_baidu_butie
        , SUM(CASE WHEN a.order_status = 9 AND a.logistics_jian_price > 0 THEN a.logistics_jian_price ELSE 0 END)/1000 AS logistics_jian_p 

    FROM dim_business AS b
    LEFT JOIN fact_order AS a ON b.shop_id = a.shop_id 
    JOIN dim_aoi AS c ON b.aoi_id = c.aoi_id
    WHERE b.city_real = '北京' 
        AND a.order_day_key BETWEEN 20171001 AND 20171031 
        AND b.is_test = 0 
        AND b.is_delete = 0 
        AND b.status = 1 
        AND a.break_type = 0 
        AND a.is_test = 0 
        AND a.waimai_release_id IN
            (SELECT distinct waimai_release_id
                FROM fact_shop_all_activity
                WHERE activity_id IN ('sh2010097',
'sh2092287',
'sh2212587',
'sh2092462',
'sh1913191',
'sh2004932')
                AND index_day BETWEEN 20171001 AND 20171031 )
    GROUP BY 1,2,3,4,5,6) AS t1  

LEFT JOIN 

    (SELECT a.shop_day_key
        , a.waimai_release_id
        , SUM(shop_baoguang_pv) AS '曝光PV'
        , SUM(shop_pv) AS '访问pv'
        , SUM(shop_baoguang_uv) AS '曝光uv'
        , SUM(shop_uv) AS '访问uv'
    
    FROM fact_business AS a 
    JOIN dim_business AS b ON a.shop_id = b.shop_id 
    JOIN dim_aoi AS c ON b.aoi_id = c.aoi_id
    WHERE shop_day_key BETWEEN 20171001 AND 20171031
        AND a.is_test = 0 
        AND b.status = 1 
        AND b.city_real = '北京' 
    GROUP BY 1,2
    ) AS t2
ON t1.order_day_key = t2.shop_day_key AND t1.waimai_release_id = t2.waimai_release_id 

LEFT JOIN
    (SELECT shop_id 
        , index_day 
        , SUM(baidu_rate)/1000 AS bd_rate 
        , SUM(agent_rate)/1000 AS agent_rate
        , SUM(shop_rate)/1000 AS sp_rate 
    FROM fact_yingxiao_info 
    WHERE index_day BETWEEN 20171001 AND 20171031 
        AND type = 'logistics'
        AND order_status = 9 
    GROUP BY shop_id,index_day 
    ) AS t3 
ON t1.order_day_key = t3.index_day AND t1.shop_id = t3.shop_id 

GROUP BY 1,2,3,4    



-- 大区	星系	商圈	ka标签	供应商id	供应商名称	商户名称	商户id

SELECT c.city_region AS '销售大区'
    , split_part(b.area,'（',1) AS '星系'
    , b.aoi AS '商圈'
    , (CASE WHEN b.ka_extend_lable_id = 1 THEN 'NKA'
            WHEN b.ka_extend_lable_id IN (9,11) THEN 'LKA'
            WHEN b.ka_extend_lable_id IN (-1,0,6) THEN '非KA'
            WHEN b.ka_extend_lable_id = 2 THEN '下午茶'
            WHEN b.ka_extend_lable_id = 3 THEN '质享生活'
            WHEN b.ka_extend_lable_id = 4 THEN '生鲜'
            WHEN b.ka_extend_lable_id = 5 THEN '商超'
            WHEN b.ka_extend_lable_id = 7 THEN '药品'
            WHEN b.ka_extend_lable_id = 8 THEN '鲜花'
            WHEN b.ka_extend_lable_id = 10 THEN '生态链'
            ELSE 'others' END) AS 'ka标签'
    , b.supplier_id AS '供应商id'
    , c.name AS '供应商名称'
    , CONCAT('#',b.waimai_release_id) AS '商户id'
    , b.busi_name AS '商户名称'
FROM dim_business AS b 
JOIN fact_shop_all_activity AS d ON b.waimai_release_id = d.waimai_release_id 
JOIN dim_supplier AS f ON b.supplier_id = f.supplier_id 
JOIN dim_aoi AS c ON b.aoi_id = c.aoi_id
WHERE b.city_real = '北京' 
        AND d.index_day BETWEEN 20171001 AND 20171006 -- 活动时间
        AND b.is_test = 0 
        AND b.is_delete = 0 
        AND b.sys_status IN (0,6,13,14,15) -- 商户在线合作中
        AND activity_id IN ('sh2010097',
                            'sh2092287',
                            'sh2212587')
GROUP BY 1,2,3,4,5,6,7,8



-- 参加活动的商户信息 

SELECT c.city_region AS '销售大区'
    , split_part(b.area,'（',1) AS '星系'
    , b.aoi AS '商圈'
    , (CASE WHEN b.ka_extend_lable_id = 1 THEN 'NKA'
            WHEN b.ka_extend_lable_id IN (9,11) THEN 'LKA'
            WHEN b.ka_extend_lable_id IN (-1,0,6) THEN '非KA'
            WHEN b.ka_extend_lable_id = 2 THEN '下午茶'
            WHEN b.ka_extend_lable_id = 3 THEN '质享生活'
            WHEN b.ka_extend_lable_id = 4 THEN '生鲜'
            WHEN b.ka_extend_lable_id = 5 THEN '商超'
            WHEN b.ka_extend_lable_id = 7 THEN '药品'
            WHEN b.ka_extend_lable_id = 8 THEN '鲜花'
            WHEN b.ka_extend_lable_id = 10 THEN '生态链'
            ELSE 'others' END) AS 'ka标签'
    , b.supplier_id AS '供应商id'
    , c.name AS '供应商名称'
    , CONCAT('#',b.waimai_release_id) AS '商户id'
    , b.busi_name AS '商户名称'
FROM dim_business AS b 
JOIN fact_shop_all_activity AS d ON b.waimai_release_id = d.waimai_release_id 
JOIN dim_supplier AS f ON b.supplier_id = f.supplier_id 
JOIN dim_aoi AS c ON b.aoi_id = c.aoi_id
WHERE b.city_real = '北京' 
        AND d.index_day BETWEEN 20171001 AND 20171006 -- 活动时间
        AND b.is_test = 0 
        AND b.is_delete = 0 
        AND b.sys_status IN (0,6,13,14,15) -- 商户在线合作中
        AND activity_id IN ('sh2010097',
                            'sh2092287',
                            'sh2212587')
GROUP BY 1,2,3,4,5,6,7,8




-- 北京全量数据，分业务线，不同客单价下的完成单 
SELECT a.order_day_key AS '日期'
    , (CASE WHEN b.ka_extend_lable_id = 1 THEN 'NKA'
            WHEN b.ka_extend_lable_id in (9,11) THEN 'LKA'
            WHEN b.ka_extend_lable_id in (-1,0,6) THEN '非KA'
            WHEN b.ka_extend_lable_id = 2 THEN '下午茶'
            WHEN b.ka_extend_lable_id = 3 THEN '质享生活'
            WHEN b.ka_extend_lable_id = 4 THEN '生鲜'
            WHEN b.ka_extend_lable_id = 5 THEN '商超'
            WHEN b.ka_extend_lable_id = 7 THEN '药品'
            WHEN b.ka_extend_lable_id = 8 THEN '鲜花'
            WHEN b.ka_extend_lable_id = 10 THEN '生态链'
            ELSE 'others' END) AS 'ka标签'
    , COUNT(CASE WHEN a.real_total_price/1000 >= 0 AND a.real_total_price/1000 < 10 THEN a.order_id ELSE null END) AS qian_wan_0
    , COUNT(CASE WHEN a.real_total_price/1000 >= 10 AND a.real_total_price/1000 < 15 THEN a.order_id ELSE null END) AS qian_wan_1
    , COUNT(CASE WHEN a.real_total_price/1000 >= 15 AND a.real_total_price/1000 < 20 THEN a.order_id ELSE null END) AS qian_wan_2 
    , COUNT(CASE WHEN a.real_total_price/1000 >= 20 AND a.real_total_price/1000 < 25 THEN a.order_id ELSE null END) AS qian_wan_3
    , COUNT(CASE WHEN a.real_total_price/1000 >= 25 AND a.real_total_price/1000 < 30 THEN a.order_id ELSE null END) AS qian_wan_4 
    , COUNT(CASE WHEN a.real_total_price/1000 >= 30 AND a.real_total_price/1000 < 35 THEN a.order_id ELSE null END) AS qian_wan_5
    , COUNT(CASE WHEN a.real_total_price/1000 >= 35 AND a.real_total_price/1000 < 40 THEN a.order_id ELSE null END) AS qian_wan_6 
    , COUNT(CASE WHEN a.real_total_price/1000 >= 40 AND a.real_total_price/1000 < 45 THEN a.order_id ELSE null END) AS qian_wan_7
    , COUNT(CASE WHEN a.real_total_price/1000 >= 45 AND a.real_total_price/1000 < 50 THEN a.order_id ELSE null END) AS qian_wan_8 
    , COUNT(CASE WHEN a.real_total_price/1000 >= 50 AND a.real_total_price/1000 < 55 THEN a.order_id ELSE null END) AS qian_wan_9
    , COUNT(CASE WHEN a.real_total_price/1000 >= 55 AND a.real_total_price/1000 < 60 THEN a.order_id ELSE null END) AS qian_wan_10 
    , COUNT(CASE WHEN a.real_total_price/1000 >= 60 AND a.real_total_price/1000 < 65 THEN a.order_id ELSE null END) AS qian_wan_11
    , COUNT(CASE WHEN a.real_total_price/1000 >= 65 AND a.real_total_price/1000 < 70 THEN a.order_id ELSE null END) AS qian_wan_12 
    , COUNT(CASE WHEN a.real_total_price/1000 >= 70 AND a.real_total_price/1000 < 75 THEN a.order_id ELSE null END) AS qian_wan_13
    , COUNT(CASE WHEN a.real_total_price/1000 >= 75 AND a.real_total_price/1000 < 80 THEN a.order_id ELSE null END) AS qian_wan_14 
    , COUNT(CASE WHEN a.real_total_price/1000 >= 80 AND a.real_total_price/1000 < 85 THEN a.order_id ELSE null END) AS qian_wan_15
    , COUNT(CASE WHEN a.real_total_price/1000 >= 85 AND a.real_total_price/1000 < 90 THEN a.order_id ELSE null END) AS qian_wan_16 
    , COUNT(CASE WHEN a.real_total_price/1000 >= 90 AND a.real_total_price/1000 < 95 THEN a.order_id ELSE null END) AS qian_wan_17
    , COUNT(CASE WHEN a.real_total_price/1000 >= 95 AND a.real_total_price/1000 < 100 THEN a.order_id ELSE null END) AS qian_wan_18 
    , COUNT(CASE WHEN a.real_total_price/1000 >= 100 AND a.real_total_price/1000 < 200 THEN a.order_id ELSE null END) AS qian_wan_19
    , COUNT(CASE WHEN a.real_total_price/1000 >= 200 THEN a.order_id ELSE null END) AS qian_wan_20 
    
    , COUNT(CASE WHEN a.price/1000 >= 0 AND a.price/1000 < 10 THEN a.order_id ELSE null END) AS hou_wan_0
    , COUNT(CASE WHEN a.price/1000 >= 10 AND a.price/1000 < 15 THEN a.order_id ELSE null END) AS hou_wan_1
    , COUNT(CASE WHEN a.price/1000 >= 15 AND a.price/1000 < 20 THEN a.order_id ELSE null END) AS hou_wan_2 
    , COUNT(CASE WHEN a.price/1000 >= 20 AND a.price/1000 < 25 THEN a.order_id ELSE null END) AS hou_wan_3
    , COUNT(CASE WHEN a.price/1000 >= 25 AND a.price/1000 < 30 THEN a.order_id ELSE null END) AS hou_wan_4 
    , COUNT(CASE WHEN a.price/1000 >= 30 AND a.price/1000 < 35 THEN a.order_id ELSE null END) AS hou_wan_5
    , COUNT(CASE WHEN a.price/1000 >= 35 AND a.price/1000 < 40 THEN a.order_id ELSE null END) AS hou_wan_6 
    , COUNT(CASE WHEN a.price/1000 >= 40 AND a.price/1000 < 45 THEN a.order_id ELSE null END) AS hou_wan_7
    , COUNT(CASE WHEN a.price/1000 >= 45 AND a.price/1000 < 50 THEN a.order_id ELSE null END) AS hou_wan_8 
    , COUNT(CASE WHEN a.price/1000 >= 50 AND a.price/1000 < 55 THEN a.order_id ELSE null END) AS hou_wan_9
    , COUNT(CASE WHEN a.price/1000 >= 55 AND a.price/1000 < 60 THEN a.order_id ELSE null END) AS hou_wan_10 
    , COUNT(CASE WHEN a.price/1000 >= 60 AND a.price/1000 < 65 THEN a.order_id ELSE null END) AS hou_wan_11
    , COUNT(CASE WHEN a.price/1000 >= 65 AND a.price/1000 < 70 THEN a.order_id ELSE null END) AS hou_wan_12 
    , COUNT(CASE WHEN a.price/1000 >= 70 AND a.price/1000 < 75 THEN a.order_id ELSE null END) AS hou_wan_13
    , COUNT(CASE WHEN a.price/1000 >= 75 AND a.price/1000 < 80 THEN a.order_id ELSE null END) AS hou_wan_14 
    , COUNT(CASE WHEN a.price/1000 >= 80 AND a.price/1000 < 85 THEN a.order_id ELSE null END) AS hou_wan_15
    , COUNT(CASE WHEN a.price/1000 >= 85 AND a.price/1000 < 90 THEN a.order_id ELSE null END) AS hou_wan_16 
    , COUNT(CASE WHEN a.price/1000 >= 90 AND a.price/1000 < 95 THEN a.order_id ELSE null END) AS hou_wan_17
    , COUNT(CASE WHEN a.price/1000 >= 95 AND a.price/1000 < 100 THEN a.order_id ELSE null END) AS hou_wan_18 
    , COUNT(CASE WHEN a.price/1000 >= 100 AND a.price/1000 < 200 THEN a.order_id ELSE null END) AS hou_wan_19
    , COUNT(CASE WHEN a.price/1000 >= 200 THEN a.order_id ELSE null END) AS hou_wan_20 

FROM dim_business AS b 
LEFT JOIN fact_order AS a ON b.shop_id = a.shop_id 
WHERE b.city_real = '北京' 
        AND a.order_day_key BETWEEN 20170926 AND 20170927 
        AND b.is_test = 0 
        AND b.is_delete = 0 
        AND b.status = 1 
        AND a.break_type = 0 
        AND a.is_test = 0 
        AND b.sys_status IN (0,6,13,14,15) -- 在线合作中的商户
        AND a.order_status = 9 
GROUP BY 1,2  




/*
关越 按客单价10元为基本单位分区间 
*/




SELECT A.全城送完成单金额区间,
		SUM(B.全城送完成订单数),
		SUM(B.每单配送费)/SUM(B.全城送完成订单数)
FROM 
(SELECT  a.order_id,
		(CASE WHEN
			 a.real_total_price<20000 AND a.order_status = 9 THEN '客单价[0,20)'
		WHEN a.real_total_price<30000 and a.real_total_price>=20000 AND a.order_status = 9 THEN '客单价[20,30)'
		WHEN a.real_total_price<40000 and a.real_total_price>=30000 AND a.order_status = 9 THEN '客单价[30,40)'
		WHEN a.real_total_price<50000 and a.real_total_price>=40000 AND a.order_status = 9 THEN '客单价[40,50)'
		WHEN a.real_total_price<60000 and a.real_total_price>=50000 AND a.order_status = 9 THEN '客单价[50,60)'
		WHEN a.real_total_price<70000 and a.real_total_price>=60000 AND a.order_status = 9 THEN '客单价[60,70)'
		WHEN a.real_total_price<80000 and a.real_total_price>=70000 AND a.order_status = 9 THEN '客单价[70,80)'
		WHEN a.real_total_price<90000 and a.real_total_price>=80000 AND a.order_status = 9 THEN '客单价[80,90)'
		WHEN a.real_total_price<100000 and a.real_total_price>=90000 AND a.order_status = 9 THEN '客单价[90,100)'
		WHEN a.real_total_price<110000 and a.real_total_price>=100000 AND a.order_status = 9 THEN '客单价[100,110)'
		WHEN a.real_total_price<120000 and a.real_total_price>=110000 AND a.order_status = 9 THEN '客单价[110,120)'
		WHEN a.real_total_price<130000 and a.real_total_price>=120000 AND a.order_status = 9 THEN '客单价[120,130)'
		WHEN a.real_total_price<140000 and a.real_total_price>=130000 AND a.order_status = 9 THEN '客单价[130,140)'
		WHEN a.real_total_price<150000 and a.real_total_price>=140000 AND a.order_status = 9 THEN '客单价[140,150)'
		WHEN a.real_total_price<160000 and a.real_total_price>=150000 AND a.order_status = 9 THEN '客单价[150,160)'
		WHEN a.real_total_price<170000 and a.real_total_price>=160000 AND a.order_status = 9 THEN '客单价[160,170)'
		WHEN a.real_total_price<180000 and a.real_total_price>=170000 AND a.order_status = 9 THEN '客单价[170,180)'
		WHEN a.real_total_price<190000 and a.real_total_price>=180000 AND a.order_status = 9 THEN '客单价[180,190)'
		WHEN a.real_total_price<200000 and a.real_total_price>=190000 AND a.order_status = 9 THEN '客单价[190,200)'
		WHEN a.real_total_price>=200000 AND a.order_status = 9 THEN '客单价[200,∞)'
		END) AS '全城送完成单金额区间'
	FROM fact_order a 
	WHERE a.break_type = 0
		AND a.order_day_key BETWEEN 20171001 AND 20171031
		AND a.order_id IN		
(SELECT a.out_order_id
	FROM fact_wuliu_order a
	WHERE a.order_status = 9
		AND a.order_type = 1004
		AND a.city_name = '北京'
		AND a.order_day_key BETWEEN 20171001 AND 20171031)
)A

JOIN

(SELECT a.out_order_id,
		a.shipping_money AS '每单配送费',
		COUNT(IF(a.order_status = 9,a.out_order_id,NULL)) AS '全城送完成订单数'
	FROM fact_wuliu_order a
	WHERE a.order_status = 9
		AND a.order_type = 1004
		AND a.city_name = '北京'
		AND a.order_day_key BETWEEN 20171001 AND 20171031
GROUP BY 1,2)B ON A.order_id = B.out_order_id
GROUP BY 1



/*
刘飞 深圳NKA 九毛九
*/




SELECT A.*,
		B.caipin AS '热销菜',
		C.*
FROM
(SELECT CONCAT('#', b.wid) AS '商户ID',
		b.busi_name AS '商户名称',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0)) AS '流水',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价',
		COUNT(CASE WHEN anticheat_new_user_flag = 1 THEN pass_uid ELSE null END) AS '新用户',
        COUNT(DISTINCT CASE WHEN anticheat_new_user_flag != 1 THEN pass_uid ELSE null END) AS '老用户'		
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND b.is_delete = 0
		AND b.is_test = 0
		AND a.order_day_key BETWEEN 20170801 AND 20171031
		AND a.supplier_id = '1741351701'
GROUP BY 1,2)A 

JOIN		

(SELECT CONCAT('#',b.wid ) AS shanghuid,
		SUM(c.shop_baoguang_uv) AS '曝光uv',
		SUM(c.shop_baoguang_pv) AS '曝光pv'
FROM fact_business c
LEFT JOIN dim_business b ON b.shop_id = c.shop_id
WHERE c.supplier_id = '1741351701'
	AND c.shop_day_key BETWEEN 20170801 AND 20171031
	AND c.status = 1
	AND b.is_delete = 0
	AND b.is_test = 0
GROUP BY 1)C
ON A.商户ID = C.shanghuid

LEFT JOIN

(select *
from 
(select *,ROW_NUMBER() OVER(PARTITION BY T1.商户ID ORDER BY T1.销量 desc) paixu
from 
(
select
	b2.busi_name as '商户名称',
	concat('#',b2.wid) as '商户ID',
	d.caipin_name ,
	sum(d.number) as '销量'
from 
	dim_business b2 
	left join fact_caipin_details d on b2.shop_id=d.shop_id
where 
	b2.is_test=0 and b2.is_delete=0 
	and d.order_status=9
	and b2.supplier_id = '1741351701'
	and d.order_day_key between 20170801 and 20171031
group by 1,2,3
)T1
)T
where
	T.paixu<=5)B1
ON A.商户ID = B1.商户ID





/*(SELECT CONCAT('#',b.wid) AS shanghuid,
		c.caipin_name AS caipin,
		SUM(c.number) AS xiaoliang
	FROM dim_business b
	LEFT JOIN fact_caipin_details c ON b.shop_id = c.shop_id
	WHERE b.is_delete = 0
		AND b.is_test = 0
		AND c.order_day_key BETWEEN 20170801 AND 20171031
		AND b.supplier_id = '1741351701'
		AND c.order_status = 9
GROUP BY 1,2
ORDER BY xiaoliang DESC
LIMIT 5)B ON A.商户ID = B.shanghuid*/
		

/*
徐薇，新商户
*/

SELECT * FROM
(select FLOOR(a.order_day_key/100) AS '月份',
		d.city_region AS '大区',
		split_part(b.area,'（',1) AS '星系',
		CONCAT('#',b.waimai_release_id) AS '商户id',
		b.busi_name AS '商户名称',
		b.category AS '品类',
		b.category1_name AS '商户类型',
		(from_unixtime(b.create_time+8*3600,'yyyy-MM-dd')) AS '建店时间',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0)) AS '流水',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '订单量',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价',
from dim_business b
join fact_order a on a.shop_id=b.shop_id
JOIN dim_aoi d ON b.aoi_id=d.aoi_id
where a.break_type=0
	and a.order_day_key between 20170801 and 20171031
	and b.is_test = 0
	and b.is_delete = 0
	and from_unixtime(b.create_time+8*3600,'yyyyMMdd')>='20170801'
	and from_unixtime(b.create_time+8*3600,'yyyyMMdd')<='20171031'
	and b.city_real='北京'
group by 1,2,3,4,5,6,7,8)A

LEFT JOIN 

(SELECT  CONCAT('#',T.wid) AS shanghuid, 
		 SUM(if(t1>=2 ,
         1,
         0))/COUNT (pass_uid) AS '复购率'
    FROM 
        (SELECT a1.pass_uid, a1.wid, 
         COUNT (a1.order_id) t1
         FROM fact_order a1 
		 LEFT JOIN dim_business b ON a.shop_id = b.shop_id
		 WHERE	a1.order_day_key BETWEEN 20170801 AND 20171031
                AND a1.break_type=0
                AND b.city_real = '北京'
				AND from_unixtime(b.create_time+8*3600,'yyyyMMdd')>='20170801'
				AND from_unixtime(b.create_time+8*3600,'yyyyMMdd')<='20171031'
                AND b.is_test=0
				AND b.is_delete = 0
        GROUP BY  1,2) T GROUP BY 1)B ON A.商户id = B.shanghuid


/*
王慧明 新辣道差评数据 订单维度
*/

SELECT
	CONCAT('#', CAST(a.order_id AS STRING)) AS '订单ID',
	CONCAT('#', a.pass_uid) AS '用户ID',
	CONCAT('#', c.supplier_id) AS '供应商id',
	c.name AS '供应商名称',
	b.ka_brand AS '品牌',
	b.busi_name AS '商户名称',
	a.order_day_key AS '日期',
	b.city_real AS '城市',
	b.aoi AS '商圈',
	a.delivery_party AS '配送方名称',
	a.real_total_price/1000 AS '惠前价格',
	d.score AS '评分',
	d.content AS '评价',
	e.sale_name AS '销售人员',
	a.order_time AS '下单时间'
FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id=b.shop_id 
	LEFT JOIN comment_content_new d ON a.order_id=d.order_id
	LEFT JOIN dim_order_sale_id e ON a.sale_id = e.sale_id
	LEFT JOIN dim_supplier c ON b.supplier_id = c.supplier_id
WHERE a.order_status=9 
	AND a.break_type = 0
	AND b.is_delete=0 
    AND b.is_test=0
	AND a.order_day_key BETWEEN 20171001 AND 20171031 
	AND d.score IN (1,2) AND c.supplier_id = '1706003526'

/*
黄家玉 北京地区aoi数据
*/

SELECT a.order_day_key AS '日期',
		CONCAT('#',b.aoi_id) AS 'aoi id',
		split_part(b.area,'（',2) AS 'aoi所在区域',
		b.aoi AS '商圈',
		COUNT(a.order_id) AS '总完成单',
		COUNT(IF(a.order_time>='11:00' AND a.order_time<='13:00', a.order_id,NULL)) AS '午高峰完成单',
		COUNT(IF(d.wuliu_enum_value = 1, a.order_id, NULL)) AS '总物流单',
		COUNT(IF(d.wuliu_enum_value = 1 AND a.order_time>='11:00' AND a.order_time<='13:00' ,a.order_id,NULL)) AS '午高峰物流单'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	LEFT JOIN dim_order_delivery_party d ON a.delivery_party = d.delivery_party
	WHERE a.break_type = 0
		AND a.order_status = 9
		AND a.order_day_key BETWEEN 20170914 AND 20170921
		AND a.order_id IN		
		(SELECT a.out_order_id
			FROM fact_wuliu_order a
			WHERE a.order_status = 9
				AND a.city_name = '北京'
				AND a.order_day_key BETWEEN 20170914 AND 20170921)
				AND b.is_test = 0
				AND b.is_delete = 0
GROUP BY 1,2,3,4



/*
伏天 必胜客 不同原因取消单数据
*/

SELECT b.city_real AS '城市',
		b.busi_name AS '商户',
		CONCAT('#',b.wid) AS '商户ID',
		COUNT(a.order_id) AS '下单量',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '完成单',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0)) AS '惠前流水',
		COUNT(IF(a.order_status = 10, a.order_id, NULL)) AS '取消单',
		SUM(IF(a.order_status = 10, a.real_total_price/1000, 0)) AS '取消单流水',
		COUNT(IF(a.order_status = 10 AND a.cancel_reason_status = 7, a.order_id, NULL)) AS '超时商户未响应取消单',
		SUM(IF(a.order_status = 10 AND a.cancel_reason_status = 7, a.real_total_price/1000, NULL)) AS '超时商户未响应取消单流水',
		COUNT(IF(a.order_status = 10 AND a.cancel_reason_status = 3, a.order_id, NULL)) AS '菜品售完取消单',
		SUM(IF(a.order_status = 10 AND a.cancel_reason_status = 3, a.real_total_price/1000, NULL)) AS '菜品售完取消单流水',
		COUNT(IF(a.order_status = 10 AND a.cancel_reason_status = 5, a.order_id, NULL)) AS '用户取消单',
		SUM(IF(a.order_status = 10 AND a.cancel_reason_status = 5, a.real_total_price/1000, NULL)) AS '用户取消单流水'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
		WHERE b.is_delete = 0
			AND b.is_test = 0
			AND a.break_type = 0
			AND a.order_day_key BETWEEN 20171001 AND 20171031
			AND a.supplier_id
				IN('1450203709', 
					'1450203309', 
					'1450118486 ',
					'1441901768 ',
					'1441874283 ',
					'1441743729 ',
					'1438161150 ',
					'8768576007540836758') 
GROUP BY 1, 2, 3


/*
麦当劳综合评分，商户维度
*/
SELECT CONCAT('#',b.wid) AS '商户ID',
		b.busi_name AS '商户名称',
		AVG(a.score) AS '综合评分'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.order_status = 9
		AND b.is_delete = 0
		AND b.is_test = 0
		AND a.order_day_key BETWEEN 20170901 AND 20170930
		AND b.wid IN(
		
'1847972894',
'1847973040',
'1847973146',
'1847973451',
'1847973726',
'1847973841',
'1847973919',
'1851266293',
'1851289872',
'1851300609',
'1855852556',
'1856018342',
'1856018427',
'1857448649',
'1858712873',
'1858712946',
'1858713025',
'1858713103',
'1858713195',
'1859078145',
'1859154984',
'1859162941',
'1860040053',
'1862141086',
'1863849555',
'1863849654',
'1866160232',
'1867029671',
'1867329039',
'1867329265',
'1867329357',
'1867333691',
'1867333842',
'1867338273',
'1868778370',
'1868780164',
'1868781057',
'1868781768',
'1868783325',
'1868784021',
'1868784593',
'1868784977',
'1868785416',
'1868785808',
'1868788139',
'1868788590',
'1868789093',
'1868789640',
'1872152726',
'1872166078',
'1873218186',
'1874283341',
'1874334118',
'1879355003',
'1879355004',
'1879355023',
'1879355024',
'1879355080',
'1879355115',
'1879355136',
'1879419127',
'1885289811',
'1885289891',
'1885291008',
'1885291119',
'1885398984',
'1887176899',
'1887181308',
'1889519978',
'1889521746',
'1893789188',
'1893790865',
'1893792377',
'1893792734',
'1893793036',
'1893793242',
'1893793375',
'1893793456',
'1893793647',
'1893793759',
'1893793824',
'1893794018',
'1895977986',
'1895978643',
'1895979168',
'1895979688',
'1895980212',
'1895981014',
'1895981457',
'1895981930',
'1895983111',
'1895983390',
'1895985803',
'1895987442',
'1895988117',
'1895988815',
'1895989756',
'1895990271',
'1895990698',
'1895991343',
'1896093547',
'1896096479',
'1896099239',
'1896157971',
'1896159367',
'1896160741',
'1896161737',
'1896162831',
'1896163795',
'1896167102',
'1896168065',
'1896169958',
'1896233303',
'1896241119',
'1896248233',
'1896251041',
'1896252573',
'1896254241',
'1896338322',
'1896342466',
'1896343905',
'1896746305',
'1902217448',
'1902234566',
'1902235111',
'1902239008',
'1902239072',
'1902239206',
'1902239311',
'1902239366',
'1902239435',
'1902239591',
'1902239837',
'1902240257',
'1902240267',
'1902240340',
'1902240463',
'1902240631',
'1902240661',
'1902600846',
'1902601541',
'1908048149',
'1908378221',
'1908855671',
'1908994719',
'1909104737',
'1910219241',
'1910919122',
'1910926550',
'1910928219',
'1910929805',
'1910932297',
'1911036451',
'1911060872',
'1914623410',
'1914786849',
'1914787918',
'1914789095',
'1915104773',
'1915224583',
'1915236608',
'1915240952',
'1915543808',
'1915556210',
'1915665327',
'1915691357',
'1915716837',
'1915726502',
'1915733383',
'1915747630',
'1924668011',
'1926390622',
'1926438739',
'1926480511',
'1926839231',
'1927787852',
'1932901279',
'1932901380',
'1934068388',
'1934080851',
'1934086077',
'1934180600',
'1934180627',
'1934180664',
'1934180694',
'1934180725',
'1934180747',
'1934180771',
'1934180797',
'1934180819',
'1934180840',
'1934180870',
'1934180893',
'1934180911',
'1934180935',
'1934180961',
'1934180980',
'1934181015',
'1934576499',
'1934578235',
'1934614597',
'1934614709',
'1934614779',
'1934914039',
'1936683521',
'1936683772',
'1938910346',
'1939021919',
'1939043214',
'1954848432',
'1955961290',
'1955969318',
'1955986630',
'1956111621',
'1956165610',
'1970561664',
'1970572977',
'1970573086',
'1970574711',
'1970576568',
'1970577615',
'1970577633',
'1970579291',
'1970579351',
'1970579385',
'1970580958',
'1970581017',
'1970581091',
'1970584870',
'1970585383',
'1970589312',
'1970589363',
'1970589506',
'1970589561',
'1970589685',
'1970589750',
'1970591459',
'1970591797',
'1970594580',
'1970594623',
'1970594742',
'1970600341',
'1970615751',
'1972628759',
'1972628974',
'1972642786',
'1973796143',
'1973816409',
'1973816450',
'1974058541',
'1974650645',
'1974650671',
'1974650727',
'1978871164',
'1978927056',
'1979620599',
'1981672618',
'1983879152',
'1986069229',
'1986425560',
'1986431173',
'1986447532',
'1986451415',
'1986468336',
'1986481837',
'1986490917',
'1986498736',
'1986504978',
'1993454984',
'1996794134',
'1997624381',
'1997632324',
'2000045952',
'2001615185',
'2001615246',
'2001615301',
'2001615340',
'2001615390',
'2001615453',
'2003651060',
'2003826573',
'2012396659',
'2012412691',
'2015818634',
'2020979240',
'2021805110',
'2021824394',
'2021828737',
'2021829190',
'2021829441',
'2021829488',
'2021829692',
'2021829918',
'2021830053',
'2021830105',
'2021830215',
'2025684360',
'2025695222',
'2025700553',
'2025702221',
'2025736423',
'2025740726',
'2025954877',
'2029684303',
'2029697638',
'2029787322',
'2035657312',
'2035657396',
'2035657441',
'2035657514',
'2035657642',
'2035657717',
'2037713966',
'2039034671',
'2043401240',
'2044126261',
'2045557444',
'2045787306',
'2045787609',
'2045787775',
'2045788124',
'2045788379',
'2045788863',
'2045789043',
'2045789109',
'2045789211',
'2045790009',
'2045790026',
'2045824835',
'2049591025',
'2049595007',
'2049595019',
'2049595057',
'2049595087',
'2049595141',
'2053119998',
'2054179597',
'2054201056',
'2054204551',
'2054207955',
'2057637366',
'2057666369',
'2059947370',
'2062310856',
'2062330606',
'2062352654',
'2062352678',
'2062352691',
'2062352711',
'2062352729',
'2062352732',
'2062352777',
'2062352813',
'2062352857',
'2062352894',
'2062352932',
'2062352964',
'2062352988',
'2064709091',
'2065293004',
'2065334843',
'2065456494',
'2065456526',
'2065924340',
'2065925765',
'2068137529',
'2068141377',
'2068147873',
'2076885846',
'2077172024',
'2077198628',
'2077200079',
'2077200226',
'2077200251',
'2077200286',
'2077261953',
'2079892072',
'2083408476',
'2083714702',
'2086385243',
'2086397187',
'2086473409',
'2086484087',
'2086491097',
'2086494940',
'2086505682',
'2086516422',
'2086850106',
'2086852214',
'2086861593',
'2086861623',
'2086861657',
'2086861692',
'2086861721',
'2086861776',
'2086861826',
'2086861852',
'2088625482',
'2088628490',
'2088628521',
'2088628578',
'2088628597',
'2088631514',
'2089907057',
'2089923404',
'2089928341',
'2090397118',
'2090686327',
'2091349663',
'2097426398',
'2099003405',
'2099005810',
'2099276281',
'2099282219',
'2099282274',
'2099282298',
'2099282343',
'2099282362',
'2099282397',
'2099282436',
'2099282476',
'2099282528',
'2099282582',
'2099303437',
'2099357302',
'2099415538',
'2100229900',
'2100658172',
'2100658175',
'2100658247',
'2100658314',
'2100658316',
'2100658391',
'2100658455',
'2100658519',
'2100658574',
'2105845357',
'2106849213',
'2106855166',
'2106855204',
'2106855231',
'2106855257',
'2106855312',
'2106855349',
'2106855384',
'2106855415',
'2106855446',
'2106855464',
'2106855486',
'2107000754',
'2107014223',
'2109509125',
'2109529941',
'2109540566',
'2109547450',
'2109565937',
'2109570619',
'2109581909',
'2109590907',
'2109595217',
'2109596728',
'2109598575',
'2109602264',
'2109605380',
'2111630984',
'2111864263',
'2115375757',
'2115381159',
'2115381209',
'2116186836',
'2116326582',
'2116631372',
'2116633566',
'2116635232',
'2116637374',
'2116638645',
'2116640901',
'2116643829',
'2116645115',
'2117028516',
'2118701912',
'2118703001',
'2118704404',
'2118705385',
'2118705822',
'2118706729',
'2118706813',
'2118706896',
'2120274773',
'2120275559',
'2120275583',
'1516455803',
'1516456170',
'1516456862',
'1516457381',
'1516461204',
'1516462420',
'1516464883',
'1520489996',
'1520496410',
'1520500961',
'1520505804',
'1521496236',
'1522334074',
'1522335471',
'1523961845',
'1528258284',
'1530292119',
'1530293575',
'1530294462',
'1533133425',
'1533600929',
'1533601546',
'1533602365',
'1533674306',
'1534885910',
'1534894230',
'1535507068',
'1535513708',
'1535521387',
'1535524207',
'1535527573',
'1535529332',
'1538477656',
'1538483510',
'1538488979',
'1541926811',
'1544629234',
'1544633050',
'1545367035',
'1547912148',
'1548085296',
'1548119236',
'1548119408',
'1548135540',
'1548146882',
'1548157807',
'1548162640',
'1551998888',
'1552009619',
'1552022039',
'1553066163',
'1553883912',
'1553885293',
'1553886303',
'1553887168',
'1553888683',
'1553895037',
'1553896761',
'1553898975',
'1554145872',
'1554517586',
'1554572494',
'1554578223',
'1555093499',
'1561014686',
'1561022192',
'1561023196',
'1561024106',
'1561025164',
'1561026873',
'1561029212',
'1561033897',
'1561036043',
'1561037665',
'1561038763',
'1561506198',
'1561833581',
'1561835435',
'1561837169',
'1561839860',
'1569422901',
'1570524863',
'1570554916',
'1570558255',
'1570563084',
'1570915873',
'1572314186',
'1572317521',
'1572739676',
'1572764802',
'1572773954',
'1572784445',
'1572858100',
'1572862435',
'1572873843',
'1572880806',
'1572884581',
'1572887355',
'1577073546',
'1577083607',
'1577105686',
'1579039871',
'1579789512',
'1582685325',
'1582702304',
'1582705268',
'1582707660',
'1582711694',
'1584884107',
'1584885162',
'1584887235',
'1584888441',
'1584889868',
'1584892627',
'1584896045',
'1584934262',
'1584937793',
'1584938487',
'1585654035',
'1585654596',
'1585655065',
'1585656119',
'1585661141',
'1585661685',
'1585662533',
'1585664971',
'1585665610',
'1585666167',
'1585667352',
'1585692972',
'1588156043',
'1588178445',
'1588185274',
'1588323403',
'1588363040',
'1588363749',
'1588364561',
'1588365222',
'1588369189',
'1588369907',
'1588465839',
'1590247600',
'1590249088',
'1590252030',
'1590420377',
'1590423181',
'1590428613',
'1590432536',
'1590437128',
'1590439887',
'1590442494',
'1590444942',
'1590448969',
'1590450606',
'1590452487',
'1590454539',
'1590456160',
'1591037160',
'1591077337',
'1593640310',
'1593665273',
'1593667863',
'1593670003',
'1593671070',
'1593671946',
'1593672738',
'1593674475',
'1593675533',
'1593682776',
'1593683659',
'1593684280',
'1593685253',
'1593713940',
'1593714598',
'1593715239',
'1593715628',
'1593718124',
'1593719277',
'1593719880',
'1593738114',
'1594172193',
'1594951909',
'1594954714',
'1594960651',
'1594962123',
'1594964798',
'1594967465',
'1594980313',
'1594985948',
'1594989263',
'1594991217',
'1594992708',
'1594993857',
'1594995458',
'1594998599',
'1594998900',
'1595000245',
'1595007884',
'1595025804',
'1595143913',
'1595144848',
'1595147321',
'1595148501',
'1595149372',
'1595151090',
'1595431957',
'1595432748',
'1600412665',
'1600415606',
'1600771765',
'1600836082',
'1603161208',
'1603473479',
'1603475509',
'1603476444',
'1603477378',
'1603478131',
'1603479031',
'1603482228',
'1603483067',
'1605823989',
'1605827724',
'1605958105',
'1605960345',
'1605962670',
'1605964186',
'1605965522',
'1605985893',
'1607643205',
'1607648973',
'1607660524',
'1607832445',
'1614951947',
'1616327397',
'1616333305',
'1616336836',
'1616343433',
'1616347053',
'1620340789',
'1620340795',
'1620340803',
'1620345069',
'1620717824',
'1620739430',
'1621950173',
'1622451440',
'1622458440',
'1622752709',
'1622753965',
'1622755293',
'1631003008',
'1631728528',
'1632563257',
'1634567453',
'1634574998',
'1634581226',
'1635974069',
'1635985506',
'1635989942',
'1637692596',
'1638619201',
'1638621168',
'1638622520',
'1638624143',
'1638625676',
'1638643679',
'1640937336',
'1641431774',
'1642305306',
'1645788649',
'1645788652',
'1648625045',
'1648896415',
'1654195538',
'1654635986',
'1654645648',
'1654648866',
'1654653070',
'1655156376',
'1656829016',
'1660480216',
'1660482569',
'1660482595',
'1660482624',
'1660482634',
'1660482702',
'1660482724',
'1660492922',
'1661166046',
'1661313685',
'1667494491',
'1667573350',
'1667700253',
'1667703270',
'1668195374',
'1668759649',
'1672339683',
'1678816924',
'1686712226',
'1686713254',
'1686713286',
'1686713322',
'1686854466',
'1686875390',
'1691944592',
'1691955743',
'1692009702',
'1692017163',
'1692421313',
'1695403372',
'1695453133',
'1695506574',
'1695578966',
'1700864982',
'1701781594',
'1704062642',
'1706517553',
'1706530806',
'1706570907',
'1706659549',
'1706674434',
'1709492199',
'1712404165',
'1712407425',
'1712410707',
'1712412562',
'1712414209',
'1712416026',
'1712418008',
'1712420000',
'1712436596',
'1712438656',
'1712440135',
'1712441492',
'1712442919',
'1712444848',
'1713659431',
'1714430347',
'1720011172',
'1720831643',
'1720831644',
'1720831646',
'1720831647',
'1720831648',
'1720831649',
'1721809473',
'1721822457',
'1721836584',
'1736768761',
'1737268154',
'1743735442',
'1745986999',
'1748924826',
'1752311933',
'1753460657',
'1753460658',
'1753460659',
'1753460660',
'1754117049',
'1758298820',
'1758474867',
'1760151403',
'1760358628',
'1762724481',
'1762746996',
'1762851887',
'1771671087',
'1771955586',
'1772557315',
'1774068889',
'1778786948',
'1778834148',
'1781456350',
'1781513592',
'1781539124',
'1781588667',
'1781758508',
'1784116152',
'1787322080',
'1790033162',
'1790141101',
'1790142533',
'1790143220',
'1790144591',
'1790146251',
'1790146771',
'1790147871',
'1790316847',
'1790478097',
'1798483171',
'1809505797',
'1809547128',
'1809562095',
'1809575333',
'1809581778',
'1809685201',
'1815357210',
'1815393852',
'1815987345',
'1815993784',
'1817291231',
'1817550136',
'1817678998',
'1817780617',
'1817823400',
'1817844890',
'1817845655',
'1817881574',
'1817885750',
'1817886428',
'1819116486',
'1825335942',
'1827868490',
'1832091538',
'1832130594',
'1832337741',
'1832977955',
'1836044796',
'1836475251',
'1836814227',
'1837186294',
'1841542473',
'1841647728',
'1841673768',
'1841689705',
'1841699925',
'1845659637',
'1847264026',
'1847265247',
'1847266234',
'1847302759',
'1847303952',
'1847305349',
'1847306594',
'1847962992',
'1847963106',
'1847968516',
'1847968609',
'1847968739',
'1847968973',
'1847969408',
'1847969690',
'1446833736',
'1446834063',
'1446834397',
'1446835223',
'1446835903',
'1446836812',
'1446837253',
'1446838080',
'1446838491',
'1446838770',
'1446839029',
'1446839593',
'1446839885',
'1446840385',
'1446841032',
'1446841385',
'1446841686',
'1446842051',
'1446842310',
'1446842941',
'1446843209',
'1446843501',
'1446843777',
'1446844148',
'1446846313',
'1446846609',
'1446846892',
'1446847156',
'1446847490',
'1446847793',
'1446848078',
'1447500472',
'1450438442',
'1450440552',
'1450441033',
'1450441693',
'1450442541',
'1450443219',
'1450707456',
'1450708559',
'1450709318',
'1450709791',
'1450710353',
'1450710837',
'1450711463',
'1450712012',
'1450712480',
'1450713062',
'1450713719',
'1450714544',
'1450715071',
'1450716020',
'1450716681',
'1450717128',
'1450717897',
'1450718561',
'1450718977',
'1450719505',
'1450719948',
'1450721556',
'1450722215',
'1450722879',
'1450723588',
'1450724248',
'1450724928',
'1450727686',
'1450728269',
'1450729170',
'1450754226',
'1450755089',
'1450755855',
'1450756552',
'1450757178',
'1450758085',
'1450759198',
'1450760081',
'1450761484',
'1450762996',
'1450763821',
'1450764521',
'1450765100',
'1450766089',
'1450766597',
'1450767130',
'1450767996',
'1450769615',
'1450776116',
'1450776746',
'1450778042',
'1450778636',
'1450779089',
'1450779968',
'1450780709',
'1450781164',
'1450781822',
'1450782402',
'1450783026',
'1450783457',
'1450786574',
'1450787152',
'1450787819',
'1450788434',
'1453782416',
'1453881114',
'1453881733',
'1453882455',
'1453884400',
'1453884971',
'1453885550',
'1453886439',
'1453887758',
'1453888284',
'1453888905',
'1453890141',
'1453891460',
'1453892703',
'1453893202',
'1453894177',
'1453895005',
'1453897108',
'1453898976',
'1453899545',
'1453900402',
'1453901349',
'1453901921',
'1453904260',
'1453904886',
'1453905643',
'1453906709',
'1453908102',
'1453908793',
'1453909718',
'1453910381',
'1453911831',
'1453912582',
'1453913755',
'1453914938',
'1453915475',
'1453916059',
'1453917324',
'1453924142',
'1453925347',
'1453926735',
'1453927706',
'1453928491',
'1453931016',
'1453931642',
'1453967785',
'1453969444',
'1453972936',
'1453973335',
'1453975040',
'1453978472',
'1453980826',
'1453981366',
'1453981812',
'1453982337',
'1453982779',
'1453984191',
'1453984573',
'1453984959',
'1453985280',
'1453986895',
'1453987189',
'1453987572',
'1453987944',
'1453988259',
'1453988960',
'1453989322',
'1453989701',
'1453990176',
'1453990572',
'1454150192',
'1458506748',
'1458811198',
'1458878230',
'1458892907',
'1458894822',
'1458895834',
'1458896679',
'1458897688',
'1458898659',
'1458899353',
'1458900723',
'1458901606',
'1458902250',
'1458902758',
'1458903406',
'1458904030',
'1458904922',
'1458905500',
'1458906642',
'1458907274',
'1458908447',
'1458909000',
'1458909766',
'1458910364',
'1458911179',
'1458911814',
'1458912345',
'1458912978',
'1458914578',
'1458915424',
'1458916233',
'1458916880',
'1458917418',
'1458918199',
'1459280475',
'1460334827',
'1460336531',
'1460338401',
'1460345055',
'1460346387',
'1461414990',
'1461415511',
'1461415893',
'1461416254',
'1461768257',
'1461769805',
'1461771614',
'1461772380',
'1461773162',
'1461774167',
'1461775088',
'1461775948',
'1461776714',
'1461778687',
'1461779468',
'1461780419',
'1461781039',
'1461781764',
'1461783622',
'1461784230',
'1461787871',
'1461788743',
'1461789445',
'1461790215',
'1461790887',
'1461792411',
'1461793278',
'1461796031',
'1461798419',
'1461799273',
'1461799918',
'1461800939',
'1461801917',
'1461805528',
'1461806268',
'1461807091',
'1461808325',
'1461809759',
'1461810459',
'1461811121',
'1461812132',
'1461812787',
'1461813292',
'1461871163',
'1461872446',
'1470279390',
'1470280440',
'1470281379',
'1470284397',
'1470285704',
'1470288437',
'1470290448',
'1470292525',
'1470297902',
'1470305236',
'1470308177',
'1470310279',
'1470312129',
'1470313517',
'1470317381',
'1470323842',
'1470325201',
'1470329285',
'1470340111',
'1470931867',
'1470933974',
'1470937459',
'1470938296',
'1470940506',
'1470941851',
'1470943790',
'1470945480',
'1470946425',
'1470947388',
'1470948556',
'1470949482',
'1470952864',
'1470957537',
'1470958725',
'1470960564',
'1470961451',
'1470963195',
'1470978719',
'1470982275',
'1470983545',
'1470985734',
'1470986987',
'1470988572',
'1470995995',
'1470997486',
'1470998910',
'1471000056',
'1471001081',
'1471002835',
'1471004300',
'1471006184',
'1471061131',
'1471062258',
'1471067121',
'1471096450',
'1471097440',
'1471106317',
'1471115619',
'1471116896',
'1471118332',
'1471120730',
'1471122020',
'1471122982',
'1471124095',
'1471125475',
'1471126433',
'1471127941',
'1471129011',
'1471130317',
'1471131279',
'1471133935',
'1471136157',
'1471137100',
'1471139816',
'1471140722',
'1471141881',
'1471142873',
'1471143766',
'1471144683',
'1471145939',
'1471146956',
'1471148924',
'1471150583',
'1471151846',
'1471155827',
'1471156828',
'1471158005',
'1471159133',
'1471159803',
'1471162499',
'1471164856',
'1471166126',
'1471167148',
'1471168275',
'1471171857',
'1471206795',
'1471208699',
'1471210289',
'1471211101',
'1471213248',
'1471214846',
'1471217884',
'1472461612',
'1472934513',
'1472935391',
'1472936604',
'1472937279',
'1472937951',
'1472938611',
'1472940236',
'1472943425',
'1472944018',
'1472945152',
'1472946652',
'1472947457',
'1472948451',
'1472949056',
'1472949649',
'1472951357',
'1476766644',
'1476769364',
'1476770150',
'1476771258',
'1476772395',
'1476773817',
'1476960177',
'1476960860',
'1476961875',
'1476962758',
'1478758678',
'1478913686',
'1479162808',
'1479163592',
'1479165429',
'1479171818',
'1479173619',
'1479179378',
'1479184319',
'1479196754',
'1479206427',
'1479211577',
'1479257520',
'1479263630',
'1479269196',
'1479272279',
'1479274839',
'1479277247',
'1479280466',
'1479284581',
'1479287024',
'1479293385',
'1479297812',
'1479304376',
'1483027268',
'1483030354',
'1483035069',
'1485627235',
'1493734383',
'1493737453',
'1493738886',
'1493739981',
'1493742925',
'1493743956',
'1493745083',
'1493746350',
'1495826903',
'1499393242',
'1499456941',
'1499459871',
'1499464848',
'1499467176',
'1506711865',
'1507687883',
'1507688990',
'1507690541',
'1507691831',
'1507692673',
'1507693589',
'1507694989',
'1507735920',
'1507763548',
'1507780370',
'1508518635',
'1508571130',
'1509393395',
'1509434554',
'1509447835',
'1509463029',
'1509472268',
'1516407340',
'1516408309',
'1516408916',
'1516409722',
'1516411036',
'1516411614',
'1516412273',
'1516414586',
'1516415416',
'1516415951',
'1516417469',
'1516418095',
'1516418526',
'1516420241',
'1516421279',
'1516423877',
'1516425216',
'1516425573',
'1516426086',
'1516426915',
'1516427778',
'1516428598',
'1516429360',
'1516432355',
'1516432839',
'1516433742',
'1516434934',
'1516438585',
'1516439937',
'1516441075',
'1516441696',
'1516442037',
'1516444338',
'1516444825',
'1516445405',
'1516445902',
'1516449189',
'1516449711',
'1516450110',
'1516450714',
'1516451228',
'1516451731',
'1516452427',
'1516453086',
'1516454098',
'1516454725',
'1516455178',
'1428122860',
'1428123799',
'1428124706',
'1428125428',
'1428125669',
'1428126592',
'1428127210',
'1428127934',
'1428128136',
'1428129572',
'1428130329',
'1428130846',
'1428131299',
'1428131490',
'1428886086',
'1429064882',
'1432117144',
'1432117500',
'1432118087',
'1432118271',
'1434083041',
'1434167914',
'1435235705',
'1437370503',
'1437792486',
'1437792899',
'1437793463',
'1437794044',
'1437794440',
'1437794806',
'1437795419',
'1437796013',
'1437796447',
'1437796775',
'1437797207',
'1437797597',
'1437797899',
'1437798469',
'1437798778',
'1437799221',
'1437799637',
'1437800258',
'1437800730',
'1437801376',
'1437801770',
'1437802282',
'1437803163',
'1437803566',
'1437803868',
'1437804183',
'1437804494',
'1437804873',
'1437805162',
'1437805567',
'1437805929',
'1437806245',
'1437806572',
'1437807794',
'1437808143',
'1437808879',
'1437809398',
'1437809771',
'1437810342',
'1437810680',
'1437811125',
'1437811523',
'1437812139',
'1437812570',
'1437812888',
'1437815038',
'1437815361',
'1437815882',
'1437816225',
'1437816708',
'1437817470',
'1437817878',
'1437818217',
'1437818666',
'1437819441',
'1437819812',
'1437820227',
'1437820986',
'1437821299',
'1437821783',
'1437900645',
'1437923648',
'1437924071',
'1437924631',
'1437925052',
'1437925489',
'1437926162',
'1437926590',
'1437927516',
'1437928261',
'1437928903',
'1437929357',
'1437929764',
'1437930409',
'1437930790',
'1437931101',
'1437932008',
'1437932486',
'1437933906',
'1437934325',
'1437935229',
'1437935565',
'1437935856',
'1437936298',
'1437936628',
'1437937013',
'1437938326',
'1437938884',
'1437939393',
'1437940125',
'1437941175',
'1437941559',
'1437942042',
'1437942413',
'1438135631',
'1438136134',
'1438136471',
'1438137369',
'1438137659',
'1438137993',
'1438140016',
'1438140433',
'1438140776',
'1438141163',
'1438141604',
'1438142000',
'1438144267',
'1438144584',
'1438145100',
'1438145557',
'1438146211',
'1438146674',
'1438147236',
'1438147586',
'1438148158',
'1438148543',
'1438148993',
'1438149299',
'1438149590',
'1438150234',
'1438150888',
'1438151465',
'1438151837',
'1442908276',
'1446607951',
'1446609279',
'1446614196',
'1446634118',
'1446634496',
'1446636815',
'1446637205',
'1446637876',
'1446638310',
'1446639058',
'1446640899',
'1446642013',
'1446642653',
'1446643270',
'1446644079',
'1446644523',
'1446644978',
'1446646402',
'1446646954',
'1446647566',
'1446648012',
'1446649013',
'1446649311',
'1446649833',
'1446650414',
'1446650822',
'1446651238',
'1446651791',
'1446652234',
'1446652637',
'1446652973',
'1446653455',
'1446654213',
'1446654779',
'1446655188',
'1446655586',
'1446655963',
'1446656322',
'1446656738',
'1446657071',
'1446657597',
'1446658523',
'1446658959',
'1446691636',
'1446692024',
'1446692411',
'1446693131',
'1446693733',
'1446694253',
'1446694919',
'1446695647',
'1446781121',
'1446781542',
'1446781946',
'1446782369',
'1446782850',
'1446783603',
'1446784025',
'1446784388',
'1446784828',
'1446785246',
'1446785675',
'1446786037',
'1446786819',
'1446787230',
'1446787625',
'1446788345',
'1446788655',
'1446789092',
'1446790310',
'1446790710',
'1446791066',
'1446791505',
'1446792091',
'1446792527',
'1446792938',
'1446793275',
'1446793700',
'1446794046',
'1446794521',
'1446795070',
'1446798309',
'1446798795',
'1446799283',
'1446799728',
'1446800318',
'1446800859',
'1446801415',
'1446801805',
'1446805131',
'1446805640',
'1446806180',
'1446806873',
'1446808686',
'1446809048',
'1446809355',
'1446809785',
'1446810081',
'1446825713',
'1446826164',
'1446826564',
'1446827048',
'1446827968',
'1446828439',
'1446829112',
'1446829374',
'1446829951',
'1446830802',
'1446831065',
'1446831373',
'1446832536',
'1446833330',
'4097948150334601716',
'7093755696339745353',
'10650404137285322437',
'13842558989194934838',
'14126606786301149442',
'16045578395448249926')

		AND a.score>0
GROUP BY 1,2
		


/*
刘冠南
*/


SELECT A.*,
		A.下单人数/B.访问uv AS '下单转化率',
		A.新用户数/A.下单人数 AS '新顾客占比',
		B.*,
		C.*
FROM
(SELECT CONCAT('#',b.wid) AS '商户ID',
		b.busi_name AS '商户名称',
		b.city_real AS '城市',
		a.order_day_key AS '日期',
		SUM(a.real_total_price/1000) AS '惠前流水',
		SUM(a.price/1000) AS '惠后流水',
		COUNT(a.order_id) AS '下单数量',
		COUNT(DISTINCT a.pass_uid) AS '下单人数',
		COUNT(DISTINCT IF(a.order_id = 9, a.pass_uid, NULL)) AS '成交顾客数',
		COUNT(CASE WHEN anticheat_new_user_flag = 1 THEN pass_uid ELSE NULL END) AS '新用户数'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.order_day_key BETWEEN 20171001 AND 20171031
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.wid IN ('1429317493',
'1429878286',
'1442505936',
'1524735093',
'1529230105',
'1546208237',
'1546214052',
'1546451782',
'1546452851',
'1546457103',
'1585590478',
'1799385595',
'1800442010',
'1809088102',
'1980617526',
'2082992649',
'718073887338382185',
'1547847315966109277',
'2935296641594856952',
'7922143909066445526',
'12962541624983573616',
'14250232833189333317',
'17718131143106407345',
'15626445299430076592',
'16308923615142760408')
GROUP BY 1,2,3,4)A

JOIN

(SELECT CONCAT('#',b.wid ) AS shanghuid,
		c.shop_day_key AS riqi,
		SUM(c.shop_uv) AS '访问uv',
		SUM(c.shop_baoguang_uv) AS '曝光uv',
		SUM(c.shop_pv) AS '访问pv',
		SUM(c.shop_baoguang_pv) AS '曝光pv',
		SUM(c.shop_uv)/SUM(shop_baoguang_uv) AS '访问转化率'
		
	FROM fact_business c
	LEFT JOIN dim_business b ON b.shop_id = c.shop_id
	WHERE c.shop_day_key BETWEEN 20171001 AND 20171031
		AND c.status = 1
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.wid IN ('1429317493',
'1429878286',
'1442505936',
'1524735093',
'1529230105',
'1546208237',
'1546214052',
'1546451782',
'1546452851',
'1546457103',
'1585590478',
'1799385595',
'1800442010',
'1809088102',
'1980617526',
'2082992649',
'718073887338382185',
'1547847315966109277',
'2935296641594856952',
'7922143909066445526',
'12962541624983573616',
'14250232833189333317',
'17718131143106407345',
'15626445299430076592',
'16308923615142760408')
		
GROUP BY 1,2)B ON A.商户ID = B.shanghuid AND A.日期 = B.riqi

JOIN

(SELECT  CONCAT('#',T.wid) AS shanghuid, 
		T.order_day_key AS riqi,
		SUM(if(t1>=2,1,0)) AS '复购人数',
		 SUM(if(t1>=2 , 1, 0))/COUNT (pass_uid) AS '复购率'
    FROM 
        (SELECT a1.pass_uid, a1.wid, a1.order_day_key,
         COUNT (a1.order_id) t1
         FROM fact_order a1 
		 LEFT JOIN dim_business b ON a1.shop_id = b.shop_id
		 WHERE	a1.order_day_key BETWEEN 20171001 AND 20171031
                AND a1.break_type=0
				AND b.wid IN('1429317493',
'1429878286',
'1442505936',
'1524735093',
'1529230105',
'1546208237',
'1546214052',
'1546451782',
'1546452851',
'1546457103',
'1585590478',
'1799385595',
'1800442010',
'1809088102',
'1980617526',
'2082992649',
'718073887338382185',
'1547847315966109277',
'2935296641594856952',
'7922143909066445526',
'12962541624983573616',
'14250232833189333317',
'17718131143106407345',
'15626445299430076592',
'16308923615142760408')
                AND b.is_test=0
				AND b.is_delete = 0
        GROUP BY  1,2,3) T GROUP BY 1,2)C ON A.商户id = C.shanghuid AND A.日期 = C.riqi
		




/*
王雪伟 满减商户|满减商户覆盖率
*/


SELECT DISTINCT CONCAT('#',b.wid) AS '商户ID',
		b.busi_name AS '商户名称',
		CONCAT('#',b.supplier_id) AS '供应商ID',
		d.name AS '供应商名称',
		e.sale_name AS '销售',
		(CASE WHEN c.is_shop_canjian = 1 AND c.type = 'jian' THEN 1
		ELSE 0 END) AS '是否满减商户',
		(CASE WHEN b.sys_status IN (0,6,13,14,15) THEN '上线状态'
		ELSE '其他' END) AS '商户状态'
FROM dim_business b 
LEFT JOIN fact_shop_all_activity c ON b.waimai_release_id = c.waimai_release_id
LEFT JOIN dim_supplier d ON b.supplier_id = d.supplier_id
LEFT JOIN dim_order_sale_id e ON e.sale_id = b.sales_id
WHERE b.ka_extend_lable_id IN (9,11)
	AND b.is_test = 0
	AND b.is_delete = 0
	AND b.city_real = '北京'
	AND c.index_day = 20171105




/*
王雪伟 合同折扣类型=抽佣类型
*/




SELECT CONCAT('#',b.wid) AS '商户ID',
		b.busi_name AS '商户名称',
		b.ka_brand AS '品牌',
		b.aoi AS '商圈',
		CONCAT('#',b.supplier_id) AS '供应商ID',
		c.yakuan_type AS '押款方式',
		c.hetong_zhekou AS '合同折扣',
		c.guarantee_value AS '保底抽佣金额',
		e.sale_name AS '销售',
		b.delivery_party AS '配送方',
		c.hetong_zhekou_type AS '抽佣类型'
FROM fact_supplier c 
LEFT JOIN dim_business b ON b.supplier_id = c.supplier_id
LEFT JOIN dim_order_sale_id e ON e.sale_id = b.sales_id
WHERE b.is_delete = 0
	AND b.is_test = 0
	AND b.ka_extend_lable_id IN (9,11)
	AND supplier_day_key = 20171105



/*
余刚
*/




SELECT
	CONCAT('#', CAST(a.order_id AS STRING)) AS '订单ID',
	CONCAT('#', a.pass_uid) AS '用户ID',
	CONCAT('#', c.supplier_id) AS '供应商id',
	b.busi_name AS '商户名称',
	a.order_day_key AS '日期',
	b.city_real AS '城市',
	a.real_total_price/1000 AS '原价',
	d.score AS '评分',
	a.service_score AS '配送评分',
	d.content AS '评价',
	a.order_time AS '下单时间'
FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id 
	LEFT JOIN comment_content_new d ON a.order_id = d.order_id
	LEFT JOIN dim_supplier c ON b.supplier_id = c.supplier_id
WHERE a.order_status = 9 
	AND a.break_type = 0
	AND b.is_delete = 0 
    AND b.is_test = 0
	AND a.order_day_key BETWEEN 20171001 AND 20171031 
	AND d.score > 0 
	AND a.service_score > 0
	AND c.supplier_id IN('1436138230','1935604268','1935608451','1935619743','1935636178','1935694679','1935702058')






/*
张亚辉,全城送
*/




SELECT A.*,
		B.*,
		C.*
FROM
(SELECT a.order_day_key AS '日期',
		CONCAT('#',b.wid) AS '商户id',
		b.busi_name AS '商户名称',
		COUNT(a.order_id) AS '总订单量',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '完成单量',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0)) AS '惠前流水',
		SUM(IF(a.order_status = 9, a.price/1000, 0)) AS '惠后流水',
		COUNT(CASE WHEN anticheat_new_user_flag = 1 THEN pass_uid ELSE null END) AS '新用户',
		COUNT(DISTINCT IF(anticheat_new_user_flag != 1, pass_uid,NULL)) AS '老用户',
		SUM(case when a.shop_butie>0 AND a.order_status = 9 then a.shop_butie/1000 else 0 end)
			+ SUM(case when shop_quan_price>0 AND a.order_status = 9 then a.shop_quan_price/1000 else 0 end) AS '商户补贴',
		SUM(case when a.discount_baidufee_price>0  AND a.order_status = 9 then a.discount_baidufee_price/1000  else 0 end) 
			+ SUM(case when a.quan_price>0  AND a.order_status = 9 then a.quan_price/1000 else 0 end) AS '百度补贴'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND b.is_delete = 0
		AND b.is_test = 0
		AND a.order_day_key BETWEEN 20171025 AND 20171107
		AND b.wid IN ('1542665228',
'1542665603',
'1542666041',
'1542666717',
'1542667259',
'1542667846',
'1542668465',
'1542668906',
'1542669334',
'1542669937',
'1542670373',
'1542670733',
'1542671156',
'1554587609',
'1557173891',
'1661352906',
'1661354896',
'1686023122',
'1752550465',
'1808150712',
'1836304305',
'1836315532',
'1928192656',
'1928205132',
'1928212353',
'1928217756',
'1957233363',
'1983865226',
'1983886015',
'2018042465',
'2113492906',
'2131120020')

GROUP BY 1,2,3)A

JOIN

(SELECT c.shop_day_key AS riqi,
		CONCAT('#',b.wid) AS shanghuid,
		b.busi_name AS shanghumingcheng,
		SUM(c.shop_uv) AS '访问uv',
		SUM(c.shop_baoguang_uv) AS '曝光uv',
		SUM(c.shop_pv) AS '访问pv',
		SUM(c.shop_baoguang_pv) AS '曝光pv'
	FROM fact_business c
	LEFT JOIN dim_business b ON c.shop_id = b.shop_id
	WHERE c.status = 1
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.wid IN ('1542665228',
'1542665603',
'1542666041',
'1542666717',
'1542667259',
'1542667846',
'1542668465',
'1542668906',
'1542669334',
'1542669937',
'1542670373',
'1542670733',
'1542671156',
'1554587609',
'1557173891',
'1661352906',
'1661354896',
'1686023122',
'1752550465',
'1808150712',
'1836304305',
'1836315532',
'1928192656',
'1928205132',
'1928212353',
'1928217756',
'1957233363',
'1983865226',
'1983886015',
'2018042465',
'2113492906',
'2131120020')
		AND c.shop_day_key BETWEEN 20171025 AND 20171107
GROUP BY 1,2,3)B ON A.日期 = B.riqi AND A.商户id = B.shanghuid

JOIN
(SELECT a.order_day_key AS riqi,
		CONCAT('#',b.wid) AS shanghuid,
		COUNT(a.order_id) AS '全城送单量'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
	AND a.order_status = 9
	AND b.is_delete = 0
	AND b.is_test = 0
	AND a.order_day_key BETWEEN 20171025 AND 20171107
	AND a.order_id 
		IN(SELECT a.out_order_id
		FROM fact_wuliu_order a
		WHERE a.order_status = 9
			AND a.order_type = 1004
			AND a.order_day_key BETWEEN 20171025 AND 20171107
			)
	AND b.wid IN ('1542665228',
'1542665603',
'1542666041',
'1542666717',
'1542667259',
'1542667846',
'1542668465',
'1542668906',
'1542669334',
'1542669937',
'1542670373',
'1542670733',
'1542671156',
'1554587609',
'1557173891',
'1661352906',
'1661354896',
'1686023122',
'1752550465',
'1808150712',
'1836304305',
'1836315532',
'1928192656',
'1928205132',
'1928212353',
'1928217756',
'1957233363',
'1983865226',
'1983886015',
'2018042465',
'2113492906',
'2131120020')
GROUP BY 1,2) C ON A.日期 = C.riqi AND A.商户id = C.shanghuid




/*
罗文强
*/




SELECT A.*,
		D.活动商户数,
		B.*,
		A.出单商户数/B.在线合作商户数 AS '动销率',
		C.*
FROM
(SELECT a.order_day_key AS '日期',
		b.city_real AS '城市',
		COUNT(a.order_id) AS '订单量',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '完成单量',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0)) AS '惠前流水',
		COUNT(DISTINCT a.waimai_release_id) AS '出单商户数',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价',
		SUM(case when a.shop_butie>0 AND a.order_status = 9 then a.shop_butie/1000 else 0 end)
			+ SUM(case when shop_quan_price>0 AND a.order_status = 9 then a.shop_quan_price/1000 else 0 end) AS '商户补贴',
		SUM(case when a.discount_baidufee_price>0  AND a.order_status = 9 then a.discount_baidufee_price/1000  else 0 end) 
			+ SUM(case when a.quan_price>0  AND a.order_status = 9 then a.quan_price/1000 else 0 end) AS '百度补贴' ,
		COUNT(CASE WHEN anticheat_new_user_flag = 1 THEN pass_uid ELSE null END) AS '新用户'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND b.is_delete = 0
		AND b.is_test = 0
		AND a.order_day_key BETWEEN 20170801 AND 20171031
		AND a.supplier_id = '10401283526486593987'
GROUP BY 1,2)A

JOIN

(SELECT c.shop_day_key AS yuefen,
		b.city_real,
		COUNT(DISTINCT IF(c.sys_status IN (0,6,13,14,15), c.waimai_release_id, NULL)) AS '在线合作商户数',
		SUM(c.shop_uv) AS '访问uv',
		SUM(c.shop_baoguang_uv) AS '曝光uv',
		SUM(c.shop_pv) AS '访问pv',
		SUM(c.shop_baoguang_pv) AS '曝光pv'
	FROM fact_business c
	LEFT JOIN dim_business b ON c.shop_id = b.shop_id
	WHERE c.status = 1
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id = '10401283526486593987'
		AND c.shop_day_key BETWEEN 20170801 AND 20171031
GROUP BY 1,2)B ON A.日期 = B.yuefen AND A.城市 = B.city_real

JOIN 

(SELECT d.make_date_key AS yuefen,
		b.city_real,
		SUM(IF(d.source = 'baidu', d.liushui_fee, 0))/sum(d.liushui_fee) AS '百度市占',
		SUM(IF(d.source = 'meituan', d.liushui_fee, 0))/SUM(d.liushui_fee) AS '美团市占',
		SUM(IF(d.source = 'ele', d.liushui_fee, 0))/SUM(d.liushui_fee) AS '饿了么市占'
	FROM fact_shop_all d
	LEFT JOIN dim_business b ON d.merge_shop_id = b.wid
	WHERE d.make_date_key BETWEEN 20170801 AND 20171031
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id = '10401283526486593987'
GROUP BY 1,2)C ON A.日期 = C.yuefen AND A.城市 = C.city_real

JOIN

(select a.index_day AS yuefen,
		b.city_real,
		count(distinct a.waimai_release_id)'活动商户数'
from fact_shop_all_activity a 
join dim_business b on a.waimai_release_id=b.waimai_release_id
where a.index_day between 20170801 and 20171031 
	and a.is_shop_canjian=1 
	and b.sys_status in (0,6,13,14,15) 
	and b.is_delete=0 
	and b.is_test=0 
	AND b.supplier_id = '10401283526486593987'
group by 1,2)D ON A.日期 = D.yuefen AND A.城市 = D.city_real	




/*
王新
*/


--押物流款商户

SELECT * FROM
(SELECT CONCAT('#',b.wid) AS '商户ID',
		b.busi_name AS '商户名称',
		b.aoi AS '商圈',
		c.yakuan_type AS '押款方式',
		e.sale_name AS '销售'
FROM fact_supplier c 
LEFT JOIN dim_business b ON b.supplier_id = c.supplier_id
LEFT JOIN dim_order_sale_id e ON e.sale_id = b.sales_id
WHERE b.is_delete = 0
	AND b.is_test = 0
	AND supplier_day_key BETWEEN 20171001 AND 20171031
	AND b.city_real = '北京'
	AND c.yakuan_type = 'logistics')A
JOIN
(SELECT CONCAT('#',b.wid) AS shanghuid,
		SUM(a.real_total_price/1000) AS '流水'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.order_status = 9
		AND a.order_day_key BETWEEN 20171001 AND 20171031
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.city_real = '北京'
	GROUP BY 1)B ON A.商户ID = B.shanghuid
	
	
	
	
--北京全量，可开通全城送商户	
	
	
SELECT * FROM	
(SELECT CONCAT('#',b.wid) AS '商户ID',
		b.busi_name AS '商户名称',
		(case when b.ka_extend_lable_id in(1,2,8)    then 'NKA'
  when b.ka_extend_lable_id in (9,11)   then 'LKA'
  when b.ka_extend_lable_id in (-1,0,6) then  '非KA'
  when b.ka_extend_lable_id = 3         then '质享生活' 
  when b.ka_extend_lable_id = 4         then '生鲜'
  when b.ka_extend_lable_id = 5         then '商超'
  when b.ka_extend_lable_id = 7         then '药品'
  when b.ka_extend_lable_id = 10        then '生态链'
  else 'others' end) as 'KA标签',
		c.guarantee_value AS '保底抽佣金额'
FROM fact_supplier c 
LEFT JOIN dim_business b ON b.supplier_id = c.supplier_id
LEFT JOIN dim_order_sale_id e ON e.sale_id = b.sales_id
WHERE b.is_delete = 0
	AND b.is_test = 0
	AND supplier_day_key = 20171107
	AND b.city_real = '北京')A
	
JOIN
	
(SELECT CONCAT('#',b.wid) AS shanghuid,
		c.delivery_party_name AS '配送方式',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价',
		sum( a.product_price-a.after_discount_price)/sum(if(chouyong_type=1,product_price+box_price-shop_butie-coalesce (shop_quan_price,0),product_price)) AS '折扣率'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	LEFT JOIN dim_order_delivery_party c ON b.delivery_party = c.delivery_party
	WHERE a.break_type = 0
		AND a.order_status = 9
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.city_real = '北京'
		AND a.order_day_key = 20171107
	GROUP BY 1,2)B ON A.商户ID = B.shanghuid
	




/*
活动
*/



select *
FROM (SELECT a.order_day_key day,
CASE
WHEN b.ka_extend_lable_id in(-1,0,6) THEN
'非ka'
WHEN b.ka_extend_lable_id in(9,1,2,8) THEN
'ka'
ELSE '其他'
END type,
concat('#',b.wid) wid,
b.busi_name, 
b.aoi '商圈',
b.area '星系',
d.city_region '大区',
sum(if(a.order_status=9,a.real_total_price/1000,0)) liushui,
sum(if(a.order_status=9,a.price/1000,0)) liushuihou,
count( if(a.order_status=9
AND a.anticheat_new_user_flag=1,a.pass_uid,null)) AS xinke, 
count(distinct if(a.order_status=9
AND a.anticheat_new_user_flag=0,a.pass_uid,null)) laoke,
count(if(a.order_status=9,a.order_id,null)) wanchengdan,
count(a.order_id) xiadan,(sum(if(a.shop_butie>0
AND a.order_status=9 ,a.shop_butie,0))+sum(if (a.shop_quan_price>0
AND a.order_status=9 ,a.shop_quan_price,0)))/1000 shanghubutie
FROM
dim_business b LEFT JOIN dim_aoi d
ON b.aoi_id=d.aoi_id left join fact_order a 
ON a.shop_id=b.shop_id
where b.is_test=0
AND b.is_delete=0
AND b.city_real IN ('北京') and b.wid in (select  waimai_release_id
from fact_shop_all_activity
where index_day between 20170407
AND 20170409 and is_shop_canjian=1 and activity_id in ('cp267314','cp267314','cp267309','cp260904','cp260890','cp260884','cp260881') )
AND a.order_day_key
BETWEEN 20170331
AND 20170409
GROUP BY 
1,2,3,4,5,6,7) j
LEFT JOIN (SELECT a.shop_day_key day,
concat('#',b.wid) wid,
sum(a.shop_baoguang_uv) AS baoguanguv, 
sum(a.shop_baoguang_pv) AS baoguangpv,
sum(a.shop_uv) uv,
sum(a.shop_pv) pv
FROM fact_business a,dim_business b
WHERE a.shop_id=b.shop_id
AND a.shop_day_key
BETWEEN 20170331
AND 20170409
AND b.is_delete =0
AND b.is_test =0
AND b.city_real='北京'
GROUP BY 
1,2) z
ON z.day=j.day
AND z.wid=j.wid





/*
北京押物流款
*/




SELECT A.*,
		B.*
FROM
(SELECT CONCAT('#',b.wid) AS '商户ID', 
	b.busi_name AS '商户名称', 
	(case
    WHEN b.ka_extend_lable_id in(1,2,8) THEN
    'NKA'
    WHEN b.ka_extend_lable_id IN (9,11) THEN
    'LKA'
    WHEN b.ka_extend_lable_id IN (-1,0,6) THEN
    '非KA'
    WHEN b.ka_extend_lable_id = 3 THEN
    '质享生活'
    WHEN b.ka_extend_lable_id = 4 THEN
    '生鲜'
    WHEN b.ka_extend_lable_id = 5 THEN
    '商超'
    WHEN b.ka_extend_lable_id = 7 THEN
    '药品'
    WHEN b.ka_extend_lable_id = 10 THEN
    '生态链'
    ELSE '其他' end) AS 'KA标签', 
	(CASE
    WHEN d.supplier_id <> '0' THEN
    c.guarantee_value
    WHEN d.supplier_id = '0' THEN
    d.guarantee_value END)AS '保底抽佣金额', 
	(CASE
    WHEN d.supplier_id <> '0' THEN
    c.hetong_zhekou
    WHEN d.supplier_id = '0' THEN
    d.hetong_zhekou END)AS '抽佣比例',
	(CASE 
	WHEN d.supplier_id <> '0' THEN 
	c.yakuan_type 
	WHEN d.supplier_id = '0' THEN 
	d.yakuan_type END) AS '押款方式',
	e.sale_name AS '销售',
	b.aoi AS '商圈',
	split_part(b.area,'（',1) AS '星系',
	split_part(b.area,'（',2) AS 'aoi所在区域'
FROM fact_business d
LEFT JOIN dim_business b
    ON b.shop_id = d.shop_id LEFT JOIN
    (SELECT supplier_id,
        hetong_zhekou,
        guarantee_value,
		yakuan_type
    FROM fact_supplier
    WHERE supplier_day_key = 20171107) c
    ON c.supplier_id = d.supplier_id
LEFT JOIN dim_order_sale_id e ON e.sale_id = b.sales_id
WHERE b.is_delete = 0
        AND b.is_test = 0
        AND d.shop_day_key = 20171107
        AND d.status = 1
        AND d.sys_status IN (0,6,13,14,15)
        AND b.city_real = '北京')A
LEFT JOIN 
(SELECT CONCAT('#',b.wid) AS shanghuid,
		SUM(a.real_total_price/1000) AS '流水'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.order_status = 9
		AND a.order_day_key BETWEEN 20171001 AND 20171031
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.city_real = '北京'
	GROUP BY 1)B ON A.商户ID = B.shanghuid 
WHERE A.押款方式 = 'logistics'




/*
蒋宁
*/


--城市数据

SELECT A.*,
		B.*,
		D.出单商户数,
		D.出单商户数/B.在线合作商户数 AS '动销率',
		C.*
FROM
(SELECT FLOOR(a.order_day_key/100) AS '月份',
		b.city_real AS '城市',
		CONCAT('#',b.supplier_id) AS '供应商id',
		c.name AS '供应商名称',
		COUNT(a.order_id) AS '订单量',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '完成单量',
		COUNT(IF(a.order_status = 9, a.order_id, NULL))/COUNT(a.order_id) AS '完成单率',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0)) AS '惠前流水',

		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价',
		SUM(case when a.shop_butie>0 AND a.order_status = 9 then a.shop_butie/1000 else 0 end)
			+ SUM(case when shop_quan_price>0 AND a.order_status = 9 then a.shop_quan_price/1000 else 0 end) AS '商户补贴',
		SUM(case when a.discount_baidufee_price>0  AND a.order_status = 9 then a.discount_baidufee_price/1000  else 0 end) 
			+ SUM(case when a.quan_price>0  AND a.order_status = 9 then a.quan_price/1000 else 0 end) AS '百度补贴' ,
		COUNT(CASE WHEN anticheat_new_user_flag = 1 THEN pass_uid ELSE null END) AS '新用户',
		COUNT(DISTINCT a.pass_uid) AS '品牌客户数',
		AVG(a.songda_time) AS '平均送达时间'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	LEFT JOIN dim_supplier c ON b.supplier_id = c.supplier_id
	WHERE a.break_type = 0
		AND b.is_delete = 0
		AND b.is_test = 0
		AND a.order_day_key BETWEEN 20170101 AND 20171031
		AND a.supplier_id IN(
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
--西贝
'1944172822',
'1828722691',
'1828712934',
'1828695538',
'1826195666',
'1791836585',
'1772120697',
'1706956039',
'1692119755',
'1692118769',
'1692117425',
'1689351266',
'1689349844',
'1689347066',
'1687404761',
'1681787593',
'1649270414',
'1631516241',
'1630610934',
'1536585051',
'1533542641',
'1519085574',
'1460857627',
'5304472885356431750',
'3781820142968912382',
'5809408069271893462',
--望湘园
'16360118144930183667',
'1898125827',
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
'1738768850',
'1674587435',
'1540591903',
'1451155183',
'1444853221',
'1427894810',
--眉州集团
'1438358754',
'1436139796',
--棒约翰
'2070057419',
'2025887316',
'1997339390',
'1646370652',
--DQ
'1950824726',
'1935824883',
'1935699667',
'1917835065',
'1917833152',
'1819779837',
'1612467510',
'1600404214',
--正一味
'3972519162584539390'
)

GROUP BY 1,2,3,4)A

LEFT JOIN

(SELECT FLOOR(c.shop_day_key/100) AS yuefen,
		b.city_real,
		COUNT(DISTINCT IF(c.sys_status IN (0,6,13,14,15), c.waimai_release_id, NULL)) AS '在线合作商户数',
		SUM(c.shop_uv) AS '访问uv',
		SUM(c.shop_baoguang_uv) AS '曝光uv',
		SUM(c.shop_pv) AS '访问pv',
		SUM(c.shop_baoguang_pv) AS '曝光pv'
	FROM fact_business c
	LEFT JOIN dim_business b ON c.shop_id = b.shop_id
	WHERE c.status = 1
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id IN (
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
--西贝
'1944172822',
'1828722691',
'1828712934',
'1828695538',
'1826195666',
'1791836585',
'1772120697',
'1706956039',
'1692119755',
'1692118769',
'1692117425',
'1689351266',
'1689349844',
'1689347066',
'1687404761',
'1681787593',
'1649270414',
'1631516241',
'1630610934',
'1536585051',
'1533542641',
'1519085574',
'1460857627',
'5304472885356431750',
'3781820142968912382',
'5809408069271893462',
--望湘园
'16360118144930183667',
'1898125827',
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
'1738768850',
'1674587435',
'1540591903',
'1451155183',
'1444853221',
'1427894810',
--眉州集团
'1438358754',
'1436139796',
--棒约翰
'2070057419',
'2025887316',
'1997339390',
'1646370652',
--DQ
'1950824726',
'1935824883',
'1935699667',
'1917835065',
'1917833152',
'1819779837',
'1612467510',
'1600404214',
--正一味
'3972519162584539390'
)
		AND c.shop_day_key BETWEEN 20170101 AND 20171031
GROUP BY 1,2)B ON A.月份 = B.yuefen AND A.城市 = B.city_real

LEFT JOIN 

(SELECT FLOOR(d.make_date_key/100) AS yuefen,
		b.city_real,
		SUM(IF(d.source = 'baidu', d.liushui_fee, 0))/sum(d.liushui_fee) AS '百度市占',
		SUM(IF(d.source = 'meituan', d.liushui_fee, 0))/SUM(d.liushui_fee) AS '美团市占',
		SUM(IF(d.source = 'ele', d.liushui_fee, 0))/SUM(d.liushui_fee) AS '饿了么市占'
	FROM fact_shop_all d
	LEFT JOIN dim_business b ON d.merge_shop_id = b.wid
	WHERE d.make_date_key BETWEEN 20170101 AND 20171031
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id IN (
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
--西贝
'1944172822',
'1828722691',
'1828712934',
'1828695538',
'1826195666',
'1791836585',
'1772120697',
'1706956039',
'1692119755',
'1692118769',
'1692117425',
'1689351266',
'1689349844',
'1689347066',
'1687404761',
'1681787593',
'1649270414',
'1631516241',
'1630610934',
'1536585051',
'1533542641',
'1519085574',
'1460857627',
'5304472885356431750',
'3781820142968912382',
'5809408069271893462',
--望湘园
'16360118144930183667',
'1898125827',
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
'1738768850',
'1674587435',
'1540591903',
'1451155183',
'1444853221',
'1427894810',
--眉州集团
'1438358754',
'1436139796',
--棒约翰
'2070057419',
'2025887316',
'1997339390',
'1646370652',
--DQ
'1950824726',
'1935824883',
'1935699667',
'1917835065',
'1917833152',
'1819779837',
'1612467510',
'1600404214',
--正一味
'3972519162584539390'
)
GROUP BY 1,2)C ON A.月份 = C.yuefen AND A.城市 = C.city_real

LEFT JOIN
(SELECT FLOOR(a.order_day_key/100) AS yuefen,
		b.city_real,
		COUNT(DISTINCT a.waimai_release_id) AS '出单商户数'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND b.is_delete = 0
		AND b.is_test = 0
		AND a.order_day_key BETWEEN 20170101 AND 20171031
		AND a.supplier_id IN(
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
--西贝
'1944172822',
'1828722691',
'1828712934',
'1828695538',
'1826195666',
'1791836585',
'1772120697',
'1706956039',
'1692119755',
'1692118769',
'1692117425',
'1689351266',
'1689349844',
'1689347066',
'1687404761',
'1681787593',
'1649270414',
'1631516241',
'1630610934',
'1536585051',
'1533542641',
'1519085574',
'1460857627',
'5304472885356431750',
'3781820142968912382',
'5809408069271893462',
--望湘园
'16360118144930183667',
'1898125827',
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
'1738768850',
'1674587435',
'1540591903',
'1451155183',
'1444853221',
'1427894810',
--眉州集团
'1438358754',
'1436139796',
--棒约翰
'2070057419',
'2025887316',
'1997339390',
'1646370652',
--DQ
'1950824726',
'1935824883',
'1935699667',
'1917835065',
'1917833152',
'1819779837',
'1612467510',
'1600404214',
--正一味
'3972519162584539390'
)

GROUP BY 1,2)D ON A.月份 = D.yuefen AND A.城市 = D.city_real
	
--性别分布	
SELECT A.*,
		B.*
FROM
(SELECT FLOOR(a.order_day_key/100) AS '月份',
		CONCAT('#',b.supplier_id) AS '供应商id',
		c.name AS '供应商名称',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '订单量',
		COUNT(IF(a.sex = 1 AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '男用户比例',
		COUNT(IF(a.sex = 2 AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '女用户比例',
		COUNT(IF(a.order_time >= '00:00' AND a.order_time < '02:00' AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '下单时间0:00-2:00比例',
		COUNT(IF(a.order_time >= '02:00' AND a.order_time < '04:00' AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '下单时间2:00-4:00比例',
		COUNT(IF(a.order_time >= '04:00' AND a.order_time < '06:00' AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '下单时间4:00-6:00比例',
		COUNT(IF(a.order_time >= '06:00' AND a.order_time < '08:00' AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '下单时间6:00-8:00比例',
		COUNT(IF(a.order_time >= '08:00' AND a.order_time < '10:00' AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '下单时间8:00-10:00比例',
		COUNT(IF(a.order_time >= '10:00' AND a.order_time < '12:00' AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '下单时间10:00-12:00比例',
		COUNT(IF(a.order_time >= '12:00' AND a.order_time < '14:00' AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '下单时间12:00-14:00比例',
		COUNT(IF(a.order_time >= '14:00' AND a.order_time < '16:00' AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '下单时间14:00-16:00比例',
		COUNT(IF(a.order_time >= '16:00' AND a.order_time < '18:00' AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '下单时间16:00-18:00比例',
		COUNT(IF(a.order_time >= '18:00' AND a.order_time < '20:00' AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '下单时间18:00-20:00比例',
		COUNT(IF(a.order_time >= '20:00' AND a.order_time < '22:00' AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '下单时间20:00-22:00比例',
		COUNT(IF(a.order_time >= '22:00' AND a.order_time < '24:00' AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '下单时间22:00-24:00比例',
		COUNT(IF(a.real_total_price/1000 <= 30 AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价(0,30]比例',
		COUNT(IF(a.real_total_price/1000 <= 50 AND a.real_total_price/1000 > 30 AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价(30,50]比例',
		COUNT(IF(a.real_total_price/1000 <= 70 AND a.real_total_price/1000 > 50 AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价(50,70]比例',
		COUNT(IF(a.real_total_price/1000 <= 90 AND a.real_total_price/1000 > 70 AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价(70,90]比例',
		COUNT(IF(a.real_total_price/1000 <= 120 AND a.real_total_price/1000 > 90 AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价(90,120]比例',
		COUNT(IF(a.real_total_price/1000 > 120 AND a.order_status = 9, a.order_id, NULL))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价(120,∞)比例'
			
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	LEFT JOIN dim_supplier c ON a.supplier_id = c.supplier_id
	WHERE a.break_type = 0
		AND b.is_delete = 0
		AND b.is_test = 0
		AND a.order_day_key BETWEEN 20170101 AND 20171031
		AND b.supplier_id IN (
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
--西贝
'1944172822',
'1828722691',
'1828712934',
'1828695538',
'1826195666',
'1791836585',
'1772120697',
'1706956039',
'1692119755',
'1692118769',
'1692117425',
'1689351266',
'1689349844',
'1689347066',
'1687404761',
'1681787593',
'1649270414',
'1631516241',
'1630610934',
'1536585051',
'1533542641',
'1519085574',
'1460857627',
'5304472885356431750',
'3781820142968912382',
'5809408069271893462',
--望湘园
'16360118144930183667',
'1898125827',
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
'1738768850',
'1674587435',
'1540591903',
'1451155183',
'1444853221',
'1427894810',
--眉州集团
'1438358754',
'1436139796',
--棒约翰
'2070057419',
'2025887316',
'1997339390',
'1646370652',
--DQ
'1950824726',
'1935824883',
'1935699667',
'1917835065',
'1917833152',
'1819779837',
'1612467510',
'1600404214',
--正一味
'3972519162584539390'
)
GROUP BY 1,2,3)A

LEFT JOIN
		
(select *
from 
(select *,ROW_NUMBER() OVER(PARTITION BY T1.供应商ID ORDER BY T1.销量 desc) paixu
from 
(
select FLOOR(d.order_day_key/100) AS '月份',
	concat('#',b2.supplier_id) as '供应商ID',
	d.caipin_name,
	sum(d.number) as '销量'
from 
	dim_business b2 
	left join fact_caipin_details d on b2.shop_id=d.shop_id
where 
	b2.is_test=0 and b2.is_delete=0 
	and d.order_status=9
	and b2.supplier_id IN (
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
--西贝
'1944172822',
'1828722691',
'1828712934',
'1828695538',
'1826195666',
'1791836585',
'1772120697',
'1706956039',
'1692119755',
'1692118769',
'1692117425',
'1689351266',
'1689349844',
'1689347066',
'1687404761',
'1681787593',
'1649270414',
'1631516241',
'1630610934',
'1536585051',
'1533542641',
'1519085574',
'1460857627',
'5304472885356431750',
'3781820142968912382',
'5809408069271893462',
--望湘园
'16360118144930183667',
'1898125827',
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
'1738768850',
'1674587435',
'1540591903',
'1451155183',
'1444853221',
'1427894810',
--眉州集团
'1438358754',
'1436139796',
--棒约翰
'2070057419',
'2025887316',
'1997339390',
'1646370652',
--DQ
'1950824726',
'1935824883',
'1935699667',
'1917835065',
'1917833152',
'1819779837',
'1612467510',
'1600404214',
--正一味
'3972519162584539390'
)
	and d.order_day_key between 20170101 and 20171031
group by 1,2,3
)T1
)T
where
	T.paixu<=10)B ON A.供应商ID = B.供应商ID
		
		
		
		
		
		
	
--热销菜品top10

select *
from 
(select *,ROW_NUMBER() OVER(PARTITION BY T1.商户ID ORDER BY T1.销量 desc) paixu
from 
(
select FLOOR(d.order_day_key/100) AS '月份',
	concat('#',b2.supplier_id) as '供应商ID',
	d.caipin_name,
	sum(d.number) as '销量'
from 
	dim_business b2 
	left join fact_caipin_details d on b2.shop_id=d.shop_id
where 
	b2.is_test=0 and b2.is_delete=0 
	and d.order_status=9
	and b2.supplier_id IN (
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
--西贝
'1944172822',
'1828722691',
'1828712934',
'1828695538',
'1826195666',
'1791836585',
'1772120697',
'1706956039',
'1692119755',
'1692118769',
'1692117425',
'1689351266',
'1689349844',
'1689347066',
'1687404761',
'1681787593',
'1649270414',
'1631516241',
'1630610934',
'1536585051',
'1533542641',
'1519085574',
'1460857627',
'5304472885356431750',
'3781820142968912382',
'5809408069271893462',
--望湘园
'16360118144930183667',
'1898125827',
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
'1738768850',
'1674587435',
'1540591903',
'1451155183',
'1444853221',
'1427894810',
--眉州集团
'1438358754',
'1436139796',
--棒约翰
'2070057419',
'2025887316',
'1997339390',
'1646370652',
--DQ
'1950824726',
'1935824883',
'1935699667',
'1917835065',
'1917833152',
'1819779837',
'1612467510',
'1600404214',
--正一味
'3972519162584539390'
)
	and d.order_day_key between 20170101 and 20171031
group by 1,2,3
)T1
)T
where
	T.paixu<=10

	
--下单时间区间


	SELECT FLOOR(a.order_day_key/100) AS '月份',
		CONCAT('#',b.supplier_id) AS '供应商id',
		(CASE WHEN a.order_time >= '00:00' AND a.order_time < '02:00' THEN '下单时间0:00-2:00'
			WHEN a.order_time >= '02:00' AND a.order_time < '04:00' THEN '下单时间2:00-4:00'
			WHEN a.order_time >= '04:00' AND a.order_time < '06:00' THEN '下单时间4:00-6:00'
			WHEN a.order_time >= '06:00' AND a.order_time < '08:00' THEN '下单时间6:00-8:00'
			WHEN a.order_time >= '08:00' AND a.order_time < '10:00' THEN '下单时间8:00-10:00'
			WHEN a.order_time >= '10:00' AND a.order_time < '12:00' THEN '下单时间10:00-12:00'
			WHEN a.order_time >= '12:00' AND a.order_time < '14:00' THEN '下单时间12:00-14:00'
			WHEN a.order_time >= '14:00' AND a.order_time < '16:00' THEN '下单时间14:00-16:00'
			WHEN a.order_time >= '16:00' AND a.order_time < '18:00' THEN '下单时间16:00-18:00'
			WHEN a.order_time >= '18:00' AND a.order_time < '20:00' THEN '下单时间18:00-20:00'
			WHEN a.order_time >= '20:00' AND a.order_time < '22:00' THEN '下单时间20:00-22:00'
			WHEN a.order_time >= '22:00' AND a.order_time <= '24:00' THEN '下单时间22:00-24:00'
			END) AS '下单时间区间',
			COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '订单量'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND b.is_delete = 0
		AND b.is_test = 0
		AND a.order_day_key BETWEEN 20170101 AND 20171031
	GROUP BY 1,2,3
			
--客单价区间			
			
	SELECT FLOOR(a.order_day_key/100) AS '月份',
		CONCAT('#',b.supplier_id) AS '供应商id',			
		(CASE WHEN a.real_total_price/1000 <= 30 THEN '客单价(0,30]'
			WHEN a.real_total_price/1000 <= 50 AND a.real_total_price/1000 > 30 THEN '客单价(30,50]'
			WHEN a.real_total_price/1000 <= 70 AND a.real_total_price/1000 > 50 THEN '客单价(50,70]'
			WHEN a.real_total_price/1000 <= 90 AND a.real_total_price/1000 > 70 THEN '客单价(70,90]'
			WHEN a.real_total_price/1000 <= 120 AND a.real_total_price/1000 > 90 THEN '客单价(90,120]'
			WHEN a.real_total_price/1000 > 120 THEN '客单价(120,∞)'
			END) AS '客单价区间',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '订单量'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND b.is_delete = 0
		AND b.is_test = 0
		AND a.order_day_key BETWEEN 20170101 AND 20171031
	GROUP BY 1,2,3
	
	
	
	
	
--取消单数据





SELECT 
		CONCAT('#',CAST(a.order_id AS STRING)) AS '订单id',
		CONCAT('#',a.supplier_id) AS '供应商id',
		c.name AS '供应商名称',
		b.city_real AS '城市',
		/*(CASE WHEN a.cancel_reason_status = 3 THEN '菜品售完'
		WHEN a.cancel_reason_status = 5 THEN '用户取消'
		WHEN a.cancel_reason_status = 7 THEN '超时商户未响应'*/
		a.cancel_reason AS '取消原因'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	LEFT JOIN dim_supplier c ON a.supplier_id = c.supplier_id
		WHERE b.is_delete = 0
			AND b.is_test = 0
			AND a.break_type = 0
			AND a.order_status = 10
			AND a.order_day_key BETWEEN 20170101 AND 20171031
			AND a.supplier_id
				IN(
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
--西贝
'1944172822',
'1828722691',
'1828712934',
'1828695538',
'1826195666',
'1791836585',
'1772120697',
'1706956039',
'1692119755',
'1692118769',
'1692117425',
'1689351266',
'1689349844',
'1689347066',
'1687404761',
'1681787593',
'1649270414',
'1631516241',
'1630610934',
'1536585051',
'1533542641',
'1519085574',
'1460857627',
'5304472885356431750',
'3781820142968912382',
'5809408069271893462',
--望湘园
'16360118144930183667',
'1898125827',
--吉野家
'1917812101',
'1716449305',
'1511835917',
'1498405314',
'1738768850',
'1674587435',
'1540591903',
'1451155183',
'1444853221',
'1427894810',
--眉州集团
'1438358754',
'1436139796',
--棒约翰
'2070057419',
'2025887316',
'1997339390',
'1646370652',
--DQ
'1950824726',
'1935824883',
'1935699667',
'1917835065',
'1917833152',
'1819779837',
'1612467510',
'1600404214',
--正一味
'3972519162584539390'
)






/*
罗盈龙
*/



SELECT A.*,
		B.*,
		B.liushui/B.danliang AS '客单价'
FROM
(SELECT 	b.aoi,
		SUM(IF(d.source = 'baidu', d.liushui_fee, 0))/sum(d.liushui_fee) AS '百度市占',
		SUM(IF(d.source = 'meituan', d.liushui_fee, 0))/SUM(d.liushui_fee) AS '美团市占',
		SUM(IF(d.source = 'ele', d.liushui_fee, 0))/SUM(d.liushui_fee) AS '饿了么市占'
	FROM fact_shop_all d
	LEFT JOIN dim_business b ON d.merge_shop_id = b.wid
	WHERE d.make_date_key = 20171102
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.city_real = '北京'
GROUP BY 1)A
LEFT JOIN
(SELECT b.aoi,
		COUNT(a.order_id) AS danliang,
		SUM(a.real_total_price/1000) AS liushui
		
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.order_status = 9
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.city_real = '北京'
		AND a.order_day_key = 20171102
GROUP BY 1) B ON A.aoi = B.aoi
		


/*
UE = 折扣收入+物流单配送费-百度补贴-物流成本
*/



/*
李佳-全品牌数据
*/


SELECT a.order_day_key AS '日期',
		CONCAT('#',b.wid) AS '商户id',
		b.busi_name AS '商户名称',
		CONCAT('#',b.supplier_id) AS '供应商id',
		c.name AS '供应商名称',
		COUNT(a.order_id) AS '订单量',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '完成单量',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0)) AS '惠前流水',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '客单价',
		COUNT(CASE WHEN anticheat_new_user_flag = 1 THEN pass_uid ELSE null END) AS '新用户'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	LEFT JOIN dim_supplier c ON b.supplier_id = c.supplier_id
	WHERE a.break_type = 0
		AND b.is_delete = 0
		AND b.is_test = 0
		AND a.order_day_key BETWEEN 20170801 AND 20171112
		AND a.supplier_id IN(
'2028572329',
'1951113188',
'1930385409',
'1911844345',
'1896508031',
'1865057013',
'1794418798',
'1791667945',
'1666628549',
'1630753956',
'1600458595',
'1561817571',
'1542098281',
'1510781341',
'1501337273',
'1484553452',
'1479423053',
'1473961355',
'1470998677',
'1454488916',
'1438867410',
'1430327429',
'1427570036',
'6603832131182422902',
'2269286244439366708',
'13643835820237518716',
'12148475744025009612',
'14959891436290892458',
'18029544558059026498')
GROUP BY 1,2,3,4,5




/*
王子龙熊猫星厨
*/


SELECT  A.*,
		B.*,
		A.下单人数/B.访问uv AS '下单转化率',
		C.*
FROM
(SELECT CONCAT('#',b.wid) AS '商户ID',
		b.busi_name AS '商户名称',
		b.ka_brand AS '品牌',
		FLOOR(a.order_day_key/100) AS '月份',
		SUM(a.real_total_price/1000) AS '惠前流水',
		SUM(a.price/1000) AS '惠后流水',
		COUNT(a.order_id) AS '完成单量',
		COUNT(DISTINCT a.pass_uid) AS '下单人数',
		(SUM(CASE WHEN a.shop_butie>0 THEN a.shop_butie/1000 ELSE 0 END)+ SUM(CASE WHEN a.shop_quan_price>0 THEN a.shop_quan_price/1000 ELSE 0 END))/SUM(a.real_total_price/1000) AS '商户补贴率',
		SUM(a.real_total_price/1000)/COUNT(a.order_id) AS '客单价'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.order_day_key BETWEEN 20170701 AND 20171031
		AND a.order_status = 9
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id IN ('1823659202','1786552434')
GROUP BY 1,2,3,4)A

JOIN

(SELECT CONCAT('#',b.wid) AS shanghuid,
		FLOOR(c.shop_day_key/100) AS months,
		SUM(c.shop_uv) AS '访问uv',
		SUM(c.shop_baoguang_uv) AS '曝光uv',
		SUM(c.shop_pv) AS '访问pv',
		SUM(c.shop_baoguang_pv) AS '曝光pv',
		SUM(c.shop_uv)/SUM(shop_baoguang_uv) AS '访问转化率'
	FROM fact_business c
	LEFT JOIN dim_business b ON b.shop_id = c.shop_id
	WHERE c.shop_day_key BETWEEN 20170701 AND 20171031
		AND c.status = 1
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id IN ('1823659202','1786552434')
		
GROUP BY 1,2)B ON A.商户ID = B.shanghuid AND A.月份 = B.months

JOIN

(SELECT CONCAT('#',T.wid) AS shanghuid,
		T.months,
		SUM(IF(t1>=2, 1, 0))/COUNT (pass_uid) AS '复购率'
    FROM 
        (SELECT a1.pass_uid, a1.wid, FLOOR(a1.order_day_key/100) AS yuefen,
         COUNT (a1.order_id) t1
         FROM fact_order a1 
		 LEFT JOIN dim_business b ON a1.shop_id = b.shop_id
		 WHERE	a1.order_day_key BETWEEN 20170701 AND 20171031
                AND a1.break_type=0
				AND b.supplier_id IN('1823659202','1786552434')
                AND b.is_test=0
				AND b.is_delete = 0
        GROUP BY  1,2,3) T GROUP BY 1,2)C ON A.商户id = C.shanghuid AND A.月份 = C.months
		
		



/*
杨郁冲 羲和雅苑烤鸭
*/



SELECT A.*,
		A.下单人数/B.访问uv AS '下单转化率',
		B.*,
		C.*
FROM
(SELECT CONCAT('#',b.wid) AS '商户ID',
		b.busi_name AS '商户名称',
		b.ka_brand AS '品牌',
		FLOOR(a.order_day_key/100) AS '月份',
		SUM(a.real_total_price/1000) AS '惠前流水',
		SUM(a.price/1000) AS '惠后流水',
		COUNT(a.order_id) AS '完成单量',
		COUNT(DISTINCT a.pass_uid) AS '下单人数',
		SUM(a.real_total_price/1000)/COUNT(a.order_id) AS '客单价'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.order_day_key BETWEEN 20170701 AND 20171031
		AND a.order_status = 9
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id IN ('13883516258989084653')
GROUP BY 1,2,3,4)A

JOIN

(SELECT CONCAT('#',b.wid ) AS shanghuid,
		FLOOR(c.shop_day_key/100) AS yuefen,
		SUM(c.shop_uv) AS '访问uv',
		SUM(c.shop_baoguang_uv) AS '曝光uv',
		SUM(c.shop_pv) AS '访问pv',
		SUM(c.shop_baoguang_pv) AS '曝光pv',
		SUM(c.shop_uv)/SUM(shop_baoguang_uv) AS '访问转化率'
		
	FROM fact_business c
	LEFT JOIN dim_business b ON b.shop_id = c.shop_id
	WHERE c.shop_day_key BETWEEN 20170701 AND 20171031
		AND c.status = 1
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id IN ('13883516258989084653')
		
GROUP BY 1,2)B ON A.商户ID = B.shanghuid AND A.月份 = B.yuefen

JOIN

(SELECT  CONCAT('#',T.wid) AS shanghuid, 
		T.yuefen,
		SUM(if(t1>=2 , 1, 0))/COUNT (pass_uid) AS '复购率'
    FROM 
        (SELECT a1.pass_uid, a1.wid, FLOOR(a1.order_day_key/100) AS yuefen,
         COUNT (a1.order_id) t1
         FROM fact_order a1 
		 LEFT JOIN dim_business b ON a1.shop_id = b.shop_id
		 WHERE	a1.order_day_key BETWEEN 20170701 AND 20171031
                AND a1.break_type=0
				AND b.supplier_id IN('13883516258989084653')
                AND b.is_test=0
				AND b.is_delete = 0
        GROUP BY  1,2,3) T GROUP BY 1,2)C ON A.商户id = C.shanghuid AND A.月份 = C.yuefen






/*
陈风-早餐-下午茶分类
*/




SELECT A.*,
		百度补贴/完成单量 AS '单均百度补贴',
		商户补贴/完成单量 AS '单均商户补贴',
		折扣收入/完成单量 AS '单均折扣收入',
		配送费/完成单量 AS '单均配送费'
FROM
(SELECT (CASE WHEN a.order_day_key IN(20171001,20171008,20171015,20171022,20171029,20171105,20171007,20171014,20171021,20171028,20171104) THEN '周末'	ELSE '工作日' END) AS '周期',
		b.city_real AS '城市',
		b.aoi AS '商圈',
		split_part(b.area,'（',1) AS '星系',
		c.city_region AS '大区',
		(CASE WHEN d.wuliu_enum_value=1 THEN '物流' ELSE '自配送' END) AS '物流类型',
		(CASE WHEN a.order_time >= '06:00' AND a.order_time < '10:00' THEN '早餐'
		WHEN a.order_time >= '14:00' AND a.order_time < '17:00' THEN '下午茶'
		END) AS '时间段',
		SUM(IF(a.order_status = 9, a.send_price/1000, 0)) AS '配送费',
		COUNT(a.order_id) AS '总单量',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '完成单量',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0)) AS '优惠前流水',
		SUM(CASE WHEN a.shop_butie>0 AND a.order_status = 9 THEN a.shop_butie/1000 ELSE 0 END)
			+ SUM(CASE WHEN shop_quan_price>0 AND a.order_status = 9 THEN a.shop_quan_price/1000 ELSE 0 END) AS '商户补贴',
		SUM(CASE WHEN a.discount_baidufee_price>0  AND a.order_status = 9 THEN a.discount_baidufee_price/1000 ELSE 0 END) 
			+ SUM(CASE WHEN a.quan_price>0  AND a.order_status = 9 THEN a.quan_price/1000 ELSE 0 END) AS '百度补贴',
		(SUM(a.product_price/1000) - SUM(a.after_discount_price/1000)) AS '折扣收入'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	LEFT JOIN dim_aoi c ON c.aoi_id = b.aoi_id
	LEFT JOIN dim_order_delivery_party d ON b.delivery_party =d.delivery_party
	WHERE a.break_type = 0
		AND b.is_delete = 0
		AND b.is_test = 0
		AND a.order_day_key BETWEEN 20171001 AND 20171109
		AND b.city_real = '北京'
		AND ((a.order_time >= '06:00' AND a.order_time < '10:00')
			OR 
			(a.order_time >= '14:00' AND a.order_time < '17:00'))
GROUP BY 1,2,3,4,5,6,7)A





/*
张婷-局气-四世同堂
*/


SELECT  A.*,
		B.*,
		A.下单人数/B.访问uv AS '下单转化率',
		C.*
FROM
(SELECT b.ka_brand AS '品牌',
		FLOOR(a.order_day_key/100) AS '月份',
		SUM(IF(a.order_status = 9,a.real_total_price/1000,0)) AS '惠前流水',
		SUM(IF(a.order_status = 9,a.price/1000,0)) AS '惠后流水',
		COUNT(IF(a.order_status = 9,a.order_id,0)) AS '完成单量',
		COUNT(DISTINCT a.pass_uid) AS '下单人数',
		(SUM(CASE WHEN a.shop_butie>0 AND a.order_status = 9 THEN a.shop_butie/1000 ELSE 0 END)+ SUM(CASE WHEN a.shop_quan_price>0 AND a.order_status = 9 THEN a.shop_quan_price/1000 ELSE 0 END))/SUM(IF(a.order_status = 9, a.real_total_price/1000,0)) AS '商户补贴率',
		SUM(IF(a.order_status = 9,a.real_total_price/1000,0))/COUNT(IF(a.order_status = 9,a.order_id,0)) AS '客单价',
		COUNT(CASE WHEN a.cancel_reason_status IN(7,3,1,2,4,9,10,11,12,19,13,14,15,16,18,20,21,22,23,102,103,110,6) AND a.order_status=10 THEN a.order_id ELSE NULL END)/COUNT(a.order_id) AS '非异率'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.order_day_key BETWEEN 20170301 AND 20170531
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id IN ('1500553305','5479044762720847')
GROUP BY 1,2)A

JOIN

(SELECT b.ka_brand,
		FLOOR(c.shop_day_key/100) AS months,
		SUM(c.shop_uv) AS '访问uv',
		SUM(c.shop_baoguang_uv) AS '曝光uv',
		SUM(c.shop_pv) AS '访问pv',
		SUM(c.shop_baoguang_pv) AS '曝光pv',
		SUM(c.shop_uv)/SUM(shop_baoguang_uv) AS '访问转化率'
	FROM fact_business c
	LEFT JOIN dim_business b ON b.shop_id = c.shop_id
	WHERE c.shop_day_key BETWEEN 20170301 AND 20170531
		AND c.status = 1
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id IN ('1500553305','5479044762720847')
		
GROUP BY 1,2)B ON A.品牌 = B.ka_brand AND A.月份 = B.months

JOIN

(SELECT T.ka_brand,
		T.yuefen,
		SUM(IF(t1>=2, 1, 0))/COUNT (pass_uid) AS '复购率'
    FROM 
        (SELECT a1.pass_uid, b.ka_brand, FLOOR(a1.order_day_key/100) AS yuefen,
         COUNT (a1.order_id) t1
         FROM fact_order a1 
		 LEFT JOIN dim_business b ON a1.shop_id = b.shop_id
		 WHERE	a1.order_day_key BETWEEN 20170301 AND 20170531
                AND a1.break_type=0
				AND b.supplier_id IN ('1500553305','5479044762720847')
                AND b.is_test=0
				AND b.is_delete = 0
        GROUP BY  1,2,3) T GROUP BY 1,2)C ON A.品牌 = C.ka_brand AND A.月份 = C.yuefen





/*
涂小双-wagas
*/


SELECT A.*,
		B.*,
		A.出单商户数/B.在线合作商户数 AS '动销率',
		A.下单人数/B.曝光uv,
		C.百度流水,
		C.美团流水,
		C.饿了么流水,
		D.*
FROM
(SELECT b.ka_brand AS '品牌',
		FLOOR(a.order_day_key/100) AS '月份',
		e.sale_name AS '销售姓名',
		COUNT(DISTINCT a.waimai_release_id) AS '出单商户数',
		COUNT(DISTINCT a.pass_uid) AS '下单人数',
		COUNT(CASE WHEN anticheat_new_user_flag = 1 THEN pass_uid ELSE null END) AS '新用户'		
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	LEFT JOIN dim_order_sale_id e ON e.sale_id = b.sales_id
	WHERE a.break_type = 0
		AND a.supplier_id = '1707109935'
		AND a.order_day_key BETWEEN 20171001 AND 20171114
		AND b.is_test = 0
		AND b.is_delete = 0
GROUP BY 1,2,3)A
		
JOIN 
	
(SELECT FLOOR(c.shop_day_key/100) AS yuefen,
		b.ka_brand,
		COUNT(DISTINCT IF(c.sys_status IN (0,6,13,14,15), c.waimai_release_id, NULL)) AS '在线合作商户数',
		SUM(c.shop_baoguang_uv) AS '曝光uv',
		SUM(c.shop_baoguang_pv) AS '曝光pv'
	FROM fact_business c
	LEFT JOIN dim_business b ON c.shop_id = b.shop_id
	WHERE c.status = 1
		AND b.is_delete = 0
		AND b.is_test = 0
		AND c.shop_day_key BETWEEN 20171001 AND 20171114
		AND b.supplier_id = '1707109935'
GROUP BY 1,2)B ON A.品牌 = B.ka_brand AND A.月份 = B.yuefen
		
JOIN		
		
(SELECT FLOOR(d.make_date_key/100) AS yuefen,
		b.ka_brand,
		SUM(IF(d.source = 'baidu', d.liushui_fee, 0)) AS '百度流水',
		SUM(IF(d.source = 'meituan', d.liushui_fee, 0))AS '美团流水',
		SUM(IF(d.source = 'ele', d.liushui_fee, 0))AS '饿了么流水',
		SUM(d.liushui_fee) AS sum_liushui_fee
	FROM fact_shop_all d
	LEFT JOIN dim_business b ON d.merge_shop_id = b.wid
	WHERE d.make_date_key BETWEEN 20171001 AND 20171114
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id = '1707109935'
GROUP BY 1,2)C ON A.品牌 = C.ka_brand AND A.月份 = C.yuefen

JOIN

(SELECT T.ka_brand,
		T.yuefen,
		SUM(IF(t1>=2, 1, 0))/COUNT (pass_uid) AS '复购率'
    FROM 
        (SELECT a1.pass_uid, b.ka_brand, FLOOR(a1.order_day_key/100) AS yuefen,
         COUNT (a1.order_id) t1
         FROM fact_order a1 
		 LEFT JOIN dim_business b ON a1.shop_id = b.shop_id
		 WHERE	a1.order_day_key BETWEEN 20171001 AND 20171114
                AND a1.break_type=0
				AND b.supplier_id IN ('1707109935')
                AND b.is_test=0
				AND b.is_delete = 0
        GROUP BY  1,2,3) T GROUP BY 1,2)D ON A.品牌 = D.ka_brand AND A.月份 = D.yuefen




/*
韩金-8、9、10月美团top800商户
*/



SELECT b.busi_name,
		SUM(IF(a.order_status = 9, real_total_price/1000,0)) AS liushui
FROM fact_order a 
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.break_type = 0
	AND a.order_day_key BETWEEN 20170801 AND 20171031
	AND b.is_delete = 0
	AND b.is_test = 0
	AND b.busi_name IN
(SELECT b.busi_name
FROM fact_shop_all a 
LEFT JOIN dim_business b ON CAST(a.shop_id AS BIGINT) = b.shop_id
WHERE a.source = 'meituan'
	AND b.is_test = 0
	AND b.is_delete = 0
	AND a.make_date_key BETWEEN 20170801 AND 20171031
	AND b.city_real IN ('广州','深圳','福州'))
GROUP BY 1
ORDER BY SUM(IF(a.order_status = 9, real_total_price/1000,0)) DESC
LIMIT 800




/*
张亚辉-物流商圈-商圈
*/



SELECT CONCAT('#',b.wid),
		b.aoi,
		CONCAT('#',b.aoiid),
		c.aoi_name,
		CONCAT('#',c.aoi_id)
	FROM dim_business b 
	LEFT JOIN dim_wuliu_aoi c ON b.aoiid = c.aoi_id
		AND b.wid IN()
		AND b.is_test = 0
		AND b.is_delete = 0



/*
张亚辉  
*/



-- 销售商圈名称	销售商圈ID	物流商圈名称	物流商圈ID


SELECT CONCAT('#',b.waimai_release_id) AS wid 
    , b.aoi
    , CONCAT('#',b.aoi_id)
    , f.aoi_name
    , CONCAT('#',f.aoi_id) 
FROM dim_business AS b 
LEFT JOIN dim_shop_all AS e ON b.waimai_release_id = e.shop_id
LEFT JOIN dim_wuliu_aoi AS f ON f.aoi_id = e.wuliu_aoi
WHERE b.waimai_release_id IN ('1791589111',
'1953145097',
'1955375809',
'1809441767'
) 
group by 1,2,3,4,5



/*
王玉琳
*/


--top50商户

SELECT CONCAT('#',b.wid) AS '商户id',
		b.busi_name AS '商户名称',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '单量'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND b.is_test = 0
		AND b.is_delete = 0
		AND b.aoi IN ('朝阳大悦城')
		AND a.order_day_key BETWEEN 20170601 AND 20171031
GROUP BY 1,2
ORDER BY 3 DESC
LIMIT 50

--top50菜品

SELECT CONCAT('#',c.caipin_id) AS '菜品id',
		c.caipin_name AS '菜品名称',
		SUM(c.number) AS '菜品销量'
	FROM fact_caipin_details c
	LEFT JOIN dim_business b ON b.shop_id = c.shop_id
	WHERE c.order_day_key BETWEEN 20170601 AND 20171031
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.aoi IN ('朝阳大悦城')
		AND c.order_status = 9
GROUP BY 1,2
ORDER BY 3 DESC
LIMIT 50



/*
zhaojinping
*/



--非KA
SELECT * FROM(
SELECT *
	,ROW_NUMBER() OVER(PARTITION BY A.make_date_key ORDER BY A.总流水 DESC) rk
FROM(
SELECT CONCAT('#',b.wid) AS shanghuid,
		d.make_date_key,
		b.busi_name,
		b.aoi,
		split_part(b.area,'（',1) AS '星系',
		c.city_region,
		SUM(IF(d.source = 'baidu', d.liushui_fee, 0)) AS '百度流水',
		SUM(IF(d.source = 'meituan', d.liushui_fee, 0)) AS '美团流水',
		SUM(IF(d.source = 'ele', d.liushui_fee, 0)) AS '饿了么流水',
		SUM(d.liushui_fee) AS '总流水'
	FROM fact_shop_all d
	LEFT JOIN dim_business b ON d.merge_shop_id = b.wid
	LEFT JOIN dim_aoi c ON b.aoi_id = c.aoi_id
	WHERE d.make_date_key BETWEEN 20171114 AND 20171116
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.city_real = '北京'
		AND b.ka_extend_lable_id IN (-1, 0, 6)
GROUP BY 1,2,3,4,5,6)A)B
WHERE rk<=30

		
--LKA
SELECT * FROM(
SELECT *
	,ROW_NUMBER() OVER(PARTITION BY A.make_date_key ORDER BY A.总流水 DESC) rk
FROM(
SELECT CONCAT('#',b.wid) AS shanghuid,
		d.make_date_key,
		b.busi_name,
		e.sale_name,
		SUM(IF(d.source = 'baidu', d.liushui_fee, 0)) AS '百度流水',
		SUM(IF(d.source = 'meituan', d.liushui_fee, 0)) AS '美团流水',
		SUM(IF(d.source = 'ele', d.liushui_fee, 0)) AS '饿了么流水',
		SUM(d.liushui_fee) AS '总流水'
	FROM fact_shop_all d
	LEFT JOIN dim_business b ON d.merge_shop_id = b.wid
	LEFT JOIN dim_order_sale_id e ON b.sales_id=e.sale_id
	WHERE (d.make_date_key BETWEEN 20171108 AND 20171113
			OR d.make_date_key = 20171116)
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.city_real = '北京'
		AND b.ka_extend_lable_id IN (9, 11)
GROUP BY 1,2,3,4)A)B
WHERE rk<=30



SELECT 	d.make_date_key,
		c.city_region,
		SUM(IF(d.source = 'baidu', d.liushui_fee, 0)) AS '百度流水',
		SUM(IF(d.source = 'meituan', d.liushui_fee, 0)) AS '美团流水',
		SUM(IF(d.source = 'ele', d.liushui_fee, 0)) AS '饿了么流水',
		SUM(d.liushui_fee) AS '总流水'
	FROM fact_shop_all d
	LEFT JOIN dim_business b ON d.merge_shop_id = b.wid
	LEFT JOIN dim_order_sale_id e ON b.sales_id=e.sale_id
	LEFT JOIN dim_aoi c ON c.aoi_id = b.aoi_id
	WHERE (d.make_date_key BETWEEN 20171108 AND 20171113
			OR d.make_date_key = 20171116)
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.city_real = '北京'
GROUP BY 1,2



/*
杜胜强
*/


SELECT (CASE WHEN e.city_category = 'S' THEN 'S级城市'
		WHEN e.city_category = 'A' OR e.city_category = 'B' THEN 'AB级城市'
		WHEN e.city_category IN ('C','D','E','F')THEN 'CD及以下级别城市' END)AS city_category,
		SUM(a.real_total_price/1000) AS gmv,				--惠前流水
		COUNT(DISTINCT e.city_id) AS city_num,
		COUNT(DISTINCT b.wid) AS busi_num,
		COUNT(a.order_id) AS order_num
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	LEFT JOIN aoi_city e ON a.city_id = e.city_id
	WHERE a.break_type = 0
		AND a.order_status = 9
		AND b.is_test = 0
		AND b.is_delete = 0
		AND b.ka_extend_lable_id IN (1,2,8)
		AND a.order_day_key BETWEEN 20171017 AND 20171116
GROUP BY 1





/*
冯桂平
*/





SELECT A.*,
		B.累计商户补贴,
		B.累计百度补贴,
		C.流水,
		C.商户补贴,
		C.百度补贴
FROM
(SELECT b.ka_brand AS '品牌',
		d.make_date_key AS '日期',
		SUM(IF(d.source = 'baidu', d.liushui_fee, 0))/SUM(d.liushui_fee) AS '百度市占',
		SUM(IF(d.source = 'meituan', d.liushui_fee, 0))/SUM(d.liushui_fee) AS '美团市占',
		SUM(IF(d.source = 'ele', d.liushui_fee, 0))/SUM(d.liushui_fee) AS '饿了么市占',
		SUM(d.liushui_fee) AS '累计流水'
	FROM fact_shop_all d
	LEFT JOIN dim_business b ON d.merge_shop_id = b.wid
	LEFT JOIN dim_order_sale_id e ON b.sales_id=e.sale_id
	WHERE d.make_date_key = 20171119														--修改时间
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.city_real = '北京'
		AND b.ka_extend_lable_id IN (9, 11)
GROUP BY 1,2)A

LEFT JOIN 

(SELECT b.ka_brand,
		SUM(case when a.shop_butie>0 then a.shop_butie/1000 else 0 end)
		+ SUM(case when shop_quan_price>0 then a.shop_quan_price/1000 else 0 end) AS '累计商户补贴',
		SUM(case when a.discount_baidufee_price>0 then a.discount_baidufee_price/1000  else 0 end) 
		+ SUM(case when a.quan_price>0 then a.quan_price/1000 else 0 end) AS '累计百度补贴'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND b.is_delete = 0
		AND a.order_status = 9
		AND b.is_test = 0
		AND a.order_day_key BETWEEN 20171020 AND 20171119									--修改时间
		AND b.ka_extend_lable_id IN (9,11)
		AND b.city_real = '北京'
GROUP BY 1) B ON A.品牌 = B.ka_brand 


LEFT JOIN 
(SELECT b.ka_brand,
		a.order_day_key,
		SUM(a.real_total_price/1000) AS '流水',
		SUM(case when a.shop_butie>0 then a.shop_butie/1000 else 0 end)
		+ SUM(case when shop_quan_price>0 then a.shop_quan_price/1000 else 0 end) AS '商户补贴',
		SUM(case when a.discount_baidufee_price>0 then a.discount_baidufee_price/1000  else 0 end) 
		+ SUM(case when a.quan_price>0 then a.quan_price/1000 else 0 end) AS '百度补贴'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND b.is_delete = 0
		AND a.order_status = 9
		AND b.is_test = 0
		AND a.order_day_key = 20171119														--修改时间
		AND b.ka_extend_lable_id IN (9,11)
		AND b.city_real = '北京'
GROUP BY 1,2)C ON A.品牌 = C.ka_brand AND A.日期 = C.order_day_key





/*
赵烨
*/




SELECT A.*,
		B.*
FROM
(SELECT CONCAT('#',b.supplier_id) AS '供应商ID',
		b.busi_name AS '商户名称',
		b.city_real AS '城市',
		FLOOR(a.order_day_key/100) AS '月份',
		SUM(if(a.order_status = 9, a.real_total_price/1000,0)) AS '惠前流水',
		SUM(case when a.shop_butie>0 then a.shop_butie/1000 else 0 end)
		+ SUM(case when shop_quan_price>0 then a.shop_quan_price/1000 else 0 end) AS '商户补贴',
		SUM(case when a.discount_baidufee_price>0 then a.discount_baidufee_price/1000  else 0 end) 
		+ SUM(case when a.quan_price>0 then a.quan_price/1000 else 0 end) AS '百度补贴',
		(SUM(CASE WHEN a.shop_butie>0 THEN a.shop_butie/1000 ELSE 0 END)+ SUM(CASE WHEN a.shop_quan_price>0 THEN a.shop_quan_price/1000 ELSE 0 END))/SUM(a.real_total_price/1000) AS '商户补贴率',
		COUNT(a.order_id) AS '下单数量',
		COUNT(if(a.order_status = 9,a.order_id,NULL)) AS '完成单量'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.order_day_key BETWEEN 20170101 AND 20171031
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id IN ('2083139217',
'2066627982',
'2065376914',
'2054096676',
'2046342829',
'2045993727',
'2023206481',
'2022666524',
'2022586217',
'1643385111',
'1624738890',
'1577824449',
'1444930014',
'2097062135',
'1837324243',
'1825870596',
'1439332322',
'2014392376',
'1621923857',
'1557971134','1543861317','1716744329')
GROUP BY 1,2,3,4)A

JOIN

(SELECT CONCAT('#',b.supplier_id ) AS gongyingshangid,
		b.busi_name,
		FLOOR(c.shop_day_key/100) AS yuefen,
		SUM(c.shop_uv) AS '访问uv',
		SUM(c.shop_baoguang_uv) AS '曝光uv',
		SUM(c.shop_pv) AS '访问pv',
		SUM(c.shop_baoguang_pv) AS '曝光pv'
	FROM fact_business c
	LEFT JOIN dim_business b ON b.shop_id = c.shop_id
	WHERE c.shop_day_key BETWEEN 20170101 AND 20171031
		AND c.status = 1
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id IN ('2083139217',
'2066627982',
'2065376914',
'2054096676',
'2046342829',
'2045993727',
'2023206481',
'2022666524',
'2022586217',
'1643385111',
'1624738890',
'1577824449',
'1444930014',
'2097062135',
'1837324243',
'1825870596',
'1439332322',
'2014392376',
'1621923857','1557971134','1543861317','1716744329')
		
GROUP BY 1,2,3)B ON A.商户名称 = B.busi_name AND A.月份 = B.yuefen



/*
王雪伟
*/




select t1.sale_name 销售,
count(t1.waimai_release_id) 新签>=5单的商户数  from
(select t.waimai_release_id,t.sale_name   from(
  select d.waimai_release_id,a.sale_name,count(c.order_id) cc
  from fact_order c join dim_business  d on c.shop_id=d.shop_id
    left join dim_order_sale_id a on d.sales_id=a.sale_id
 and c.break_type=0  and c.order_status=9
    and d.ka_extend_lable_id in(9,11)
    and c.order_day_key between 20170701 and 20170723
    and a.sale_name in('杜娟',
'王德剑',
'张艳臣',
'何缘溪',
'任雨',
'张春柳',
'孙鹏',
'宋帅帅',
'王玉琳',
'李佳',
'黄翠翠',
'吕成洲',
'滕秋菊',
'丁肇中',
'杨郁冲',
'张叶',
'王楠',
'张婷',
'王佟',
'方超',
'任雨',
'王子龙',
'焦圣强',
'金旭')group  by 1,2) as t  where t.cc>=5) t1
    join
   (select distinct b.waimai_release_id, c.sale_name
  from fact_business a join dim_business  b on a.shop_id=b.shop_id
  left join dim_order_sale_id c on b.sales_id=c.sale_id
 where a.is_test=0 and a.sys_status in(0,6,13,14,15)
 and a.shop_day_key between 20170701 and 20170723
 and  from_unixtime(b.create_time+8*3600,'yyyyMMdd')>='20171101'
 and a.is_new_hezuo=1
and b.ka_extend_lable_id in(9,11)
 and c.sale_name in('杜娟',
'王德剑',
'张艳臣',
'何缘溪',
'任雨',
'张春柳',
'孙鹏',
'宋帅帅',
'王玉琳',
'李佳',
'黄翠翠',
'吕成洲',
'滕秋菊',
'丁肇中',
'杨郁冲',
'张叶',
'王楠',
'张婷',
'王佟',
'方超',
'任雨',
'王子龙',
'焦圣强',
'金旭')    ) t2
 on t1.waimai_release_id=t2.waimai_release_id and t1.sale_name=t2.sale_name
 group by t1.sale_name



/*
刘金亮-双证-健康度
*/



SELECT c.city_region AS '大区',
		b.city_real AS '城市',
		b.aoi AS '商圈',
		CONCAT('#',b.wid) AS '商户id',
		e.sale_name AS '销售',
		if(a.zhuti_zizhi_flag = 1, 1, 0) AS '是否有营业执照',
		if(a.hangye_zizhi_flag = 1, 1, 0) AS '是否有餐饮许可',
		if(a.have_logo = 1, 1, 0) AS '是否有logo',
		if(a.caipin_num > 5, 1, 0) AS '菜品数量是否>5',
		if(b.payment in (6,7), 1, 0) AS '是否在线支付',
		if(a.url_caipin_num/a.caipin_num > 0.95, 1, 0) AS '菜品图片覆盖率是否>95%'
    FROM fact_business a  
	LEFT JOIN dim_business b  ON a.shop_id=b.shop_id
	LEFT JOIN dim_aoi c ON b.aoi_id = c.aoi_id
	LEFT JOIN dim_order_sale_id e ON e.sale_id = b.sales_id
    WHERE b.is_delete = 0
            AND b.is_test = 0
            AND b.sys_status in(0, 6, 13, 14, 15)
            AND a.shop_day_key = 20171121
			AND a.status = 1
			AND b.city_real IN ('上海',
'北京',
'深圳',
'杭州',
'广州',
'成都',
'武汉',
'南京',
'苏州',
'福州',
'天津',
'重庆',
'宁波',
'温州',
'西安',
'沈阳',
'哈尔滨',
'厦门',
'郑州',
'长沙',
'青岛',
'长春',
'济南',
'大连',
'无锡',
'合肥',
'南昌',
'金华',
'常州',
'昆明',
'石家庄',
'东莞',
'泉州',
'南宁',
'佛山',
'珠海',
'嘉兴',
'南通',
'绍兴',
'台州',
'太原',
'海口',
'贵阳',
'扬州',
'呼和浩特',
'芜湖',
'烟台',
'吉林',
'徐州',
'惠州',
'湖州',
'兰州',
'保定',
'盐城',
'潍坊',
'廊坊',
'唐山',
'威海',
'中山')





/*
肖志明和虞豪成
*/




SELECT A.*,
		B.*
FROM
(SELECT e.sale_name,
		COUNT(if(a.jiedan_type<>3,a.order_id,null))/COUNT(a.order_id) AS '接单率'
		
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id 
	LEFT JOIN dim_order_sale_id e ON e.sale_id = b.sales_id
	WHERE b.is_test = 0
		AND b.is_delete = 0
		AND a.order_day_key BETWEEN 20171101 AND 20171121
		AND e.sale_name = '肖智明'
		AND a.break_type = 0
GROUP BY 1)A
	
LEFT JOIN	
	
(SELECT e.sale_name,
		SUM(c.url_caipin_num)/SUM(c.caipin_num) AS '图片覆盖率',
		AVG(CAST(c.bd_actual_business_time AS DOUBLE)/60) AS '营业时长',
		COUNT(DISTINCT IF(b.payment IN (6,7) AND c.have_logo = 1 AND c.caipin_num>=5 AND c.url_caipin_num/c.caipin_num>=0.95,b.wid,NULL)) AS '健康商户数',
		COUNT(DISTINCT b.wid) AS '维护门店数'
	FROM fact_business c
	LEFT JOIN dim_business b ON b.shop_id = c.shop_id
	LEFT JOIN dim_order_sale_id e ON e.sale_id = b.sales_id
	WHERE c.status = 1
		AND b.is_delete = 0
		AND b.is_test = 0
		AND c.sys_status IN (0, 6, 13, 14, 15)
		AND c.shop_day_key BETWEEN 20171101 AND 20171121
		AND e.sale_name = '肖智明'
GROUP BY 1)B ON A.sale_name = B.sale_name








/*
虞豪成
*/
           





SELECT A.*,
		B.*,
		C.*
FROM
(SELECT CONCAT('#',b.supplier_id) AS '供应商id',
		(CASE WHEN d.wuliu_enum_value = 1 THEN '百度物流'
			ELSE '自配送' END) AS '物流类型', 
		COUNT(IF(a.order_status = 9, a.order_id, 0)) AS '完成单'		
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	LEFT JOIN dim_order_delivery_party d ON b.delivery_party = d.delivery_party
	WHERE a.break_type = 0
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.supplier_id IN ('2000668540',
							'1648924981',
							'1984566383',
							'1958846183',
							'1955584142',
							'1928739501')
		AND a.order_day_key BETWEEN 20171001 AND 20171121
GROUP BY 1,2) A 

LEFT JOIN						
							
(SELECT CONCAT('#',b.supplier_id) AS supplier_id,
		COUNT(IF(b.payment IN (6,7) AND c.have_logo = 1 AND c.caipin_num>=5 AND c.url_caipin_num/c.caipin_num>=0.95,b.wid,NULL))/COUNT(b.wid) AS jiankanglv,
		SUM(c.shop_uv) AS '访问uv',
		SUM(c.shop_baoguang_uv) AS '曝光uv',
		SUM(c.shop_pv) AS '访问pv',
		SUM(c.shop_baoguang_pv) AS '曝光pv'
	FROM fact_business c
	LEFT JOIN dim_business b ON b.shop_id = c.shop_id
	WHERE c.shop_day_key BETWEEN 20171001 AND 20171121
		AND c.status = 1
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.sys_status IN(0,6,13,14,15)
		AND b.supplier_id IN ('2000668540',
							'1648924981',
							'1984566383',
							'1958846183',
							'1955584142',
							'1928739501')
		
GROUP BY 1)B ON A.供应商id = B.supplier_id

LEFT JOIN

(SELECT  CONCAT('#',T.supplier_id) AS supplier_id, 
		 SUM(if(t1>=2 , 1, 0))/COUNT (pass_uid) AS '复购率'
    FROM 
        (SELECT a1.pass_uid, b.supplier_id,
         COUNT (a1.order_id) t1
         FROM fact_order a1 
		 LEFT JOIN dim_business b ON a1.shop_id = b.shop_id
		 WHERE	a1.order_day_key BETWEEN 20171001 AND 20171121
                AND a1.break_type=0
				AND b.supplier_id IN ('2000668540',
							'1648924981',
							'1984566383',
							'1958846183',
							'1955584142',
							'1928739501')
                AND b.is_test=0
				AND b.is_delete = 0
        GROUP BY  1,2) T GROUP BY 1)C ON A.供应商id = C.supplier_id
 
 


*/
zhaozimeng
*/




	
SELECT A.*,
		B.*
FROM
(SELECT FLOOR(d.make_date_key/100) AS yuefen,
		b.city_real,
		b.ka_brand,
		SUM(IF(d.source = 'baidu', d.liushui_fee, 0))/sum(d.liushui_fee) AS '百度市占',
		SUM(IF(d.source = 'meituan', d.liushui_fee, 0))/SUM(d.liushui_fee) AS '美团市占',
		SUM(IF(d.source = 'ele', d.liushui_fee, 0))/SUM(d.liushui_fee) AS '饿了么市占'
	FROM fact_shop_all d
	LEFT JOIN dim_business b ON d.merge_shop_id = b.wid
	WHERE d.make_date_key BETWEEN 20170801 AND 20171121
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.ka_brand = '小恒水饺'
GROUP BY 1,2,3)A
LEFT JOIN
(SELECT FLOOR(a.order_day_key/100) AS yuefen,
		b.city_real,
		b.ka_brand,
		COUNT(a.order_id) AS danliang,
		SUM(a.real_total_price/1000) AS liushui,
		(SUM(CASE WHEN a.shop_butie>0 THEN a.shop_butie/1000 ELSE 0 END)+ SUM(CASE WHEN a.shop_quan_price>0 THEN a.shop_quan_price/1000 ELSE 0 END))/SUM(a.real_total_price/1000) AS '商户补贴率',
		SUM(CASE WHEN a.discount_baidufee_price>0  AND a.order_status = 9 THEN a.discount_baidufee_price/1000 ELSE 0 END) 
		+ SUM(CASE WHEN a.quan_price>0  AND a.order_status = 9 THEN a.quan_price/1000 ELSE 0 END) AS '百度补贴金额',
		(SUM(CASE WHEN a.discount_baidufee_price>0  AND a.order_status = 9 THEN a.discount_baidufee_price/1000 ELSE 0 END) 
		+ SUM(CASE WHEN a.quan_price>0  AND a.order_status = 9 THEN a.quan_price/1000 ELSE 0 END))/SUM(a.real_total_price/1000) AS '百度补贴率'
	FROM fact_order a 
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.order_status = 9
		AND b.is_delete = 0
		AND b.is_test = 0
		AND b.ka_brand = '小恒水饺'
		AND a.order_day_key BETWEEN 20170801 AND 20171121
GROUP BY 1,2,3) B ON A.yuefen = B.yuefen AND A.city_real = B.city_real