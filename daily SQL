/*
ÎÞµÐ¼Ò  2106184075   Íû¾©Ð¡Ñü£¨×Ü²¿£©1735889933      
10.1-10.22  ¸÷ÃÅµêÃ¿ÈÕ¶©µ¥£¬Á÷Ë®£¬°Ù¶È²¹Ìù£¬ÉÌ»§²¹Ìù£¬ÆØ¹â£¬×ª»¯£¬¸´¹ºÂÊÊý¾Ý
*/

SELECT *, X1.Ã¿ÈÕ¶©µ¥/X2.sum_click_uv AS '×ª»¯' FROM 
(SELECT a.order_day_key AS 'ÈÕÆÚ', c.busi_name AS 'ÃÅµê',a.wid
COUNT(if(a.order_status = 9,a.order_id,null)) AS 'Ã¿ÈÕ¶©µ¥', 
SUM(a.real_total_price)/1000 AS 'Á÷Ë®', 
SUM(case when a.shop_butie>0 then a.shop_butie/1000 else 0 end)
	+ SUM(case when shop_quan_price>0 then a.shop_quan_price/1000 else 0 end) AS 'ÉÌ»§²¹Ìù',
SUM(case when a.discount_baidufee_price>0 then a.discount_baidufee_price/1000  else 0 end) 
	+ SUM(case when a.quan_price>0 then a.quan_price/1000 else 0 end) AS '°Ù¶È²¹Ìù', 
FROM fact_order a 
LEFT JOIN dim_business c ON a.shop_id=c.shop_id
WHERE a.break_type=0
AND a.order_day_key BETWEEN 20171001 AND 20171022
AND a.supplier_id IN ('2106184075', '1735889933')
GROUP BY a.order_day_key, c.busi_name, a.wid) X1
LEFT JOIN 
(SELECT b.idx_day,b.wid,SUM(b.click_uv) AS sum_click_uv,SUM(b.view_uv) AS 'ÆØ¹â' 
FROM da_zz_data_shop_rank b)X2 ON X1.ÈÕÆÚ=X2.idx_day AND X1.wid=X2.wid 
LEFT JOIN
(SELECT  T.wid, 
		 SUM(if(t1>=2 ,
         1,
         0))/COUNT (pass_uid) AS '¸´¹ºÂÊ'
    FROM 
        (SELECT a1.pass_uid, a1.wid, 
         COUNT (a1.order_id) t1
         FROM fact_order a1
		 WHERE	a1.order_day_key
            BETWEEN 20171001 AND 20171022
                AND a1.break_type=0
                AND a1.supplier_id IN ('2106184075', '1735889933')
                AND a1.is_test=0
        GROUP BY  1,2) T GROUP BY 1) X3
ON  X1.wid=X3.wid 

/*
1¡¢ÒÔÃÅµêÎ¬¶ÈÃ¿¸öÃÅµêÏúÊÛÁ÷Ë®Êý¾Ý¡£
2.ÒÔÃÅµêÎ¬¶ÈÃ¿¸öÃÅµêÏÂµ¥ÊýÁ¿°üÀ¨Íê³É¶©µ¥ÒÔ¼°Î´Íê³É¶©µ¥
*/


SELECT b.busi_name AS 'ÃÅµê',
	SUM(IF(a.order_status = 9, real_total_price, 0))/1000 AS 'Á÷Ë®',
	COUNT(IF(a.order_status = 9, a.order_id, NULL) AS 'Íê³É¶©µ¥'£¬
	COUNT(a.order_id) - COUNT(IF(a.order_status = 9, a.order_id, NULL) AS 'Î´Íê³É¶©µ¥'
FROM fact_order a
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.supplier_id = '1921784649'
	AND a.order_day_key BETWEEN 20170801 AND 20170831
	AND a.break_type = 0
	AND b.is_test = 0
	AND b.is_delete = 0
GROUP BY 1

/*
Ì¨×ÊÎ¶¡¢½ð°ÙÍò¡¢½¹¶úÕâ¼¸¸öÆ·ÅÆµÄÏÂµ¥×ª»¯ÂÊºÍ¸´¹ºÂÊ								
*/

SELECT  A.Æ·ÅÆ, 
		A.ÔÂ·Ý, 
		A.order_amount/B.sum_click_uv AS 'ÏÂµ¥×ª»¯ÂÊ', 
		C.¸´¹ºÂÊ
FROM
(SELECT  b.ka_brand AS 'Æ·ÅÆ', 
		FLOOR(a.order_day_key/100) AS 'ÔÂ·Ý', 
		a.wid, 
		COUNT(if(a.order_status = 9,a.order_id,null)) AS order_amount
FROM fact_order a 
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.break_type = 0
	AND a.order_day_key BETWEEN 20170801 AND 20171024
	AND b.is_test = 0
	AND b.is_delete = 0
	AND b.ka_brand IN ('Ì¨×ÊÎ¶', '½ð°ÙÍò', '½¹¶ú')
GROUP BY 1,2)A
LEFT JOIN

(SELECT c.wid,
		SUM(c.click_uv) AS sum_click_uv
FROM da_zz_data_shop_rank c)B ON A.wid = B.wid
LEFT JOIN

(SELECT  T.ka_brand, T.months, 
		 SUM(if(t1>=2 , 1, 0))/COUNT (T.pass_uid) AS '¸´¹ºÂÊ'
    FROM 
        (SELECT a1.pass_uid, b1.ka_brand, FLOOR(a1.order_day_key/100) AS months, 
         COUNT (a1.order_id) t1
         FROM fact_order a1
		 LEFT JOIN dim_business b1 ON a1.shop_id = b1.shop_id
		 WHERE	a1.order_day_key
            BETWEEN 20170801 AND 20171024
                AND a1.break_type = 0
                AND b1.ka_brand IN ('Ì¨×ÊÎ¶', '½ð°ÙÍò', '½¹¶ú')
                AND a1.is_test = 0
				AND a1.is_delete = 0
        GROUP BY  1,2,3) T 
	GROUP BY 1,2)C
ON  A.ka_brand = C.ka_brand AND A.ÔÂ·Ý = C.months


/*
2017Äê8ÔÂ¡¢9ÔÂÍ¬Ïæ»á¡¢72½Ö¡¢´ó¿¨Ë¾ TOP10 ²ËÆ·¼°Ã¿¸öµêÆÌ¿Íµ¥¼Û¼°»ÝÇ°Óë»ÝºóÁ÷Ë®¼°µ¥Á¿µÈ
*/

SELECT  A.Æ·ÅÆÃû, 
		A.ÉÌ»§ID, 
		A.ÃÅµê, 
		A.»ÝÇ°Á÷Ë®,
		A.»ÝºóÁ÷Ë®,
		A.ÃÅµêµ¥Á¿,
		B1.caipin_name AS '³©Ïú²ËÆ·',
		C.ÃÀÍÅÁ÷Ë®,
		C.ÃÀÍÅµ¥Á¿
FROM
(SELECT b.ka_brand AS 'Æ·ÅÆÃû', 
		concat('#', a.wid) AS 'ÉÌ»§ID',
		b.busi_name AS 'ÃÅµê',
		SUM(IF(a.order_status = 9, a.real_total_price, 0))/1000 AS '»ÝÇ°Á÷Ë®', 
		SUM(IF(a.order_status = 9, a.price, 0))/1000 AS '»ÝºóÁ÷Ë®', 
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS 'ÃÅµêµ¥Á¿'
FROM fact_order a 
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.break_type = 0
	AND a.order_day_key BETWEEN 20170801 AND 20170930
	AND b.is_test = 0
	AND b.is_delete = 0
	AND b.ka_brand IN ('Í¬Ïæ»á', '72½Ö', '´ó¿¨Ë¾')
GROUP BY 1,2,3)A
LEFT JOIN 

(select *
from 
(select *,ROW_NUMBER() OVER(PARTITION BY T1.ÉÌ»§ID ORDER BY T1.ÏúÁ¿ desc) paixu
from 
(
select
	b2.busi_name as 'ÉÌ»§Ãû³Æ',
	concat('#',b2.wid) as 'ÉÌ»§ID',
	d.caipin_name ,
	sum(d.number) as 'ÏúÁ¿'
from 
	dim_business b2 
	left join fact_caipin_details d on b2.shop_id=d.shop_id
where 
	b2.is_test=0 and b2.is_delete=0 
	and d.order_status=9
	and b2.ka_brand IN ('Í¬Ïæ»á', '72½Ö', '´ó¿¨Ë¾')
	and d.order_day_key between 20170801 and 20170930
group by 1,2,3
)T1
)T
where
	T.paixu<=10)B1
ON A.ÃÅµê = B1.ÉÌ»§Ãû³Æ


LEFT JOIN 

(SELECT b1.ka_brand,
		b1.busi_name,
		SUM(IF(c.source = 'meituan', 1, 0)*c.liushui_fee)/1000 AS 'ÃÀÍÅÁ÷Ë®',
		SUM(IF(c.source = 'meituan', 1, 0)) AS 'ÃÀÍÅµ¥Á¿'
FROM dim_business b1 
LEFT JOIN fact_shop_all c ON b1.wid = c.merge_shop_id
WHERE b1.is_delete = 0
	AND b1.is_test = 0
	AND b1.ka_brand IN ('Í¬Ïæ»á', '72½Ö', '´ó¿¨Ë¾')
	AND c.make_date_key IN (20170831, 20170930)
GROUP BY 1,2)C
ON A.ÃÅµê = C.busi_name
ORDER BY 1



/*
ÐèÇó1£º8ÔÂ26ÈÕÖÁ10ÔÂ25ÈÕµ¥Êý¡¢ÓÅ»ÝÇ°Á÷Ë®¡¢ÓªÒµ¶î£¨ÓÅ»ÝÇ°Á÷Ë®+ÕÛ¿ÛÓ¶½ð£©¡¢¿Íµ¥¼Û
ÐèÇó2£º9ÔÂ26ÈÕÖÁ10ÔÂ25ÈÕÓªÒµÊ±³¤
ÐèÇó3£º4ÔÂ26ÈÕÖÁ10ÔÂ25ÈÕ²ËÆ·ÏúÁ¿Êý¾Ý
*/


SELECT  a.order_day_key AS 'ÈÕÆÚ',
		CONCAT('#', b.wid) AS 'ÉÌ»§ID',
		b.busi_name AS 'ÃÅµê',		 
		COUNT(a.order_id) AS 'µ¥Á¿',
		SUM(a.real_total_price)/1000 AS '»ÝÇ°Á÷Ë®',
		SUM(a.real_total_price)/1000 + SUM(a.product_price)/1000-SUM(a.after_discount_price)/1000 AS 'ÓªÒµ¶î', 
		SUM(a.real_total_price/1000)/COUNT(a.order_id) AS '¿Íµ¥¼Û'
FROM fact_order a
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.break_type = 0
	AND a.supplier_id = '14351252732255173199'
	AND a.order_day_key BETWEEN 20170826 AND 20171025
	AND a.order_status = 9
	AND b.is_test = 0
	AND b.is_delete = 0
GROUP BY 1,2,3				--ÐèÇó1


SELECT 	b.busi_name,
		AVG(CAST(c.bd_actual_business_time AS DOUBLE)/60) AS 'ÓªÒµÊ±³¤'
		FROM fact_business c 
		LEFT JOIN dim_business b ON c.shop_id = b.shop_id
		WHERE b.is_delete = 0
		AND b.is_test = 0 
		AND c.status=1
		AND c.shop_day_key BETWEEN 20170926 AND 20171025
		AND b.supplier_id = '14351252732255173199'
GROUP BY 1					--ÐèÇó2


				
SELECT 	b.busi_name AS 'ÃÅµê',
		c.caipin_name AS '²ËÆ·Ãû³Æ',
		SUM(c.number) AS '×ÜÏúÁ¿'
	FROM dim_business b 
	LEFT JOIN fact_caipin_details c ON b.shop_id = c.shop_id
	WHERE b.is_delete = 0
		AND b.is_test = 0
		AND c.order_day_key BETWEEN 20170426 AND 20171025
		AND b.supplier_id = '14351252732255173199'
		AND c.order_status = 9
GROUP BY 1,2
ORDER BY ×ÜÏúÁ¿ DESC				--ÐèÇó3
		

/*
¹©Ó¦ÉÌID£º7459241998001922427£¬·³ÇëÐ­Öúµ¼³ö10ÔÂ1ºÅ-10ÔÂ22ºÅµÄÊý¾Ý
*/

-- ÉÌ»§Á÷Á¿+ÐÇ¼¶ÆÀ¼¶·ÖÎö 
SELECT t1..order_day_key AS 'ÈÕÆÚ'
    , CONCAT('#',t1.waimai_release_id) AS 'ÉÌ»§ID'
    , t1.busi_name AS 'ÉÌ»§Ãû³Æ'
    , t1.sale_name AS 'ÏúÊÛÐÕÃû'
    , t1.xiadan AS 'ÏÂµ¥Á¿'
    , t1.wandan AS 'Íê³Éµ¥'
    , t1.qianliushui AS 'ÓÅ»ÝÇ°Á÷Ë®'
    , t1.houliushui AS 'ÓÅ»ÝºóÁ÷Ë®'
    , t1.kedanjia AS '¿Íµ¥¼Û'
    , t1.new_user AS 'ÐÂÓÃ»§Êý'
    , t1.user_count AS '½»Ò×ÓÃ»§Êý'
    , t1.one_star_count AS 'ÆÀ¼Û1ÐÇ'
    , t1.two_star_count AS 'ÆÀ¼Û2ÐÇ'
    , t1.three_star_count AS 'ÆÀ¼Û3ÐÇ'
    , t1.four_star_count AS 'ÆÀ¼Û4ÐÇ'
    , t1.fivr_star_count AS 'ÆÀ¼Û5ÐÇ'
    , t1.content_order_num AS 'ÆÀÂÛ¶©µ¥Êý'
    , t1.non_abnormal_rate AS '·ÇÒìÂÊ'
    , t1.½Óµ¥ÂÊ

    , t3.·ÃÎÊpv 
    , t3.·ÃÎÊuv
    , t3.ÆØ¹âpv
    , t3.ÆØ¹âuv
    , t3.Æ½¾ùrank

FROM 

(SELECT b.waimai_release_id 
    , b.busi_name 
    , c.sale_name 
    , a.order_day_key
    , COUNT(a.order_id) AS xiadan
    , COUNT( CASE WHEN a.order_status = 9 THEN a.order_id END) AS wandan 
    , SUM( CASE WHEN a.order_status = 9 THEN a.real_total_price END)/1000 AS qianliushui 
    , SUM( CASE WHEN a.order_status = 9 THEN a.price ELSE 0 END)/1000 AS houliushui
    , SUM( CASE WHEN a.order_status = 9 THEN a.real_total_price END)/COUNT( CASE WHEN a.order_status = 9 THEN a.order_id END)/1000 AS kedanjia
    , COUNT(CASE WHEN a.order_status = 9 AND a.anticheat_new_user_flag = 1 THEN a.pass_uid ELSE null END) AS new_user 
    , COUNT( DISTINCT CASE WHEN a.order_status = 9 THEN a.pass_uid END) AS user_count 
    , SUM( IF(d.score = 1,1,0)) AS one_star_count
    , SUM( IF(d.score = 2,1,0)) AS two_star_count
    , SUM( IF(d.score = 3,1,0)) AS three_star_count
    , SUM( IF(d.score = 4,1,0)) AS four_star_count
    , SUM( IF(d.score = 5,1,0)) AS fivr_star_count
    , COUNT( CASE WHEN d.content is not null AND a.order_status = 9 THEN a.order_id ELSE null END) AS content_order_num
    , COUNT( CASE WHEN a.cancel_reason_status IN (1,2,3,4,6,7,9,10,11,12,13,14,15,16,18,19,20,21,21,23,102,103,104,110) AND a.order_status = 10 THEN a.order_id ELSE null END)
     /COUNT(a.order_id) AS non_abnormal_rate -- '·ÇÒìÂÊ'
    , COUNT(if(a.jiedan_type<>3,a.order_id,null))/COUNT(a.order_id) AS '½Óµ¥ÂÊ'

FROM dim_business AS b 
LEFT JOIN fact_order AS a ON a.shop_id = b.shop_id 
LEFT JOIN dim_order_sale_id AS c ON b.sales_id = c.sale_id 
LEFT JOIN comment_content_new AS d ON a.order_id = d.order_id 
WHERE a.order_day_key BETWEEN 20171001 AND 20171022         -- ÐÞ¸ÄÊ±¼ä 
    AND from_unixtime(d.create_time+8*3600,'yyyyMMdd') >= '20171001'        -- Ê±¼ä´óÓÚÄãÒª²éÑ¯µÄ×îÐ¡Ê±¼ä
    AND a.is_test = 0 
    AND a.break_type = 0 
    AND b.is_delete = 0 
    AND b.sys_status IN (0,6,13,14,15) 
    AND b.waimai_release_id IN          -- ÐÞ¸ÄÉÌ»§id 
    (
        
)
GROUP BY 1,2,3,4 ) AS t1 


LEFT JOIN 

(SELECT b.waimai_release_id 
    , a.shop_day_key
    , SUM(f.shop_pv) AS '·ÃÎÊpv'
    , SUM(f.shop_uv) AS '·ÃÎÊuv'
    , SUM(f.shop_baoguang_pv) AS 'ÆØ¹âpv'
    , SUM(f.shop_baoguang_uv) AS 'ÆØ¹âuv'
    , AVG(d.shop_avgrank) AS 'Æ½¾ùrank'

FROM dim_business AS b
LEFT JOIN fact_business AS f ON b.shop_id = f.shop_id
WHERE f.shop_day_key BETWEEN 20171001 AND 20171022        -- ÐÞ¸ÄÊ±¼ä
    AND f.waimai_release_id IN              -- ÐÞ¸ÄÉÌ»§id 
    (
) 
GROUP BY 1,2) AS t3
ON t1.waimai_release_id = t3.waimai_release_id AND t1.order_day_key = t3.shop_day_key 



-- µµÎ» 
select 
b.supplier_id,
(case when a.real_total_price<20000 then '¿Íµ¥¼Û[0,20)'
    when a.real_total_price<30000 and a.real_total_price>=20000 then '¿Íµ¥¼Û[20,30)'
    when a.real_total_price<40000 and a.real_total_price>=30000 then '¿Íµ¥¼Û[30,40)'
    when a.real_total_price<50000 and a.real_total_price>=40000 then '¿Íµ¥¼Û[40,50)'
    when a.real_total_price<60000 and a.real_total_price>=50000 then '¿Íµ¥¼Û[50,60)'
    when a.real_total_price<70000 and a.real_total_price>=60000 then '¿Íµ¥¼Û[60,70)'
    when a.real_total_price<80000 and a.real_total_price>=70000 then '¿Íµ¥¼Û[70,80)'
    when a.real_total_price<90000 and a.real_total_price>=80000 then '¿Íµ¥¼Û[80,90)'
    when a.real_total_price<100000 and a.real_total_price>=90000 then '¿Íµ¥¼Û[90,100)'
    when a.real_total_price<120000 and a.real_total_price>=100000 then '¿Íµ¥¼Û[100,120)'
    when a.real_total_price<140000 and a.real_total_price>=120000 then '¿Íµ¥¼Û[120,140)'
    when a.real_total_price<160000 and a.real_total_price>=140000 then '¿Íµ¥¼Û[140,160)'
    when a.real_total_price>=1600000 then '¿Íµ¥¼Û[160,¡Þ)' 
      else '0' end) as '¿Íµ¥¼ÛÇø¼ä',				--¿Íµ¥¼Û·Ö²¼
count(a.order_id) as 'ÓÅ»ÝÇ°¶©µ¥Êý'

from fact_order a
left join dim_business b on a.shop_id = b.shop_id

where 
a.break_type=0
and a.order_status=9
and a.order_day_key between 20171001 AND 20171022        -- ÐÞ¸ÄÊ±¼ä
and b.supplier_id in()        -- ÐÞ¸Ä¹©Ó¦ÉÌid
group by 1,2



--  ÈÈÏú²ËÆ·  ÔÂ	 Æ·ÅÆÃû³Æ	²ËÆ·Ãû³Æ	²ËÆ·ÏúÁ¿	²ËÆ·ÏúÊÛ¶î	

select concat('#',b.supplier_id) as '¹©Ó¦ÉÌID'
    , b.ka_brand as 'Æ·ÅÆ'
    , a.caipin_id as '²ËÆ·id'
    , a.caipin_name as '²ËÆ·Ãû³Æ'
    , a.current_price as '²ËÆ·Ô­¼Û'
    , sum(a.number) as 'ÏúÊÛÊýÁ¿'
from fact_caipin_details as a
join dim_business as b on a.shop_id=b.shop_id
where a.order_day_key between 20171001 AND 20171022   -- ÐÞ¸ÄÊ±¼ä
and b.is_test=0
and b.supplier_id IN ('7459241998001922427')  -- ÐÞ¸Ä¹©Ó¦ÉÌid
group by 1,2,3,4,5
order by ÏúÊÛÊýÁ¿ desc 


/*
»î¶¯ÏúÁ¿
*/
SELECT t1.ÈÕÆÚ,
		t1.ÉÌ»§ID,
		t1.ÉÌ»§,
		t2.»î¶¯ÏúÁ¿,
		t1.×Ü¹²Íê³É¶©µ¥Á¿
FROM 
(SELECT a.shop_id,
		a.order_day_key AS 'ÈÕÆÚ',
		CONCAT('#', b.wid) AS 'ÉÌ»§ID', 
		b.busi_name AS 'ÉÌ»§'
		COUNT(a.order_id) AS '×Ü¹²Íê³É¶©µ¥Á¿'
	FROM fact_order a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.break_type = 0
		AND a.order_day_key BETWEEN 20171022 AND 20171026			--ÐÞ¸ÄÈÕÆÚ	
		AND a.order_status = 9
		AND b.is_delete = 0
		AND b.is_test = 0
GROUP BY 1,2,3,4) t1
JOIN 
(SELECT c.shop_id,
		c.index_day,
		COUNT(DISTINCT c.order_id) AS '»î¶¯ÏúÁ¿'
FROM fact_yingxiao_info c
LEFT JOIN dim_business b1 ON c.shop_id = b1.shop_id
WHERE c.order_status = 9
	AND c.index_day BETWEEN 20171022 AND 20171026					--ÐÞ¸ÄÈÕÆÚ			
	AND c.activity_id = 'cp341054'									--ÐÞ¸Ä»î¶¯ID£¬cpÎªÐ¡Ð´
	AND b1.city_real = 'ÉÏº£'										--ÐÞ¸Ä³ÇÊÐ
	AND b1.is_delete = 0
	AND b1.is_test = 0
GROUP BY 1,2) t2 ON t1.shop_id = t2.shop_id AND t1.ÈÕÆÚ = t2.index_day
		



/*
10.30ËÎË§Ë§
*/

--ÐèÇó1£º9ÔÂ¡¢10ÔÂ×ÜÊý¾Ý

SELECT A.*, 
		B.¸´¹ºÂÊ, 
		C.·ÃÎÊuv,
		C.·ÃÎÊpv,
		C.ÆØ¹âuv,
		C.ÆØ¹âpv,
		A.Íê³Éµ¥Á¿/C.·ÃÎÊuv AS 'Íê³Éµ¥×ª»¯ÂÊ'
FROM
(SELECT CONCAT('#',a.supplier_id) AS '¹©Ó¦ÉÌID',
		FLOOR(a.order_day_key/100) AS 'ÔÂ·Ý', 
		COUNT(a.order_id) AS 'ÏÂµ¥Á¿',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS 'Íê³Éµ¥Á¿',
		SUM(IF(a.order_status = 9, a.real_total_price, 0))/1000 AS 'Á÷Ë®ÓÅ»ÝÇ°',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '¿Íµ¥¼Û',
		SUM(case when a.shop_butie>0 AND a.order_status = 9 then a.shop_butie/1000 else 0 end)
			+ SUM(case when shop_quan_price>0 AND a.order_status = 9 then a.shop_quan_price/1000 else 0 end) AS 'ÉÌ»§²¹Ìù',
		SUM(case when a.discount_baidufee_price>0  AND a.order_status = 9 then a.discount_baidufee_price/1000  else 0 end) 
			+ SUM(case when a.quan_price>0  AND a.order_status = 9 then a.quan_price/1000 else 0 end) AS '°Ù¶È²¹Ìù', 
		COUNT(DISTINCT a.pass_uid) AS '½»Ò×ÓÃ»§Êý',
		COUNT(IF(a.complaint_status!=0,1,NULL)) AS 'Í¶Ëßµ¥',
		COUNT(CASE WHEN a.cancel_reason_status IN(7,3,1,2,4,9,10,11,12,19,13,14,15,16,18,20,21,22,23,102,103,110,6) AND a.order_status=10 THEN a.order_id ELSE NULL END)/COUNT(a.order_id) AS '·ÇÒìÂÊ'
FROM fact_order a
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.break_type = 0
	AND a.supplier_id = '1428693873'
	AND a.order_day_key BETWEEN 20170901 AND 20171026
	AND b.is_test = 0
	AND b.is_delete = 0
GROUP BY 1,2)A
JOIN
(SELECT  CONCAT('#',T.supplier_id) AS id,
		 FLOOR(T.order_day_key/100) AS months,
		 SUM(if(t1>=2, 1, 0))/COUNT (T.pass_uid) AS '¸´¹ºÂÊ'
    FROM 
        (SELECT a1.pass_uid, a1.supplier_id, a1.order_day_key,  
         COUNT (a1.order_id) t1
         FROM fact_order a1
		 WHERE	a1.order_day_key
            BETWEEN 20170901 AND 20171026
                AND a1.break_type=0
                AND a1.supplier_id = '1428693873'
                AND a1.is_test=0
        GROUP BY  1,2,3) T GROUP BY 1,2) B
ON  A.¹©Ó¦ÉÌID = B.id AND A.ÔÂ·Ý = B.months
JOIN
(SELECT CONCAT('#',c.supplier_id ) AS gongyingshangid,
		FLOOR(c.shop_day_key/100) AS yuefen,
		SUM(c.shop_uv) AS '·ÃÎÊuv',
		SUM(c.shop_pv) AS '·ÃÎÊpv',
		SUM(c.shop_baoguang_uv) AS 'ÆØ¹âuv',
		SUM(c.shop_baoguang_pv) AS 'ÆØ¹âpv'
FROM fact_business c
WHERE c.supplier_id = '1428693873'
	AND c.shop_day_key BETWEEN 20170901 AND 20171026
	AND c.status = 1
GROUP BY 1,2)C
ON A.¹©Ó¦ÉÌID = C.gongyingshangid AND A.ÔÂ·Ý = C.yuefen


--ÐèÇó2£º9ÔÂ¡¢10ÔÂÃ¿ÈÕÊý¾Ý

SELECT A.*,
		C.·ÃÎÊuv,
		C.·ÃÎÊpv,
		C.ÆØ¹âuv,
		C.ÆØ¹âpv,
		A.Íê³Éµ¥Á¿/C.·ÃÎÊuv AS 'Íê³Éµ¥×ª»¯ÂÊ'
FROM
(SELECT CONCAT('#',a.supplier_id) AS '¹©Ó¦ÉÌID',
		a.order_day_key 'ÈÕÆÚ', 
		COUNT(a.order_id) AS 'ÏÂµ¥Á¿',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS 'Íê³Éµ¥Á¿',
		SUM(IF(a.order_status = 9, a.real_total_price, 0))/1000 AS 'Á÷Ë®ÓÅ»ÝÇ°',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '¿Íµ¥¼Û',
		SUM(case when a.shop_butie>0 AND a.order_status = 9 then a.shop_butie/1000 else 0 end)
			+ SUM(case when shop_quan_price>0 AND a.order_status = 9 then a.shop_quan_price/1000 else 0 end) AS 'ÉÌ»§²¹Ìù',
		SUM(case when a.discount_baidufee_price>0  AND a.order_status = 9 then a.discount_baidufee_price/1000  else 0 end) 
			+ SUM(case when a.quan_price>0  AND a.order_status = 9 then a.quan_price/1000 else 0 end) AS '°Ù¶È²¹Ìù', 
		COUNT(DISTINCT a.pass_uid) AS '½»Ò×ÓÃ»§Êý',
		COUNT(IF(a.complaint_status!=0,1,NULL)) AS 'Í¶Ëßµ¥',
		COUNT(CASE WHEN a.cancel_reason_status IN(7,3,1,2,4,9,10,11,12,19,13,14,15,16,18,20,21,22,23,102,103,110,6) AND a.order_status=10 THEN a.order_id ELSE NULL END)/COUNT(a.order_id) AS '·ÇÒìÂÊ'
FROM fact_order a
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.break_type = 0
	AND a.supplier_id = '1428693873'
	AND a.order_day_key BETWEEN 20170901 AND 20171026
	AND b.is_test = 0
	AND b.is_delete = 0
GROUP BY 1,2)A
JOIN
(SELECT CONCAT('#',b1.supplier_id ) AS gongyingshangid,
		c.shop_day_key AS riqi,
		SUM(c.shop_uv) AS '·ÃÎÊuv',
		SUM(c.shop_pv) AS '·ÃÎÊpv',
		SUM(c.shop_baoguang_uv) AS 'ÆØ¹âuv',
		SUM(c.shop_baoguang_pv) AS 'ÆØ¹âpv'
FROM fact_business c
LEFT JOIN dim_business b1 ON b1.shop_id = c.shop_id
WHERE b1.supplier_id = '1428693873'
	AND c.shop_day_key BETWEEN 20170901 AND 20171026
	AND c.status = 1
GROUP BY 1,2)C
ON A.¹©Ó¦ÉÌID = C.gongyingshangid AND A.ÈÕÆÚ = C.riqi


--ÐèÇó3£º9ÔÂ¡¢10ÔÂ·ÖÃÅµêÊý¾Ý

SELECT A.*,
		B.¸´¹ºÂÊ,
		A.Íê³Éµ¥Á¿/C.·ÃÎÊuv AS 'Íê³Éµ¥×ª»¯ÂÊ'
FROM
(SELECT CONCAT('#',a.wid) AS 'ÉÌ»§ID',
		FLOOR(a.order_day_key/100) AS 'ÔÂ·Ý',
		b.busi_name AS 'ÉÌ»§Ãû³Æ',
		COUNT(a.order_id) AS 'ÏÂµ¥Á¿',
		COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS 'Íê³Éµ¥Á¿',
		SUM(IF(a.order_status = 9, a.real_total_price, 0))/1000 AS 'Á÷Ë®ÓÅ»ÝÇ°',
		SUM(IF(a.order_status = 9, a.real_total_price/1000, 0))/COUNT(IF(a.order_status = 9, a.order_id, NULL)) AS '¿Íµ¥¼Û',
		SUM(case when a.shop_butie>0 AND a.order_status = 9 then a.shop_butie/1000 else 0 end)
			+ SUM(case when shop_quan_price>0 AND a.order_status = 9 then a.shop_quan_price/1000 else 0 end) AS 'ÉÌ»§²¹Ìù',
		SUM(case when a.discount_baidufee_price>0  AND a.order_status = 9 then a.discount_baidufee_price/1000  else 0 end) 
			+ SUM(case when a.quan_price>0  AND a.order_status = 9 then a.quan_price/1000 else 0 end) AS '°Ù¶È²¹Ìù', 
		COUNT(DISTINCT a.pass_uid) AS '½»Ò×ÓÃ»§Êý',
		COUNT(IF(a.complaint_status!=0,1,NULL)) AS 'Í¶Ëßµ¥',
		COUNT(CASE WHEN a.cancel_reason_status IN(7,3,1,2,4,9,10,11,12,19,13,14,15,16,18,20,21,22,23,102,103,110,6) AND a.order_status=10 THEN a.order_id ELSE NULL END)/COUNT(a.order_id) AS '·ÇÒìÂÊ'
FROM fact_order a
LEFT JOIN dim_business b ON a.shop_id = b.shop_id
WHERE a.break_type = 0
	AND a.supplier_id = '1428693873'
	AND a.order_day_key BETWEEN 20170901 AND 20171026
	AND b.is_test = 0
	AND b.is_delete = 0
GROUP BY 1,2,3)A
JOIN
(SELECT  CONCAT('#',T.wid) AS id,
		 FLOOR(T.order_day_key/100) AS months,
		 SUM(if(t1>=2, 1, 0))/COUNT (T.pass_uid) AS '¸´¹ºÂÊ'
    FROM 
        (SELECT a1.pass_uid, a1.wid, a1.order_day_key,  
         COUNT (a1.order_id) t1
         FROM fact_order a1
		 WHERE	a1.order_day_key
            BETWEEN 20170901 AND 20171026
                AND a1.break_type=0
                AND a1.supplier_id = '1428693873'
                AND a1.is_test=0
        GROUP BY  1,2,3) T GROUP BY 1,2) B
ON  A.ÉÌ»§ID = B.id AND A.ÔÂ·Ý = B.months
JOIN
(SELECT CONCAT('#',c.waimai_release_id ) AS shanghuid,
		FLOOR(c.shop_day_key/100) AS yuefen,
		SUM(c.shop_uv) AS '·ÃÎÊuv'
FROM fact_business c
WHERE c.supplier_id = '1428693873'
	AND c.shop_day_key BETWEEN 20170901 AND 20171026
	AND c.status = 1
GROUP BY 1,2)C
ON A.ÉÌ»§ID = C.shanghuid AND A.ÔÂ·Ý = C.yuefen

/*
NKAÆ·ÅÆ²îÆÀÊý¾Ý-ÕÅÑÇ¾ê1030
*/
select
d.sale_name ÏúÊÛÈËÔ±,
b.ka_brand Æ·ÅÆ,
a.order_day_key ÈÕÆÚ,
b.city_real ³ÇÊÐ,
concat('#',b.supplier_id) ¹©Ó¦ÉÌid,
c.name ¹©Ó¦ÉÌ,
concat('#',b.wid) ÉÌ»§id,
b.busi_name ÉÌ»§Ãû³Æ,
b.aoi ÉÌÈ¦,
a.order_id ¶©µ¥id,
a.pass_uid ÓÃ»§id,
a.delivery_party ÅäËÍ·½,
a.order_time ÏÂµ¥Ê±¼ä,
a.score ÆÀ·Ö,
e.content ÆÀÂÛ,
sum(a.real_total_price/1000) ¸Ãµ¥¼Û¸ñÓÅ»ÝÇ°
from 
fact_order a
left join dim_business b on a.shop_id=b.shop_id
left join dim_supplier c on b.supplier_id=c.supplier_id
left join dim_order_sale_id d on b.sales_id=d.sale_id
left join comment_content_new e on e.order_id=a.order_id 
where 
b.ka_extend_lable_id in (1,2,8)
and a.order_day_key between 20171016 and 20171029 --ÐÞ¸ÄÈÕÆÚ
and a.score<=3
and a.break_type=0  
and a.order_status=9
and b.is_delete=0
and b.is_test=0
and e.is_empty=0
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15


/*
±±¾©¸÷ÉÌÈ¦10ÔÂ·ÝLKA¡¢NKA¡¢·ÇKAÉÌ»§Êý¼°¶ÔÓ¦Á÷Ë®
/*


SELECT A.*,B.»ÝÇ°Á÷Ë® FROM
(SELECT b.aoi AS 'ÉÌÈ¦',
		(CASE WHEN b.ka_extend_lable_id = 1 THEN 'NKA'
			  WHEN b.ka_extend_lable_id IN (9,11) THEN 'LKA'
			  WHEN b.ka_extend_lable_id IN (-1, 0, 6) THEN '·ÇKA'
			  END) AS '±êÇ©',
		COUNT(DISTINCT IF(a.sys_status IN (0,6,13,14,15), a.waimai_release_id, NULL)) AS '10.29ÔÚÏßºÏ×÷ÉÌ»§Êý'
	FROM fact_business a
	LEFT JOIN dim_business b ON a.shop_id = b.shop_id
	WHERE a.shop_day_key = 20171029
		AND b.is_test = 0
		AND b.is_delete = 0
		AND a.status = 1
		AND b.city_real = '±±¾©'
GROUP BY 1,2)A
JOIN 
(SELECT b1.aoi AS shangquan,
		(CASE WHEN b1.ka_extend_lable_id = 1 THEN 'NKA'
			  WHEN b1.ka_extend_lable_id IN (9,11) THEN 'LKA'
			  WHEN b1.ka_extend_lable_id IN (-1, 0, 6) THEN '·ÇKA'
			  END) AS biaoqian,
		SUM(a1.real_total_price/1000) AS '10ÔÂ»ÝÇ°Á÷Ë®'
	FROM fact_order a1
	LEFT JOIN dim_business b1 ON a1.shop_id = b1.shop_id
	WHERE a1.break_type = 0
		AND a1.order_status = 9
		AND b1.is_delete = 0
		AND b1.is_test = 0
		AND b1.city_real = '±±¾©'
		AND a1.order_day_key BETWEEN 20171001 AND 20171029	
GROUP BY 1,2)B ON A.ÉÌÈ¦ = B.shangquan AND A.±êÇ© = B.biaoqian






select * from
(select 
concat('#',b.wid) AS 'ÉÌ»§id',
  b.busi_name AS 'ÉÌ»§Ãû³Æ',
  b.aoi AS 'ÉÌÈ¦',
  split_part(b.area,'£¨',1) AS 'ÐÇÏµ',
  c.city_region as '´óÇø',
(case when b.ka_extend_lable_id  in(1,2,8) then 'NKA'
  when b.ka_extend_lable_id in (9,11)   then 'LKA'
  when b.ka_extend_lable_id in (-1,0,6) then  '·ÇKA'
  else 'others' end) as 'KA±êÇ©',
count(if(a.order_status=9,a.order_id,null))as 'Íê³É¶©µ¥Êý',
sum(if(a.order_status=9,a.real_total_price,0))/1000 as'ÓÅ»ÝÇ°Á÷Ë®',
 (sum(case when a.discount_baidufee_price>0 and a.order_status = 9 then a.discount_baidufee_price/1000 else 0 end)
  + sum(case when a.quan_price>0  and a.order_status = 9 then a.quan_price/1000 else 0 end)) as '°Ù¶È²¹Ìù',
  (sum(case when a.shop_butie>0 and a.order_status=9 then a.shop_butie/1000 else 0 end)+
 sum(case when a.shop_quan_price>0 and a.order_status=9 then a.shop_quan_price/1000 else 0 end)) as 'ÉÌ»§²¹Ìù',
 sum(if(a.order_status=9,a.te_butie_baidu,0))/1000 as 'ÌØ¼Û²Ë°Ù¶È²¹Ìù',
 sum(if(a.order_status=9,a.jian_baidu_fee,0))/1000 as 'Âú¼õ°Ù¶È²¹Ìù',
  sum(if(a.order_status=9,a.quan_price,0))/1000 as '´ú½ðÈ¯°Ù¶È²¹Ìù',
sum(if(a.order_status=9,a.distribution_card_subsidy,0))/1000 as 'ÎåÕÛ¿¨°Ù¶È²¹Ìù',
sum(if(a.order_status=9,a.zhe_butie_baidu,0))/1000 as 'ÕÛ¿Û°Ù¶È²¹Ìù'
from dim_business b
left join fact_order a  on b.shop_id=a.shop_id
left join dim_aoi c on c.aoi_id=b.aoi_id
where b.is_test=0 
	and b.is_delete = 0
	and b.status=1   
 and b.city_real='±±¾©'
  and a.order_day_key between 20171001 and 20171029
group by 1,2,3,4,5,6)A

left join
(select concat('#',b1.shop_id) AS shanghuid,
		sum(if(b1.order_status = 9 and b1.type = 'logistic' and b1.baidu_rate = 1, b1.baidu_rate,0) as '°Ù¶È×¨ËÍ1Ôª°Ù¶È²¹Ìù',
		sum(if(b1.order_status = 9 and b1.type = 'logistic' and b1.baidu_rate = 2, b1.baidu_rate,0) as '°Ù¶È×¨ËÍ2Ôª°Ù¶È²¹Ìù',
		sum(if(b1.order_status = 9 and b1.type = 'logistic' and b1.baidu_rate = 3, b1.baidu_rate,0) as '°Ù¶È×¨ËÍ3Ôª°Ù¶È²¹Ìù',
		sum(if(b1.order_status = 9 and b1.type = 'logistic' and b1.baidu_rate not in (1,2,3), b1.baidu_rate,0) as '°Ù¶È×¨ËÍÆäËû½ð¶î°Ù¶È²¹Ìù'
fact_yingxiao_info b1
left join dim_business b2
		where b1.index_day between 20171001 and 20171029
			and b2.city_real = '±±¾©'
			and b2.is_delete = 0
			and b2.is_test = 0
			and b2.status = 1
group by 1)B on A.ÉÌ»§id = B.shanghuid


